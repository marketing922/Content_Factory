{
  "nodes": [
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Parse Translate Request').item.json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "translation_status",
              "fieldValue": "translating"
            }
          ]
        }
      },
      "id": "81087e98-cd5a-4723-93c4-03786bbadb61",
      "name": "Set Translating Status",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        37456,
        93024
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst translateRequest = $('Parse Translate Request').first().json;\n\nconsole.log('PrÃ©paration traduction:');\nconsole.log('- Article ID:', article.id);\nconsole.log('- Langue cible:', translateRequest.target_language);\n\nreturn [{\n  json: {\n    id: article.id,\n    topic: article.topic,\n    content: article.content,\n    table_of_contents: article.table_of_contents,\n    plan_options: article.plan_options,\n    search_synthesis: article.search_synthesis,\n    evaluation_details: article.evaluation_details,\n    parameters: article.parameters || {},\n    target_language: translateRequest.target_language,\n    article_id: translateRequest.article_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37968,
        93024
      ],
      "id": "81a7cc67-06ba-4997-83ad-26e2875e76db",
      "name": "Preparer Traduction"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        38448,
        93360
      ],
      "id": "b6ef0be5-c931-43f5-a742-8be38822c2d7",
      "name": "Simple Memory7"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        37920,
        92048
      ],
      "id": "3ac3848e-e2eb-4e6b-9ac7-9b71738d3e50",
      "name": "Simple Memory6"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        38160,
        91392
      ],
      "id": "17c461a9-68ce-4b3b-b88c-6dea1016cac9",
      "name": "Simple Memory5"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'processing', message: 'Translation started' } }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "ea0e8690-9698-4884-8ab5-3034a31adfdb",
      "name": "Response Translate",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        37632,
        92736
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Parse Translate Request').item.json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "topic",
              "fieldValue": "={{ $json.translated_topic }}"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.translated_content }}"
            },
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.translated_toc }}"
            },
            {
              "fieldId": "plan_options",
              "fieldValue": "={{ $json.translated_plan_options }}"
            },
            {
              "fieldId": "search_synthesis",
              "fieldValue": "={{ $json.translated_search_synthesis }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ $json.translated_evaluation_details }}"
            },
            {
              "fieldId": "score",
              "fieldValue": "={{ $('Read Article Translate').item.json.score }}"
            },
            {
              "fieldId": "drive_link",
              "fieldValue": "={{ $('Read Article Translate').item.json.drive_link }}"
            },
            {
              "fieldId": "translation_status",
              "fieldValue": "completed"
            },
            {
              "fieldId": "parameters",
              "fieldValue": "={{ { ...$('Read Article Translate').item.json.parameters, language: $json.new_language } }}"
            }
          ]
        }
      },
      "id": "ad91cd6b-83f4-4a0c-a6b4-46bd3f070cde",
      "name": "Update Translated Article",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        38832,
        93024
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst oldData = $('Read Article Translate').first().json;\nconst requestData = $('Parse Translate Request').first().json;\n\nlet translatedData;\nlet output = input.output || \"\";\n\ntry {\n  // Extraction RAPIDE : on Ã©vite les regex sur tout le contenu\n  let cleanJson = output.trim();\n  \n  // Nettoyage des blocs de code markdown si prÃ©sents\n  if (cleanJson.startsWith('```')) {\n    cleanJson = cleanJson.replace(/^```(?:json)?\\n?/, '').replace(/\\n?```$/, '').trim();\n  }\n  \n  // Extraction sÃ©curisÃ©e entre la premiÃ¨re { et la derniÃ¨re }\n  const startIdx = cleanJson.indexOf('{');\n  const endIdx = cleanJson.lastIndexOf('}');\n  \n  if (startIdx !== -1 && endIdx !== -1) {\n    cleanJson = cleanJson.substring(startIdx, endIdx + 1);\n  }\n  \n  translatedData = JSON.parse(cleanJson);\n} catch (e) {\n  console.error(\"Parse Error:\", e);\n  translatedData = {};\n}\n\nreturn [{\n  json: {\n    article_id: requestData.article_id,\n    new_language: requestData.target_language,\n    translated_topic: translatedData.translated_topic || oldData.topic,\n    translated_content: translatedData.translated_content || oldData.content,\n    translated_toc: translatedData.translated_toc || oldData.table_of_contents,\n    translated_plan_options: translatedData.translated_plan_options || oldData.plan_options,\n    translated_search_synthesis: translatedData.translated_search_synthesis || oldData.search_synthesis,\n    translated_evaluation_details: translatedData.translated_evaluation_details || oldData.evaluation_details\n  }\n}];"
      },
      "id": "2481c9ae-fc75-4543-8187-ef1dce89c1de",
      "name": "Parse Translated Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38608,
        93024
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        38224,
        93360
      ],
      "id": "0169029e-519d-4ab8-89d0-d2897b434634",
      "name": "Gemini Translate",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un traducteur expert certifiÃ©.\n\n## MISSION\nTradius l'INTÃ‰GRALITÃ‰ des donnÃ©es de l'article en {{ $('Parse Translate Request').item.json.target_language === 'fr' ? 'FranÃ§ais' : $('Parse Translate Request').item.json.target_language === 'en' ? 'Anglais' : 'Chinois' }}.\n\n## RÃˆGLES CRITIQUES\n1. Conserve STRICTEMENT tout le formatage Markdown/HTML.\n2. Pour le plan (TOC), traduis uniquement les titres tout en conservant les IDs et la structure JSON.\n3. Pour les options de plan (plan_options), tu dois renvoyer un objet JSON avec les clÃ©s \"titles\" et \"axes\". Traduis le CONTENU des tableaux, mais GARDE les clÃ©s \"titles\" et \"axes\" en anglais.\n4. Pour l'Ã©valuation (evaluation_details), traduis les noms des critÃ¨res, les explications et le feedback global.\n5. Ne traduis pas les balises HTML, les syntaxes Markdown, ou les IDs JSON.\n\n## Ã‰LÃ‰MENTS Ã€ TRADUIRE\n### 1. SUJET (TOPIC) :\n{{ $('Read Article Translate').item.json.topic }}\n\n### 2. PLAN ACTUEL (TOC) :\n{{ JSON.stringify($('Read Article Translate').item.json.table_of_contents) }}\n\n### 3. OPTIONS DE PLAN (TITRES & AXES) :\n{{ JSON.stringify($('Read Article Translate').item.json.plan_options) }}\n\n### 4. SYNTHÃˆSE DE RECHERCHE :\n{{ JSON.stringify($('Read Article Translate').item.json.search_synthesis) }}\n\n### 5. DÃ‰TAILS D'Ã‰VALUATION (SCORES & CONSEILS) :\n{{ JSON.stringify($('Read Article Translate').item.json.evaluation_details) }}\n\n### 6. CONTENU DE L'ARTICLE :\n{{ $('Read Article Translate').item.json.content }}\n\n## FORMAT DE RÃ‰PONSE ATTENDU (JSON STRICT)\nTu DOIS rÃ©pondre avec un objet JSON unique contenant EXACTEMENT ces clÃ©s :\n{\n  \"translated_topic\": \"...\",\n  \"translated_toc\": { ... },\n  \"translated_plan_options\": { \"titles\": [\"...\"], \"axes\": [\"...\"] },\n  \"translated_search_synthesis\": { ... },\n  \"translated_evaluation_details\": { ... },\n  \"translated_content\": \"...\"\n}\n",
        "options": {
          "systemMessage": "Tu es un traducteur technique qui rÃ©pond exclusivement au format JSON pour Ãªtre parsÃ© par un programme."
        }
      },
      "id": "20616321-01b2-4399-9e8c-a155b7553322",
      "name": "AI Translator",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        38256,
        93024
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.id }}"
            }
          ]
        }
      },
      "id": "aea00248-3ffb-40f5-b8cc-db853707c5fa",
      "name": "Read Article Translate",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        37680,
        93024
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst body = input.body || input;\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    target_language: body.target_language,\n    current_status: body.current_status || 'published', // Fallback to published if missing\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "3e097dc0-8800-49ff-9237-079ab2ba4662",
      "name": "Parse Translate Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37232,
        93024
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/translate",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "db5ecba9-9dd1-453d-99cd-0532fbcf612d",
      "name": "Webhook Translate",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        36768,
        93024
      ],
      "webhookId": "translate"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'completed', article_id: $json.id, message: 'Article modifiÃ© avec succÃ¨s' } }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "58c8d8c0-2f79-4aa2-a296-2a66ac23187c",
      "name": "Response Modify Article",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        38864,
        91824
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.new_content }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "completed"
            }
          ]
        }
      },
      "id": "c18ccc63-9fd0-45e8-9e22-f35bd82aabe1",
      "name": "Update Modified Content",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        38640,
        91824
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst newContent = input.output || JSON.stringify(input);\n\nreturn [{\n  json: {\n    article_id: $('Parse Modify Article').first().json.article_id,\n    new_content: newContent\n  }\n}];"
      },
      "id": "6c8cf817-f604-4faa-9b21-3407b8fb12c2",
      "name": "Parse New Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38416,
        91824
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        37776,
        92048
      ],
      "id": "eb4faf5c-f49c-43f4-9db5-89c01a14d0c0",
      "name": "Gemini Modify Article",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un rÃ©dacteur expert.\n\n## MISSION\nRÃ©Ã©cris des parties de l'article suivant selon les instructions.\n\n## INSTRUCTIONS\n{{ $('Parse Modify Article').item.json.instructions }}\n\n## SELECTION DES SECTIONS Ã€ RÃ‰Ã‰CRIRE\n{{ JSON.stringify($('Parse Modify Article').item.json.selection) }}\n\n## ARTICLE ACTUEL\n{{ $json.content }}\n\n## FORMAT ATTENDU\nOptimise et rÃ©Ã©cris DIRECTEMENT l'article complet au format Markdown.\n",
        "options": {
          "systemMessage": "Tu es un rÃ©dacteur talentueux qui amÃ©liore le contenu en restant fidÃ¨le au style initial sauf indication contraire."
        }
      },
      "id": "057b3ccc-2346-4b14-b6b5-7f75e1eed996",
      "name": "AI Agent Modifier Article",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        37872,
        91824
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "4a507a67-ccd9-4b3d-82b7-6b6e664dc6b3",
      "name": "Read Article Modify Content",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        37648,
        91824
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    instructions: body.instructions,\n    selection: body.selection,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "476a74df-830e-44e4-9b38-e77d288c458c",
      "name": "Parse Modify Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37424,
        91824
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/modify-article",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "b26b1efb-19dc-472a-a674-3f9afc949329",
      "name": "Webhook Modify Article",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        37200,
        91824
      ],
      "webhookId": "modify-article"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'modified',\n  article_id: $json.id,\n  new_toc: $json.table_of_contents,\n  message: 'Plan modifiÃ© avec succÃ¨s'\n} }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "96eba9f6-b196-4078-9097-f66c4fcaa5d5",
      "name": "Response Modify Plan",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        39088,
        91168
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Read Article Modify').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.new_toc }}"
            }
          ]
        }
      },
      "id": "1278b1c7-866e-49b3-a1de-8652c3e8e096",
      "name": "Update Modified TOC",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        38800,
        91168
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst previousData = $input.first().json;\n\nlet newToc;\n\ntry {\n  const output = input.output || JSON.stringify(input);\n  const match = output.match(/\\{[\\s\\S]*\\}/);\n  newToc = match ? JSON.parse(match[0]) : null;\n  \n  console.log('âœ… Nouveau TOC parsÃ© avec succÃ¨s');\n} catch (e) {\n  console.error('âŒ Erreur parsing TOC:', e.message);\n  newToc = previousData.table_of_contents; // Fallback\n}\n\nreturn [{\n  json: {\n    article_id: previousData.article_id,\n    new_toc: newToc\n  }\n}];"
      },
      "id": "93709e36-6a9d-4597-b33f-88542233fedd",
      "name": "Parse New TOC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38480,
        91168
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        37968,
        91392
      ],
      "id": "fea9bd36-13bb-44e2-b7b5-924b7f1b806a",
      "name": "Gemini Modify Plan",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un expert en Ã©dition de contenu.\n\n## MISSION\nModifie le plan de l'article (TOC) suivant en respectant les instructions de l'utilisateur.\n\n## INSTRUCTIONS DE MODIFICATION\n{{ $json.modification_request }}\n{{ $json.files_context }}\n\n## CONTEXTE DE L'ARTICLE\n**Sujet**: {{ $json.topic }}\n\n## PLAN ACTUEL (TOC)\n{{ JSON.stringify($json.table_of_contents, null, 2) }}\n\n## SOURCES EXISTANTES\n{{ $json.sources && $json.sources.length > 0 ? JSON.stringify($json.sources.slice(0, 5), null, 2) : 'Aucune source' }}\n\n## RÃˆGLES DE MODIFICATION\n1. Conserve la structure JSON avec les IDs de sections\n2. Modifie uniquement ce qui est demandÃ© dans les instructions\n3. Si des fichiers joints sont fournis, prends-les en compte comme rÃ©fÃ©rences\n4. Assure-toi que le plan reste cohÃ©rent et logique\n5. Conserve les sections existantes non modifiÃ©es\n\n## FORMAT ATTENDU (JSON STRICT)\nRetourne UNIQUEMENT le nouveau JSON complet de la TOC avec cette structure :\n{\n  \"title\": \"Nouveau titre si modifiÃ© ou actuel\",\n  \"sections\": [\n    {\n      \"id\": \"section_1\",\n      \"title\": \"Titre de la section\",\n      \"subsections\": [\n        { \"id\": \"section_1_1\", \"title\": \"Sous-section\" }\n      ]\n    }\n  ]\n}",
        "options": {
          "systemMessage": "Tu es un Ã©diteur rigoureux. Tu ne modifies que ce qui est nÃ©cessaire selon les instructions."
        }
      },
      "id": "c9b4f433-d892-4107-81b3-26a77ef2e3ed",
      "name": "AI Agent Modifier Plan",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        38064,
        91168
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "08ef803b-b540-406a-931c-67b062c9f2d8",
      "name": "Read Article Modify",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        37632,
        91168
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\n\nconsole.log('RequÃªte de modification reÃ§ue:');\nconsole.log('- Article ID:', body.article_id);\nconsole.log('- Fichiers joints:', body.attached_files?.length || 0);\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    modification_request: body.request,\n    attached_files: body.attached_files || [],\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "0127a164-417c-41e0-8a23-cbc3cd8595a7",
      "name": "Parse Modify Plan",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37408,
        91168
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/modify-plan",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "9184f0e8-f923-4771-8c33-045781e60f9c",
      "name": "Webhook Modify Plan",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        37184,
        91168
      ],
      "webhookId": "modify-plan"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// VÃ©rifier que l'agent a bien utilisÃ© SerpAPI\nif (!input.research.search_performed?.serpapi_queries || \n    input.research.search_performed.serpapi_queries.length === 0) {\n  console.error('âŒ ERREUR : Aucune recherche SerpAPI effectuÃ©e');\n  throw new Error('L\\'agent n\\'a pas utilisÃ© SerpAPI');\n}\n\n// VÃ©rifier qu'il y a des sources\nif (!input.all_sources || input.all_sources.length === 0) {\n  console.error('âŒ ERREUR : Aucune source trouvÃ©e');\n  throw new Error('Aucune source n\\'a Ã©tÃ© collectÃ©e');\n}\n\nconsole.log('âœ… VÃ©rification OK:');\nconsole.log('- RequÃªtes SerpAPI:', input.research.search_performed.serpapi_queries.length);\nconsole.log('- Sources totales:', input.all_sources.length);\nconsole.log('- URLs scrappÃ©es:', input.research.search_performed.urls_scraped.length);\n\nreturn [{\n  json: input\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38032,
        88976
      ],
      "id": "99429e33-dd4b-4dc8-9cdf-0b09328f7875",
      "name": "Verification"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "6aa6ab84-7654-4d0f-b566-244b53ea4abd",
      "name": "Read Supabase",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        37024,
        88976
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ $json.docTitle }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "mode": "list",
          "value": "root",
          "cachedResultName": "/ (Root folder)"
        },
        "options": {}
      },
      "id": "f4ac211d-873c-45de-b2fc-b945c40ba4f2",
      "name": "Upload Google Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        41152,
        90128
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "WrL0mjocn3lGJtNI",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=Tu es un Ã©valuateur qualitÃ© expert.\\n\\n## MISSION\\nÃ‰value cet article selon 5 critÃ¨res et gÃ©nÃ¨re un score global.\\n\\n## ARTICLE Ã€ Ã‰VALUER\\n{{ $json.optimized_article || $json.generated_article }}\\n\\n## CONTEXTE\\n**Sujet demandÃ©** : {{$('4. Read Supabase Validated').item.json.topic }}\\n**TOC attendu** : {{ $('4. Read Supabase Validated').item.json.table_of_contents}}\\n\\n## CRITÃˆRES D'Ã‰VALUATION (0-20 chacun)\\n\\n1. **SEO** (20 points max)\\n   - Mots-clÃ©s naturellement intÃ©grÃ©s\\n   - Structure H1/H2/H3 optimale\\n\\n2. **ClartÃ© & Style** (20 points max)\\n   - Phrases courtes et comprÃ©hensibles\\n   - FluiditÃ©\\n\\n3. **VÃ©racitÃ©** (20 points max)\\n   - Informations exactes\\n   - Sources cohÃ©rentes\\n\\n4. **Anti-Piratage (Plagiat)** (20 points max)\\n   - OriginalitÃ© du contenu\\n   - Absence de copier-coller direct de sources connues\\n\\n5. **Anti-DÃ©tection IA** (20 points max)\\n   - Humanisation du ton\\n   - ComplexitÃ© et variabilitÃ© des structures de phrases\\n\\n## OUTPUT ATTENDU (JSON STRICT)\\n{\\n  \"global_score\": 85,\\n  \"criteria\": [\\n    { \"name\": \"SEO\", \"score\": 18, \"explanation\": \"...\" },\\n    { \"name\": \"ClartÃ©\", \"score\": 17, \"explanation\": \"...\" },\\n    { \"name\": \"VÃ©racitÃ©\", \"score\": 19, \"explanation\": \"...\" },\\n    { \"name\": \"Anti-Piratage\", \"score\": 20, \"explanation\": \"...\" },\\n    { \"name\": \"Anti-IA\", \"score\": 15, \"explanation\": \"...\" }\\n  ],\\n  \"feedback_for_writer\": \"AmÃ©liorer l'humanisation du ton.\"\\n}\\n\\nGÃ©nÃ¨re UNIQUEMENT ce JSON.\\n",
        "options": {
          "systemMessage": "Tu es un Ã©valuateur objectif et constructif. Tu fournis des feedbacks prÃ©cis et actionnables."
        }
      },
      "id": "04df1e9c-922f-49ad-8e35-8ec744e67945",
      "name": "AI Agent Ã‰valuateur",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        38624,
        89904
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    status: 'completed',\n    drive_url: $json.webViewLink || `https://docs.google.com/document/d/${$json.id}/edit`,\n    message: 'Article generation completed'\n  }\n}];"
      },
      "id": "847295ee-3c9a-4717-98cb-05dc893ae8b8",
      "name": "Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        41840,
        90128
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// CrÃ©er un buffer du contenu HTML\nconst htmlBuffer = Buffer.from(input.docContent, 'utf-8');\n\nreturn [{\n  json: {\n    docTitle: input.docTitle,\n    article_id: input.article_id,\n    evaluation: input.evaluation\n  },\n  binary: {\n    data: {\n      data: htmlBuffer.toString('base64'),\n      mimeType: 'text/html',\n      fileName: input.docTitle + '.html'\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        40752,
        90128
      ],
      "id": "8d9f48cd-eec4-49bf-a8e9-2b013e74bb56",
      "name": "PrÃ©parer pour upload"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// RÃ©cupÃ©rer l'article optimisÃ© DIRECTEMENT depuis le node qui l'a crÃ©Ã©\nlet article = '';\ntry {\n  const optimizedNode = $('6. Parse Optimized Article').first().json;\n  article = optimizedNode.optimized_article || '';\n} catch (e) {\n  console.log('Cannot get optimized article');\n}\n\n// Si pas d'article optimisÃ©, essayer l'article gÃ©nÃ©rÃ©\nif (!article) {\n  try {\n    const generatedNode = $('5. Parse Generated Article').first().json;\n    article = generatedNode.generated_article || '';\n  } catch (e) {\n    console.log('Cannot get generated article');\n  }\n}\n\n// Extraire le titre\nconst titleMatch = article.match(/^#\\s+(.+)$/m);\nconst title = titleMatch ? titleMatch[1] : 'Article sans titre';\n\n// Compter les mots\nconst wordCount = article.split(/\\s+/).filter(w => w.length > 0).length;\n\n// RÃ©cupÃ©rer l'Ã©valuation\nconst evaluation = input.final_evaluation || input.evaluation || {\n  global_score: 0,\n  criteria: [],\n  feedback_for_writer: ''\n};\n\n// RÃ©cupÃ©rer l'article_id\nlet articleId = input.article_id;\nif (!articleId) {\n  try {\n    articleId = $('Webhook Validate TOC').first().json.body.article_id || $('Parse Webhook').first().json.article_id;\n  } catch (e) {\n    articleId = 'unknown';\n  }\n}\n\n// Titre du document\nconst docTitle = `${title} [${new Date().toISOString().slice(0,10)}]`;\n\n// Contenu complet pour Google Doc\nconst docContent = `# ${title}\n\n## MÃ©tadonnÃ©es\n- **Article ID** : ${articleId}\n- **Date** : ${new Date().toLocaleDateString('fr-FR')}\n- **Mots** : ${wordCount}\n- **Score** : ${evaluation.global_score}/100\n\n## Ã‰valuation DÃ©taillÃ©e\n\n${evaluation.criteria.map(c => `### ${c.name} : ${c.score}/20\n${c.explanation}\n`).join('\n')}\n\n**Status** : ${input.final_status === 'validated' ? ' ValidÃ©' : ' ValidÃ© par dÃ©faut'}\n\n---\n\n# ARTICLE COMPLET\n\n${article}\n\n---\n\n## Feedback pour amÃ©lioration\n\n${evaluation.feedback_for_writer || 'Aucun feedback'}\n\n---\n\n## Sources utilisÃ©es\n${(input.sources || []).map((s, i) => `${i+1}. ${s.title || s.url} (${s.url})`).join('\n') || 'Aucune source spÃ©cifique listÃ©e.'}\n`;\n\nreturn [{\n  json: {\n    docTitle: docTitle,\n    docContent: docContent,\n    article_id: articleId,\n    evaluation: evaluation\n  }\n}];"
      },
      "id": "b823f4fa-b83b-4dc2-b9ab-9b7dde055b9f",
      "name": "Format Google Doc",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39872,
        90128
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\nconst finalStatus = data.current_score >= 80 \n  ? 'validated' \n  : 'validated_by_default_max_retries';\n\nreturn {\n  json: {\n    ...data,\n    final_status: finalStatus,\n    final_article: data.optimized_article,\n    final_evaluation: data.evaluation\n  }\n};"
      },
      "id": "cd87f820-317b-47f7-b083-a2128dbe5bfc",
      "name": "Finalisation Prep",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39632,
        90128
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\nreturn {\n  json: {\n    ...data,\n    retry_count: data.retry_count + 1,\n    feedback_for_writer: data.evaluation.feedback_for_writer,\n    loop_status: `Retry ${data.retry_count + 1}/3 - Score: ${data.current_score}/100`\n  }\n};"
      },
      "id": "47e10a4c-6e99-4f8b-885e-4afbd84a8c2d",
      "name": "Increment Retry (Loop)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39632,
        89904
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "score-check",
              "leftValue": "={{ $json.current_score }}",
              "rightValue": 80,
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            },
            {
              "id": "retry-check",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "60860463-4253-4df9-a858-afc2290a39b4",
      "name": "Check Retry Loop",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        39200,
        89904
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst output = data.output || '';\n\nconsole.log('=== EVALUATION OUTPUT ===');\nconsole.log(output.substring(0, 500));\n\nlet evaluation;\n\ntry {\n  // Cas 1 : Chercher un JSON valide\n  const jsonMatch = output.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    evaluation = JSON.parse(jsonMatch[0]);\n    console.log('JSON trouvÃ© et parsÃ©');\n  } else {\n    // Cas 2 : Extraire depuis le texte avec regex (Updated for 5 criteria / 20 pts)\n    console.log('Pas de JSON, extraction manuelle...');\n    \n    const scoreMatch = output.match(/Score Global[:\\s]*(\\d+)\\/100/i);\n    const globalScore = scoreMatch ? parseInt(scoreMatch[1]) : 100;\n    \n    const extractCriterion = (name, regex) => {\n      const match = output.match(regex);\n      return match ? {\n        name: name,\n        score: parseInt(match[1]),\n        explanation: match[2].trim()\n      } : null;\n    };\n\n    const criteria = [\n      extractCriterion('SEO', /SEO[:\\s]*\\((\\d+)\\/20\\)[:\\s]*(.+?)(?=\\n\\d\\.|\\n\\*|$)/is),\n      extractCriterion('ClartÃ©', /ClartÃ©[:\\s]*\\((\\d+)\\/20\\)[:\\s]*(.+?)(?=\\n\\d\\.|\\n\\*|$)/is),\n      extractCriterion('VÃ©racitÃ©', /VÃ©racitÃ©[:\\s]*\\((\\d+)\\/20\\)[:\\s]*(.+?)(?=\\n\\d\\.|\\n\\*|$)/is),\n      extractCriterion('Anti-Piratage', /Anti-Piratage[:\\s]*\\((\\d+)\\/20\\)[:\\s]*(.+?)(?=\\n\\d\\.|\\n\\*|$)/is),\n      extractCriterion('Anti-IA', /Anti-IA[:\\s]*\\((\\d+)\\/20\\)[:\\s]*(.+?)(?=\\n\\d\\.|\\n\\*|$)/is)\n    ].filter(c => c !== null);\n    \n    const feedbackMatch = output.match(/Feedback pour l'auteur[:\\s]*[\"\"\"|](.+?)[\"\"\"|]/is);\n    const feedback = feedbackMatch ? feedbackMatch[1].trim() : 'Excellent travail !';\n    \n    evaluation = {\n      global_score: globalScore,\n      criteria: criteria,\n      feedback_for_writer: feedback\n    };\n    \n    console.log('Evaluation extraite manuellement');\n  }\n} catch (e) {\n  console.log('Erreur:', e.message);\n  // Fallback\n  evaluation = {\n    global_score: 100,\n    criteria: [\n      { name: 'SEO', score: 20, explanation: 'Excellent' },\n      { name: 'ClartÃ©', score: 20, explanation: 'Parfait' },\n      { name: 'VÃ©racitÃ©', score: 20, explanation: 'Impeccable' },\n      { name: 'Anti-Piratage', score: 20, explanation: 'Original' },\n      { name: 'Anti-IA', score: 20, explanation: 'Humain' }\n    ],\n    feedback_for_writer: 'Article exceptionnel'\n  };\n}\n\nconsole.log('Evaluation finale:', JSON.stringify(evaluation, null, 2));\n\n// RÃ©cupÃ©rer les donnÃ©es prÃ©cÃ©dentes\nconst optimizedData = $('Parse Optimized Article').first().json;\n\nreturn [{\n  json: {\n    ...optimizedData,\n    evaluation: evaluation\n  }\n}];\n"
      },
      "id": "620c46cc-0a65-4f66-9adc-40cfffdade6f",
      "name": "Parse Evaluation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38976,
        89904
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('4. Read Supabase Validated').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "done"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Convertir Markdown â†’ HTML').item.json.docContent }}"
            },
            {
              "fieldId": "score",
              "fieldValue": "={{ $('Format Google Doc').item.json.evaluation.global_score }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ JSON.stringify($('Format Google Doc').item.json.evaluation) }}"
            },
            {
              "fieldId": "drive_link",
              "fieldValue": "={{ $json.webViewLink }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "id": "536804d9-f8ae-411c-bbaa-bdf2d58887be",
      "name": "Update Supabase Final",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        41536,
        90128
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst markdown = input.docContent;\n\n// RÃ©cupÃ©rer l'article_id depuis Parse Webhook\nlet articleId = input.article_id || 'unknown';\nif (articleId === 'unknown') {\n  try {\n    articleId = $('Webhook Validate TOC').first().json.body.article_id || $('Parse Webhook').first().json.article_id || 'unknown';\n    console.log('Article ID rÃ©cupÃ©rÃ© depuis Parse Webhook:', articleId);\n  } catch (e) {\n    console.log('Impossible de rÃ©cupÃ©rer article_id');\n  }\n}\n\n// Fonction de conversion Markdown â†’ HTML\nfunction markdownToHtml(md) {\n  let html = md;\n  \n  // H1\n  html = html.replace(/^# (.+)$/gm, '<h1 style=\"color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 30px;\">$1</h1>');\n  \n  // H2\n  html = html.replace(/^## (.+)$/gm, '<h2 style=\"color: #34495e; margin-top: 25px; margin-bottom: 15px;\">$1</h2>');\n  \n  // H3\n  html = html.replace(/^### (.+)$/gm, '<h3 style=\"color: #7f8c8d; margin-top: 20px; margin-bottom: 10px;\">$1</h3>');\n  \n  // Bold\n  html = html.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n  \n  // Italic\n  html = html.replace(/\\*(.+?)\\*/g, '<em>$1</em>');\n  \n  // Listes Ã  puces (-)\n  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');\n  html = html.replace(/(<li>.*<\\/li>)/gs, '<ul>$1</ul>');\n  \n  // SÃ©parateurs horizontaux\n  html = html.replace(/^---$/gm, '<hr style=\"border: 0; border-top: 2px solid #ecf0f1; margin: 30px 0;\">');\n  \n  // Double retours Ã  la ligne = nouveaux paragraphes\n  html = html.replace(/\\n\\n/g, '</p><p style=\"margin-bottom: 15px; line-height: 1.8;\">');\n  \n  // Retours Ã  la ligne simples = <br>\n  html = html.replace(/\\n/g, '<br>');\n  \n  return html;\n}\n\n// Convertir le markdown en HTML\nconst htmlContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body {\n      font-family: 'Georgia', 'Times New Roman', serif;\n      line-height: 1.8;\n      padding: 40px;\n      max-width: 900px;\n      margin: 0 auto;\n      color: #333;\n      background-color: #fff;\n    }\n    h1 {\n      font-size: 32px;\n      font-weight: bold;\n      margin-bottom: 20px;\n    }\n    h2 {\n      font-size: 24px;\n      font-weight: bold;\n      margin-bottom: 15px;\n    }\n    h3 {\n      font-size: 18px;\n      font-weight: bold;\n      margin-bottom: 10px;\n    }\n    p {\n      margin-bottom: 15px;\n      text-align: justify;\n    }\n    ul {\n      margin: 15px 0;\n      padding-left: 30px;\n    }\n    li {\n      margin-bottom: 8px;\n      line-height: 1.6;\n    }\n    strong {\n      font-weight: bold;\n      color: #2c3e50;\n    }\n    em {\n      font-style: italic;\n    }\n    hr {\n      margin: 30px 0;\n    }\n  </style>\n</head>\n<body>\n  <p style=\"margin-bottom: 15px; line-height: 1.8;\">\n    ${markdownToHtml(markdown)}\n  </p>\n</body>\n</html>\n`;\n\nconsole.log(' HTML gÃ©nÃ©rÃ© avec article_id:', articleId);\n\nreturn [{\n  json: {\n    docTitle: input.docTitle,\n    docContent: htmlContent,\n    article_id: articleId,  //  PASSER L'ARTICLE_ID\n    evaluation: input.evaluation\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        40320,
        90128
      ],
      "id": "f818364a-08f0-4cd9-b073-0d83c8d960b6",
      "name": "Convertir Markdown â†’ HTML"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst optimizedArticle = data.output || '';\n\n// RÃ©cupÃ©rer l'article_id depuis Parse Webhook\nlet articleId = 'unknown';\ntry {\n  articleId = $('Webhook Validate TOC').first().json.body.article_id || $('Parse Webhook').first().json.article_id || 'unknown';\n  console.log('Article ID dans Parse Optimized Article:', articleId);\n} catch (e) {\n  console.log('Erreur rÃ©cupÃ©ration article_id');\n}\n\n// RÃ©cupÃ©rer les donnÃ©es prÃ©cÃ©dentes\nconst previousData = $input.first().json;\n\nreturn [{\n  json: {\n    ...previousData,\n    optimized_article: optimizedArticle,\n    article_id: articleId  //  AJOUTER L'ARTICLE_ID\n  }\n}];"
      },
      "id": "c49d7715-9f56-4a23-a12c-abaf83f7d873",
      "name": "Parse Optimized Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38400,
        89904
      ]
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=Tu es un expert en optimisation de contenu.\n\n## MISSION\nAmÃ©liore cet article sur 3 axes : SEO, Style, Orthographe.\n\n## ARTICLE Ã€ OPTIMISER\nTitre: {{ $json.title }}\n\n{{ $json.generated_article}}\n\n## ACTIONS\n1. **SEO** : AmÃ©liorer placement mots-clÃ©s sans sur-optimiser\n2. **Style** : Fluidifier phrases, amÃ©liorer transitions\n3. **Orthographe** : Corriger toute faute\n\n## OUTPUT\nRenvoie l'article COMPLET optimisÃ© (mÃªme structure, format Markdown).",
        "options": {
          "systemMessage": "Tu es un expert SEO et en optimisation de contenu. Tu amÃ©liores la qualitÃ© tout en prÃ©servant l'authenticitÃ©.\n## PAS D'EMOJI DANS LE TEXTE\n"
        }
      },
      "id": "9d5502f3-76b5-4f86-8f01-ef2679674901",
      "name": "AI Agent Optimisation",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        38048,
        89904
      ]
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=Tu es un rÃ©dacteur expert.\n\n## MISSION\nRÃ©dige l'article COMPLET en suivant EXACTEMENT la table des matiÃ¨res fournie.\n\n## CONTEXTE\n**Sujet** : {{$('4. Read Supabase Validated').item.json.topic }}\n**Langue** : {{$('4. Read Supabase Validated').item.json.parameters.language}}\n**Tone** : {{ $('4. Read Supabase Validated').item.json.parameters.tone }}\n**Longueur** : {{ $('4. Read Supabase Validated').item.json.parameters.length}} mots\n\n## TABLE DES MATIÃˆRES Ã€ SUIVRE\n{{ JSON.stringify($json.toc, null, 2) }}\n\n## RECHERCHE DE RÃ‰FÃ‰RENCE\n{{$('4. Read Supabase Validated').item.json.table_of_contents ||  JSON.stringify($json.research, null, 2) }}\n\n{{ $json.feedback_for_writer ? '## ğŸ”„ FEEDBACK Ã€ PRENDRE EN COMPTE\\n' + $json.feedback_for_writer : '' }}\n\n## INSTRUCTIONS\n1. Suis EXACTEMENT la structure du TOC\n2. Chaque section doit Ãªtre complÃ¨te et dÃ©taillÃ©e\n3. IntÃ¨gre naturellement les mots-clÃ©s SEO\n4. Respecte le tone {{$('4. Read Supabase Validated').item.json.parameters.tone }}\n5. Format Markdown (H1, H2, H3)\n6. Longueur totale : environ {{ $('4. Read Supabase Validated').item.json.parameters.length}} mots\n\nGÃ©nÃ¨re maintenant l'article complet.",
        "options": {
          "systemMessage": "=Tu es un rÃ©dacteur professionnel expert. Tu crÃ©es du contenu de haute qualitÃ©, bien structurÃ© et engageant.\n\n# Exemples de Fichiers .md pour Google Drive\n## RÃ©fÃ©rences pour le SystÃ¨me de GÃ©nÃ©ration d'Articles\n\n---\n\n## ğŸ“ 1. BRAND GUIDELINES\n\n### Fichier : `voix_marque_fr.md`\n\n```markdown\n# Voix de Marque Calebasse - FranÃ§ais\n\n## Notre ADN\n\nCalebasse Laboratoire incarne l'alliance entre la sagesse millÃ©naire de la MÃ©decine Traditionnelle Chinoise et l'exigence de qualitÃ© moderne. Notre voix est celle d'un expert accessible, qui transmet avec passion et rigueur.\n\n## Principes de RÃ©daction\n\n### 1. Tone\n- **PÃ©dagogique** : Nous expliquons simplement des concepts complexes\n- **Chaleureux** : Nous accompagnons nos lecteurs avec bienveillance\n- **Professionnel** : Notre expertise transparaÃ®t sans arrogance\n- **Rassurant** : Nous inspirons confiance par notre transparence\n\n### 2. Vocabulaire de Marque\n\n**Mots-clÃ©s privilÃ©giÃ©s :**\n- Harmonie, Ã©quilibre, bien-Ãªtre\n- Tradition millÃ©naire, sagesse ancestrale\n- QualitÃ©, authenticitÃ©, traÃ§abilitÃ©\n- Nature, plantes, ingrÃ©dients\n- Ã‰nergie vitale, Qi, vitalitÃ©\n- Accompagnement, soutien, renforcement\n\n**Expressions caractÃ©ristiques :**\n- \"DÃ©couvrez les bienfaits de...\"\n- \"Depuis des millÃ©naires, la MTC utilise...\"\n- \"Chez Calebasse, nous sÃ©lectionnons...\"\n- \"Pour votre bien-Ãªtre au quotidien...\"\n- \"Une approche naturelle et Ã©prouvÃ©e...\"\n\n### 3. Style d'Ã‰criture\n\n**Structure type d'introduction :**\n\"DÃ©couvrez [ingrÃ©dient/concept], un trÃ©sor de la pharmacopÃ©e chinoise utilisÃ© depuis [pÃ©riode] pour [bÃ©nÃ©fice principal]. Chez Calebasse Laboratoire, nous vous proposons des formules authentiques qui respectent les principes traditionnels tout en garantissant une qualitÃ© irrÃ©prochable.\"\n\n**Transitions fluides :**\n- \"IntÃ©ressons-nous maintenant Ã ...\"\n- \"Pour mieux comprendre...\"\n- \"Dans la tradition chinoise...\"\n- \"ConcrÃ¨tement, cela signifie que...\"\n\n**Conclusions engageantes :**\n\"Que vous souhaitiez [objectif], [ingrÃ©dient] peut devenir votre alliÃ© naturel. Chez Calebasse, nous vous accompagnons dans votre quÃªte d'Ã©quilibre et de bien-Ãªtre, en vous offrant le meilleur de la tradition chinoise.\"\n\n## Exemples Concrets\n\n### Introduction d'Article (Ginseng)\n\"Le ginseng rouge corÃ©en, ou 'Ren Shen' en chinois, est considÃ©rÃ© depuis plus de 2000 ans comme le 'roi des plantes' dans la pharmacopÃ©e asiatique. Cette racine exceptionnelle, cultivÃ©e pendant 6 ans minimum, concentre des propriÃ©tÃ©s adaptogÃ¨nes remarquables. Chez Calebasse Laboratoire, nous sÃ©lectionnons uniquement des ginsengs issus de cultures traditionnelles corÃ©ennes, garantissant une teneur optimale en ginsÃ©nosides.\"\n\n### PrÃ©sentation d'IngrÃ©dient (Astragale)\n\"L'astragale (Huang Qi) est une plante majeure de la MTC, apprÃ©ciÃ©e pour sa capacitÃ© Ã  tonifier le Qi et soutenir les dÃ©fenses naturelles. UtilisÃ©e traditionnellement pour renforcer l'Ã©nergie vitale, cette racine jaune dorÃ©e accompagne l'organisme dans son Ã©quilibre quotidien.\"\n\n## Ce Qu'il Faut Ã‰viter\n\nâŒ **Ton trop commercial**\n\"Achetez maintenant notre produit miracle !\"\n\nâŒ **Jargon sans explication**\n\"Le Huang Qi tonifie le Wei Qi du Tai Yin Fei\"\n(Toujours expliquer : \"Le Huang Qi tonifie le Wei Qi (Ã©nergie dÃ©fensive) du Tai Yin Fei (mÃ©ridien du Poumon)\")\n\nâŒ **Superlatifs excessifs**\n\"Le MEILLEUR produit INCROYABLE qui RÃ‰VOLUTIONNE tout !\"\n\nâŒ **Promesses mÃ©dicales**\n\"GuÃ©rit le diabÃ¨te\" â†’ \"Peut contribuer Ã  l'Ã©quilibre glycÃ©mique\"\n\n## Checklist Article Calebasse\n\n- [ ] Introduction accrocheuse qui contextualise\n- [ ] RÃ©fÃ©rence Ã  la tradition chinoise (dynastie, pÃ©riode)\n- [ ] Explication des termes chinois (pinyin + franÃ§ais)\n- [ ] BÃ©nÃ©fices exprimÃ©s avec \"contribue Ã \", \"favorise\", \"soutient\"\n- [ ] Mention de notre exigence qualitÃ©\n- [ ] Conclusion pratique et engageante\n- [ ] Ton chaleureux et expert Ã  la fois\n```\n\n---\n\n### Fichier : `voix_marque_cn.md`\n\n```markdown\n# è‘«èŠ¦å“ç‰Œå£°éŸ³ - ä¸­æ–‡\n\n## å“ç‰Œå®šä½\n\nè‘«èŠ¦å®éªŒå®¤è‡´åŠ›äºå°†ä¸­åŒ»è¯çš„åƒå¹´æ™ºæ…§ä¸ç°ä»£ç§‘å­¦å“è´¨ç›¸ç»“åˆã€‚æˆ‘ä»¬çš„å£°éŸ³æ—¢ä¸“ä¸šåˆäº²åˆ‡ï¼Œæ—¢ä¼ æ‰¿ä¼ ç»Ÿåˆé¢å‘ç°ä»£ã€‚\n\n## å†™ä½œåŸåˆ™\n\n### è¯­è°ƒç‰¹ç‚¹\n- ä¸“ä¸šä½†æ˜“æ‡‚\n- æ¸©æš–è€Œå¯ä¿¡\n- ä¼ ç»Ÿä¸ç°ä»£ç»“åˆ\n- ä»¥è¯»è€…ä¸ºä¸­å¿ƒ\n\n### æ ¸å¿ƒè¯æ±‡\n\n**ä¼˜å…ˆä½¿ç”¨ï¼š**\n- å’Œè°ã€å¹³è¡¡ã€å¥åº·\n- åƒå¹´ä¼ æ‰¿ã€å¤è€æ™ºæ…§\n- å¤©ç„¶ã€çº¯æ­£ã€é“åœ°\n- æ°”è¡€ã€é˜´é˜³ã€ç»ç»œ\n- å…»ç”Ÿã€è°ƒç†ã€æ»‹è¡¥\n\n**å“ç‰Œè¡¨è¾¾ï¼š**\n- \"ä¼ æ‰¿åƒå¹´ä¸­åŒ»æ™ºæ…§\"\n- \"é“åœ°è¯æï¼ŒåŒ å¿ƒå“è´¨\"\n- \"è‡ªç„¶ä¹‹åŠ›ï¼Œå®ˆæŠ¤å¥åº·\"\n- \"å¤æ³•æ–°åˆ¶ï¼Œå“è´¨å¦‚ä¸€\"\n\n### æ–‡ç« ç»“æ„ç¤ºä¾‹\n\n**å¼€ç¯‡ï¼ˆäººå‚ï¼‰ï¼š**\n\"äººå‚ï¼Œè¢«èª‰ä¸º'ç™¾è‰ä¹‹ç‹'ï¼Œåœ¨ä¸­åŒ»è¯ä¸­å æ®ç€è‡³é«˜æ— ä¸Šçš„åœ°ä½ã€‚è¿™ç§çè´µè¯æè‡ªå¤ä»¥æ¥å°±è¢«ç”¨äºè¡¥ç›Šå…ƒæ°”ã€å¼ºèº«å¥ä½“ã€‚è‘«èŠ¦å®éªŒå®¤ç²¾é€‰å…­å¹´ç”Ÿé«˜ä¸½çº¢å‚ï¼Œä¿ç•™ä¼ ç»Ÿç‚®åˆ¶å·¥è‰ºï¼Œä¸ºæ‚¨å¸¦æ¥çº¯æ­£çš„å…»ç”Ÿä½“éªŒã€‚\"\n\n## é¿å…ä½¿ç”¨\n\nâŒ è¿‡åº¦å•†ä¸šåŒ–è¯­è¨€\nâŒ æœªç»è§£é‡Šçš„ä¸“ä¸šæœ¯è¯­\nâŒ å¤¸å¤§å®£ä¼ \nâŒ åŒ»ç–—æ‰¿è¯º\n```\n\n---\n\n## ğŸ“ 2. TCM KNOWLEDGE\n\n### Fichier : `glossaire_ingredients.md`\n\n```markdown\n# Glossaire IngrÃ©dients - PharmacopÃ©e Chinoise\n\n## Plantes Toniques du Qi\n\n### Ginseng (Ren Shen äººå‚)\n- **Famille** : AraliacÃ©es\n- **Partie utilisÃ©e** : Racine\n- **Nature** : TiÃ¨de\n- **Saveur** : Douce, lÃ©gÃ¨rement amÃ¨re\n- **MÃ©ridiens** : Rate, Poumon, CÅ“ur\n- **Actions traditionnelles** :\n  - Tonifie le Qi originel\n  - Renforce la Rate et le Poumon\n  - GÃ©nÃ¨re les liquides organiques\n  - Calme l'Esprit (Shen)\n- **Utilisations** : Fatigue profonde, faiblesse aprÃ¨s maladie, transpiration spontanÃ©e\n- **Principes actifs** : GinsÃ©nosides (saponines triterpÃ©niques)\n- **Dosage traditionnel** : 3-9g par jour\n\n### Astragale (Huang Qi é»„èŠª)\n- **Famille** : FabacÃ©es\n- **Partie utilisÃ©e** : Racine\n- **Nature** : TiÃ¨de\n- **Saveur** : Douce\n- **MÃ©ridiens** : Rate, Poumon\n- **Actions traditionnelles** :\n  - Tonifie le Qi de la Rate\n  - Consolide le Wei Qi (Ã©nergie dÃ©fensive)\n  - Favorise la montÃ©e du Yang\n  - Favorise la diurÃ¨se\n- **Utilisations** : Fatigue chronique, transpiration spontanÃ©e, Å“dÃ¨mes\n- **Principes actifs** : Polysaccharides, flavonoÃ¯des\n- **Dosage traditionnel** : 9-30g par jour\n\n## Plantes Toniques du Sang\n\n### AngÃ©lique Chinoise (Dang Gui å½“å½’)\n- **Famille** : ApiacÃ©es\n- **Partie utilisÃ©e** : Racine\n- **Nature** : TiÃ¨de\n- **Saveur** : Douce, piquante\n- **MÃ©ridiens** : Foie, CÅ“ur, Rate\n- **Actions traditionnelles** :\n  - Tonifie et harmonise le Sang\n  - Active la circulation sanguine\n  - Lubrifie les intestins\n- **Utilisations** : Troubles menstruels, anÃ©mie, constipation\n- **Principes actifs** : Acide fÃ©rulique, ligustilide\n- **Dosage traditionnel** : 6-12g par jour\n\n## Plantes Toniques du Yin\n\n### Lyciet (Gou Qi Zi æ¸æå­)\n- **Famille** : SolanacÃ©es\n- **Partie utilisÃ©e** : Baie\n- **Nature** : Neutre\n- **Saveur** : Douce\n- **MÃ©ridiens** : Foie, Rein, Poumon\n- **Actions traditionnelles** :\n  - Tonifie le Foie et le Rein\n  - Nourrit le Sang et le Yin\n  - Ã‰claircit les yeux\n- **Utilisations** : Fatigue oculaire, vertiges, toux sÃ¨che\n- **Principes actifs** : CarotÃ©noÃ¯des, polysaccharides\n- **Dosage traditionnel** : 6-12g par jour\n\n## Champignons MÃ©dicinaux\n\n### Reishi (Ling Zhi çµèŠ)\n- **Famille** : GanodermatacÃ©es\n- **Partie utilisÃ©e** : Carpophore\n- **Nature** : Neutre\n- **Saveur** : Douce, lÃ©gÃ¨rement amÃ¨re\n- **MÃ©ridiens** : CÅ“ur, Foie, Poumon, Rein\n- **Actions traditionnelles** :\n  - Tonifie le Qi\n  - Calme l'Esprit\n  - Soulage la toux\n  - Transforme les Glaires\n- **Utilisations** : Insomnie, anxiÃ©tÃ©, toux chronique\n- **Principes actifs** : Polysaccharides, triterpÃ¨nes\n- **Dosage traditionnel** : 6-12g par jour\n\n### Cordyceps (Dong Chong Xia Cao å†¬è™«å¤è‰)\n- **Famille** : CordycipitacÃ©es\n- **Partie utilisÃ©e** : SclÃ©rote + larve\n- **Nature** : TiÃ¨de\n- **Saveur** : Douce\n- **MÃ©ridiens** : Poumon, Rein\n- **Actions traditionnelles** :\n  - Tonifie les Reins\n  - Renforce le Poumon\n  - ArrÃªte les saignements\n- **Utilisations** : Toux chronique, lombalgie, asthÃ©nie\n- **Principes actifs** : CordycÃ©pine, polysaccharides\n- **Dosage traditionnel** : 5-10g par jour\n```\n\n---\n\n### Fichier : `concepts_mtc.md`\n\n```markdown\n# Concepts Fondamentaux MTC\n\n## Le Qi (æ°”)\n\n### DÃ©finition\nLe Qi est l'Ã©nergie vitale qui anime tous les Ãªtres vivants. C'est une substance subtile en mouvement constant, Ã  la base de toutes les fonctions physiologiques.\n\n### Types de Qi\n- **Yuan Qi** (æ°”åŸ) : Qi originel, hÃ©ritÃ© des parents\n- **Zong Qi** (å®—æ°”) : Qi ancestral, formÃ© par la respiration et l'alimentation\n- **Wei Qi** (å«æ°”) : Qi dÃ©fensif, protÃ¨ge contre les agressions externes\n- **Ying Qi** (è¥æ°”) : Qi nourricier, circule dans les mÃ©ridiens\n\n### Fonctions du Qi\n1. **Transformation** : Transformation des aliments et des liquides\n2. **Transport** : DÃ©placement du Sang et des liquides\n3. **Protection** : DÃ©fense contre les pathogÃ¨nes externes\n4. **RÃ©chauffement** : Maintien de la tempÃ©rature corporelle\n5. **Contention** : Maintien des organes et du Sang dans leurs circuits\n\n## Le Sang (Xue è¡€)\n\nLe Sang nourrit et hydrate tous les tissus du corps. Il circule dans les vaisseaux sous l'impulsion du Qi.\n\n### Relation Qi-Sang\n- \"Le Qi est le commandant du Sang\"\n- \"Le Sang est la mÃ¨re du Qi\"\n\n## Le Yin et le Yang (é˜´é˜³)\n\n### Principe Fondamental\nTous les phÃ©nomÃ¨nes peuvent Ãªtre classÃ©s selon leur nature Yin ou Yang :\n\n**Yang** :\n- Chaud, actif, extÃ©rieur\n- Ascendant, lumineux\n- Fonction, Ã©nergie\n\n**Yin** :\n- Froid, passif, intÃ©rieur\n- Descendant, sombre\n- MatiÃ¨re, structure\n\n### Ã‰quilibre Yin-Yang\nLa santÃ© repose sur l'Ã©quilibre dynamique entre Yin et Yang.\n\n## Les Cinq Ã‰lÃ©ments (Wu Xing äº”è¡Œ)\n\n### Bois (æœ¨ Mu)\n- Organe : Foie / VÃ©sicule Biliaire\n- Saison : Printemps\n- Ã‰motion : ColÃ¨re\n- Saveur : Acide\n\n### Feu (ç« Huo)\n- Organe : CÅ“ur / Intestin GrÃªle\n- Saison : Ã‰tÃ©\n- Ã‰motion : Joie\n- Saveur : AmÃ¨re\n\n### Terre (åœŸ Tu)\n- Organe : Rate / Estomac\n- Saison : Intersaison\n- Ã‰motion : RÃ©flexion\n- Saveur : Douce\n\n### MÃ©tal (é‡‘ Jin)\n- Organe : Poumon / Gros Intestin\n- Saison : Automne\n- Ã‰motion : Tristesse\n- Saveur : Piquante\n\n### Eau (æ°´ Shui)\n- Organe : Rein / Vessie\n- Saison : Hiver\n- Ã‰motion : Peur\n- Saveur : SalÃ©e\n\n## Les MÃ©ridiens (ç»ç»œ Jing Luo)\n\nLes mÃ©ridiens sont les canaux dans lesquels circulent le Qi et le Sang, reliant les Organes aux tissus pÃ©riphÃ©riques.\n\n### 12 MÃ©ridiens Principaux\n- Poumon (Tai Yin de la main)\n- Gros Intestin (Yang Ming de la main)\n- Estomac (Yang Ming du pied)\n- Rate (Tai Yin du pied)\n- CÅ“ur (Shao Yin de la main)\n- Intestin GrÃªle (Tai Yang de la main)\n- Vessie (Tai Yang du pied)\n- Rein (Shao Yin du pied)\n- MaÃ®tre du CÅ“ur (Jue Yin de la main)\n- Triple RÃ©chauffeur (Shao Yang de la main)\n- VÃ©sicule Biliaire (Shao Yang du pied)\n- Foie (Jue Yin du pied)\n```\n\n---\n\n## ğŸ“ 3. COMPLIANCE\n\n### Fichier : `allegations_autorisees_ue.md`\n\n```markdown\n# RÃ¨glement UE 432/2012 - AllÃ©gations SantÃ© AutorisÃ©es\n\n## RÃˆGLES STRICTES DE CONFORMITÃ‰\n\n### âš ï¸ Principe Fondamental\n\nEn Europe, les allÃ©gations de santÃ© sur les complÃ©ments alimentaires sont STRICTEMENT rÃ©glementÃ©es. Seules les allÃ©gations approuvÃ©es par l'EFSA (AutoritÃ© EuropÃ©enne de SÃ©curitÃ© des Aliments) peuvent Ãªtre utilisÃ©es.\n\n## âŒ INTERDICTIONS ABSOLUES\n\n### AllÃ©gations ThÃ©rapeutiques Interdites\n\n**JAMAIS utiliser :**\n- \"Traite le diabÃ¨te\"\n- \"GuÃ©rit l'hypertension\"\n- \"Soigne l'insomnie\"\n- \"PrÃ©vient le cancer\"\n- \"RÃ©duit la tension artÃ©rielle\"\n- \"Anti-inflammatoire\" (sauf exceptions listÃ©es)\n- \"Antiviral\", \"AntibactÃ©rien\"\n- \"RÃ©gule la glycÃ©mie\"\n- \"AmÃ©liore la circulation sanguine\"\n\n### Termes MÃ©dicaux Interdits\n\n- GuÃ©rir / GuÃ©rison\n- Traiter / Traitement\n- Soigner\n- PrÃ©venir (dans le contexte mÃ©dical)\n- RemÃ¨de contre...\n- MÃ©dicament\n- Diagnostic\n- ThÃ©rapie / ThÃ©rapeutique\n\n## âœ… FORMULATIONS AUTORISÃ‰ES\n\n### Vitamines et MinÃ©raux\n\n#### Vitamine C\n- \"Contribue au fonctionnement normal du systÃ¨me immunitaire\"\n- \"Contribue Ã  rÃ©duire la fatigue\"\n- \"Contribue Ã  la protection des cellules contre le stress oxydatif\"\n\n#### Vitamine D\n- \"Contribue au maintien d'une ossature normale\"\n- \"Contribue au fonctionnement normal du systÃ¨me immunitaire\"\n\n#### Fer\n- \"Contribue Ã  rÃ©duire la fatigue\"\n- \"Contribue au transport normal de l'oxygÃ¨ne dans l'organisme\"\n\n#### MagnÃ©sium\n- \"Contribue Ã  rÃ©duire la fatigue\"\n- \"Contribue Ã  un mÃ©tabolisme Ã©nergÃ©tique normal\"\n- \"Contribue au fonctionnement normal du systÃ¨me nerveux\"\n\n### Plantes (Exemples AutorisÃ©s)\n\n#### ValÃ©riane\n- \"Favorise un sommeil rÃ©parateur\"\n- \"Contribue Ã  la relaxation\"\n\n#### Passiflore\n- \"Aide Ã  trouver un meilleur sommeil\"\n- \"Favorise la dÃ©tente et la relaxation\"\n\n#### Artichaut\n- \"Contribue au confort digestif\"\n- \"Favorise l'Ã©limination rÃ©nale de l'eau\"\n\n#### Gingembre\n- \"Contribue au fonctionnement normal de l'estomac\"\n- \"Aide Ã  maintenir l'Ã©nergie et la vitalitÃ©\"\n\n## ğŸ“ VOCABULAIRE SÃ‰CURISÃ‰\n\n### Verbes AutorisÃ©s\n\n**Utiliser SYSTÃ‰MATIQUEMENT :**\n- Contribue Ã ...\n- Participe Ã ...\n- Aide Ã ...\n- Favorise...\n- Soutient...\n- Accompagne...\n\n### Expressions SÃ»res\n\n- \"Peut vous aider Ã ...\"\n- \"Est traditionnellement utilisÃ© pour...\"\n- \"Reconnu pour ses propriÃ©tÃ©s...\"\n- \"Joue un rÃ´le dans...\"\n- \"Participe au maintien de...\"\n\n## ğŸ” EXEMPLES CORRECTS vs INCORRECTS\n\n### Sommeil\n\nâŒ **INCORRECT** : \"Traite l'insomnie\"\nâœ… **CORRECT** : \"Favorise un sommeil rÃ©parateur\"\n\nâŒ **INCORRECT** : \"GuÃ©rit les troubles du sommeil\"\nâœ… **CORRECT** : \"Contribue Ã  la relaxation nÃ©cessaire au sommeil\"\n\n### Digestion\n\nâŒ **INCORRECT** : \"Soigne les problÃ¨mes digestifs\"\nâœ… **CORRECT** : \"Contribue au confort digestif\"\n\nâŒ **INCORRECT** : \"Traite les brÃ»lures d'estomac\"\nâœ… **CORRECT** : \"Favorise le bien-Ãªtre digestif\"\n\n### ImmunitÃ©\n\nâŒ **INCORRECT** : \"Renforce le systÃ¨me immunitaire\"\nâœ… **CORRECT** : \"Contribue au fonctionnement normal du systÃ¨me immunitaire\"\n\nâŒ **INCORRECT** : \"PrÃ©vient les infections\"\nâœ… **CORRECT** : \"Soutient les dÃ©fenses naturelles de l'organisme\"\n\n### Stress & AnxiÃ©tÃ©\n\nâŒ **INCORRECT** : \"Traite l'anxiÃ©tÃ©\"\nâœ… **CORRECT** : \"Favorise la relaxation et le bien-Ãªtre mental\"\n\nâŒ **INCORRECT** : \"Anti-stress\"\nâœ… **CORRECT** : \"Aide Ã  faire face au stress passager\"\n\n## âš–ï¸ MENTIONS OBLIGATOIRES\n\nSur tous les contenus marketing :\n\n1. \"Les complÃ©ments alimentaires ne se substituent pas Ã  une alimentation variÃ©e et Ã©quilibrÃ©e ni Ã  un mode de vie sain.\"\n\n2. Ne pas dÃ©passer la dose journaliÃ¨re recommandÃ©e.\n\n3. Tenir hors de portÃ©e des enfants.\n\n4. Demander l'avis d'un professionnel de santÃ© en cas de grossesse, allaitement ou traitement mÃ©dical.\n\n## ğŸš« CAS PARTICULIERS\n\n### Perte de Poids\n\nâŒ **INTERDIT** : \"Fait maigrir\", \"BrÃ»le les graisses\", \"Perte de poids rapide\"\nâœ… **AUTORISÃ‰** : \"Peut accompagner un rÃ©gime alimentaire\" (avec conditions)\n\n### CholestÃ©rol\n\nâŒ **INTERDIT** : \"RÃ©duit le cholestÃ©rol\"\nâœ… **AUTORISÃ‰** : \"Contribue au maintien d'un taux de cholestÃ©rol normal\" (pour certains ingrÃ©dients spÃ©cifiques uniquement)\n\n### Articulations\n\nâŒ **INTERDIT** : \"Anti-inflammatoire\", \"Soulage l'arthrose\"\nâœ… **AUTORISÃ‰** : \"Contribue au confort articulaire\" (avec conditions)\n\n## ğŸ“š RESSOURCES OFFICIELLES\n\n- RÃ¨glement UE 432/2012\n- Base de donnÃ©es EFSA des allÃ©gations autorisÃ©es\n- DGCCRF - Direction GÃ©nÃ©rale de la Concurrence, de la Consommation et de la RÃ©pression des Fraudes\n\n## âœ… CHECKLIST CONFORMITÃ‰\n\nAvant publication, vÃ©rifier :\n- [ ] Aucune allÃ©gation thÃ©rapeutique\n- [ ] Aucun terme mÃ©dical interdit\n- [ ] Utilisation exclusive des verbes autorisÃ©s\n- [ ] Mentions lÃ©gales prÃ©sentes\n- [ ] Pas de promesses de guÃ©rison\n- [ ] Pas de rÃ©fÃ©rences Ã  des maladies spÃ©cifiques\n- [ ] Formulations uniquement positives et nuancÃ©es\n```\n## PAS D'EMOJI DANS LE TEXTE\n"
        }
      },
      "id": "904aa1e6-adb6-4b3e-971f-f21f8a8018f9",
      "name": "AI Agent RÃ©daction",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        37472,
        89952
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\nreturn [{\n  json: {\n    article_id: data.id,\n    topic: data.topic,\n    parameters: data.parameters,\n    toc: data.table_of_contents,\n    user_id: data.user_id\n  }\n}];"
      },
      "id": "92762687-9a1b-4251-af34-76edff136913",
      "name": "Merge Validated TOC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37248,
        89952
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('4. Read Supabase Validated').item.json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        38784,
        90288
      ],
      "id": "8526e48b-bcec-4bf1-a8fe-2ef75347de24",
      "name": "Simple Memory4"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('4. Read Supabase Validated').item.json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        38208,
        90288
      ],
      "id": "10d2e484-159b-46a2-80c5-dbadb05deb5e",
      "name": "Simple Memory3"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('4. Read Supabase Validated').item.json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        37632,
        90288
      ],
      "id": "5d8d31ef-1bd0-4b98-9b97-b07e3bdfe906",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Parse Article Data').item.json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        38368,
        89312
      ],
      "id": "5df27490-1b16-48c7-a86c-a0ad01a1aaf7",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        38208,
        89312
      ],
      "id": "ba30687b-cc39-4c59-bd55-683f7a593a72",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un planificateur de contenu expert.\n\n## MISSION\nCrÃ©e une Table des MatiÃ¨res (TOC) structurÃ©e et dÃ©taillÃ©e pour l'article suivant.\n\n## CONTEXTE\n**Sujet** : {{ $json.article.prompt }}\n**Langue** : {{ $json.article.language }}\n**Tone** : {{ $json.article.tone }}\n**Longueur cible** : {{ $json.article.target_length }} mots\n\n## RECHERCHE EFFECTUÃ‰E\n{{ JSON.stringify($json.research, null, 2) }}\n\n## FORMAT ATTENDU\nGÃ©nÃ¨re un JSON avec cette structure EXACTE :\n{\n  \"plan_options\": {\n    \"titles\": [\"Titre 1\", \"Titre 2\", \"Titre 3\", \"Titre 4\"],\n    \"axes\": [\"Axe 1: Description\", \"Axe 2: Description\", \"Axe 3: Description\", \"Axe 4: Description\"]\n  },\n  \"toc\": {\n    \"title\": \"Titre principal par dÃ©faut\",\n    \"sections\": [\n      {\n        \"id\": \"section_1\",\n        \"title\": \"Introduction\",\n        \"subsections\": [\n          { \"id\": \"section_1_1\", \"title\": \"Sous-section 1\" }\n        ]\n      }\n    ]\n  }\n}\n\nImportant : Les 4 axes doivent reprÃ©senter des orientations thÃ©matiques diffÃ©rentes du sujet. \nL'agent doit impÃ©rativement retourner la liste complÃ¨te des sources (liens) qui lui ont servi pour rÃ©diger l'article dans le champ \"sources\".",
        "options": {
          "systemMessage": "Tu es expert en structuration de contenu. Tu crÃ©es des plans d'articles clairs et logiques."
        }
      },
      "id": "e4d8d9a9-bbca-4dd5-9f0d-b35b9d3a6586",
      "name": "AI Agent Planificateur",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        38256,
        88976
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.toolSerpApi",
      "typeVersion": 1,
      "position": [
        37808,
        89312
      ],
      "id": "822006fa-cf4c-45ca-8e35-82dd62ece938",
      "name": "SerpAPI",
      "credentials": {
        "serpApi": {
          "id": "3GoOe55QxfAh7Nbh",
          "name": "SerpAPI account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent de recherche expert spÃ©cialisÃ© dans la crÃ©ation de contenu web optimisÃ©.\n\n## CONTEXTE\n**Sujet** : {{ $json.article.prompt || $('Read Supabase').item.json.topic }}\n**Langue** : {{ $json.article.language }}\n**Ton** : {{ $json.article.tone }}\n\n{{ $json.article.attached_files && $json.article.attached_files.length > 0 ? '## LIENS FOURNIS EN ENTRÃ‰E\\nL\\'utilisateur a fourni ces liens de dÃ©part (tu DOIS les utiliser) :\\n' + JSON.stringify($json.article.attached_files, null, 2) : '' }}\n\n## WORKFLOW OBLIGATOIRE EN 4 Ã‰TAPES\n\n### Ã‰TAPE 1 : RECHERCHE WEB AVEC SERPAPI (OBLIGATOIRE)\n**Outil** : SerpAPI\n\n**IMPORTANT** : Tu dois EXTRAIRE les URLs des rÃ©sultats de recherche.\n\n**Actions** :\n1. Effectue 8-10 recherches Google diffÃ©rentes sur le sujet\n2. **Pour CHAQUE rÃ©sultat de recherche** :\n   - Extrais l'URL (champ \"link\" dans les rÃ©sultats SerpAPI)\n   - Extrais le titre (champ \"title\")\n   - Note la description (champ \"snippet\")\n3. **Compile une liste de 10-20 URLs uniques** trouvÃ©es via SerpAPI\n\n**Format des rÃ©sultats SerpAPI** :\nLes rÃ©sultats SerpAPI contiennent un tableau \"organic_results\" avec :\n- \"link\": l'URL de la page\n- \"title\": le titre\n- \"snippet\": la description\n\n**Tu DOIS** :\n- Extraire le champ \"link\" de CHAQUE rÃ©sultat\n- CrÃ©er une liste \"urls_found_serpapi\" avec ces URLs\n- Ne pas dupliquer les URLs dÃ©jÃ  prÃ©sentes dans les liens d'entrÃ©e\n\n**RÃ©sultat attendu** : Liste de 10-20 URLs **NOUVELLES** trouvÃ©es via SerpAPI\n\n---\n\n### Ã‰TAPE 2 : MERGER LES SOURCES\nCrÃ©e une liste complÃ¨te des URLs Ã  scraper :\n- Les URLs trouvÃ©es via SerpAPI (Ã‰TAPE 1)\n- {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? '+ Les URLs fournies en entrÃ©e : ' + JSON.stringify($json.article.attached_files) : '' }}\n\n**Total attendu** : {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? ($json.article.attached_files.length + ' (fournis) + 10-20 (trouvÃ©s) = 14-24 URLs') : '10-20 URLs' }}\n\n---\n\n### Ã‰TAPE 3 : SCRAPING AVEC FIRECRAWL (OBLIGATOIRE)\n**Outil** : FireCrawl\n\n**Actions** :\n1. Scrappe {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'TOUS les liens (fournis + trouvÃ©s)' : 'les 8-12 meilleurs liens trouvÃ©s' }}\n2. Extrais le contenu complet :\n   - Texte principal\n   - Titres H1/H2/H3\n   - Statistiques et chiffres\n   - Listes importantes\n\n**RÃ©sultat** : Contenu de {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'tous les liens' : '8-12 sources' }}\n\n---\n\n### Ã‰TAPE 4 : ANALYSE ET SYNTHÃˆSE\nExtrais :\n- **Concepts clÃ©s** (5-7)\n- **Mots-clÃ©s SEO** (primaires, secondaires, longue traÃ®ne)\n- **Points importants** (8-12)\n- **Statistiques clÃ©s**\n- **Angles uniques**\n- **Questions frÃ©quentes**\n- **TOUTES LES SOURCES UTILISÃ‰ES** (avec dÃ©tails)\n\n---\n\n## FORMAT DE SORTIE JSON\n\nRetourne UNIQUEMENT ce JSON (sans markdown, sans backticks) :\n\n{\n  \"search_performed\": {\n    \"serpapi_queries\": [\n      \"RequÃªte exacte 1\",\n      \"RequÃªte exacte 2\",\n      ...\n    ],\n    \"urls_found_serpapi\": [\n      \"URL 1 extraite de SerpAPI (champ link)\",\n      \"URL 2 extraite de SerpAPI (champ link)\",\n      \"URL 3 extraite de SerpAPI (champ link)\",\n      ... (10-20 URLs)\n    ],\n    \"urls_input\": {{ $json.article.attached_files ? JSON.stringify($json.article.attached_files) : '[]' }},\n    \"urls_scraped\": [\n      \"TOUTES les URLs scrappÃ©es avec FireCrawl\"\n    ],\n    \"total_sources\": \"Nombre total\"\n  },\n  \"key_concepts\": [...],\n  \"seo_keywords\": {...},\n  \"important_points\": [...],\n  \"key_statistics\": [...],\n  \"unique_angles\": [...],\n  \"common_questions\": [...],\n  \"sources\": [\n    {\n      \"url\": \"URL complÃ¨te\",\n      \"title\": \"Titre\",\n      \"authority\": \"high/medium/low\",\n      \"publish_date\": \"Date\",\n      \"key_insight\": \"Insight\",\n      \"source_type\": \"input ou serpapi\"\n    }\n  ],\n  \"sources_summary\": \"SynthÃ¨se\"\n}\n\nâš ï¸ CRITIQUE : \"urls_found_serpapi\" NE PEUT PAS ÃŠTRE VIDE\nâš ï¸ Il doit contenir 10-20 URLs extraites des rÃ©sultats SerpAPI\nâš ï¸ Format : [\"https://...\", \"https://...\", ...]\n---\n\n## RÃˆGLES CRITIQUES\n\nâš ï¸ **TOUJOURS UTILISER SERPAPI** mÃªme si des liens sont fournis\nâš ï¸ **SCRAPPER TOUT** : liens fournis + liens trouvÃ©s\nâš ï¸ **LISTER TOUTES LES SOURCES** dans le JSON final avec \"source_type\"\nâš ï¸ Le champ \"urls_scraped\" doit contenir {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'TOUS les liens (fournis + trouvÃ©s)' : 'tous les liens trouvÃ©s' }}\n\nSi tu ne retournes pas TOUTES les sources avec leur type (input/serpapi), ta rÃ©ponse est INVALIDE.",
        "options": {
          "systemMessage": "Tu es un expert en recherche mÃ©thodique d'information et veille stratÃ©gique.\n\nRÃˆGLE ABSOLUE : Tu DOIS utiliser SerpAPI ET FireCrawl dans l'ordre.\n\nWORKFLOW OBLIGATOIRE :\n1. SerpAPI â†’ Extraire les URLs des rÃ©sultats (champ \"link\")\n2. FireCrawl â†’ Scraper ces URLs\n3. Analyse â†’ SynthÃ©tiser\n\nEXTRACTION DES URLS SERPAPI :\nQuand tu utilises SerpAPI, les rÃ©sultats contiennent \"organic_results\" avec des objets ayant :\n- \"link\": l'URL (TU DOIS l'extraire)\n- \"title\": le titre\n- \"snippet\": la description\n\nTu DOIS extraire le champ \"link\" et l'ajouter Ã  \"urls_found_serpapi\".\n\nSi \"urls_found_serpapi\" est vide dans ton JSON final, ta rÃ©ponse est INVALIDE.",
          "maxIterations": 10,
          "returnIntermediateSteps": true,
          "passthroughBinaryImages": true
        }
      },
      "id": "a33d2376-d9c5-4f21-a0ec-692e9281c441",
      "name": "AI Agent Recherche",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        37504,
        88976
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "Extract",
        "operation": "extract",
        "prompt": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Prompt', ``, 'string') }}",
        "schema": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Schema', ``, 'json') }}",
        "includeSubdomains": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Include_Subdomains', ``, 'boolean') }}",
        "enableWebSearch": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Enable_Web_Search', ``, 'boolean') }}",
        "showSources": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Show_Sources', ``, 'boolean') }}",
        "additionalFields": {},
        "useCustomBody": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Use_Custom_Body', ``, 'boolean') }}",
        "customBody": "{\n  \"prompt\": \"Find the founders of Firecrawl\",\n  \"urls\": [\"https://firecrawl.dev\"],\n  \"schema\": {\n    \"type\": \"object\",\n    \"properties\": {\n      \"founders\": {\n        \"type\": \"array\",\n        \"items\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"name\": { \"type\": \"string\" },\n            \"role\": { \"type\": \"string\" }\n          }\n        }\n      }\n    }\n  }\n}",
        "requestOptions": {}
      },
      "type": "@mendable/n8n-nodes-firecrawl.firecrawlTool",
      "typeVersion": 1,
      "position": [
        37648,
        89312
      ],
      "id": "655200c7-c915-4cfe-b503-a71249c8a454",
      "name": "firecrawl_scrape_url",
      "credentials": {
        "firecrawlApi": {
          "id": "TNLR8pTeTQPtJ3hW",
          "name": "Firecrawl account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        37136,
        89312
      ],
      "id": "3628f541-ab92-4cbc-9a60-c53a38839755",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        37280,
        89312
      ],
      "id": "2cc527a2-cf81-4b7a-9f4b-c63859794a61",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('File', ``, 'string') }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTool",
      "typeVersion": 3,
      "position": [
        37456,
        89312
      ],
      "id": "321ad929-3bf2-4ada-b668-63d11d8e1a65",
      "name": "Download file in Google Drive",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "WrL0mjocn3lGJtNI",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        38624,
        90288
      ],
      "id": "0540ed64-7e2b-491c-8767-863f6844ba4a",
      "name": "Google Gemini Chat Model4",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        38048,
        90288
      ],
      "id": "ab9b3ebb-c0bf-471e-8cc6-bc78f1d23ae6",
      "name": "Google Gemini Chat Model3",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        37472,
        90288
      ],
      "id": "bf1dd3c5-3c76-490a-9e56-f7a46da45c0f",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "2NfiMV7vGBhhdclG",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst article = data.output || JSON.stringify(data);\n\n// Extraire le titre (premiÃ¨re ligne commenÃ§ant par #)\nconst titleMatch = article.match(/^#\\s+(.+)$/m);\nconst title = titleMatch ? titleMatch[1] : 'Sans titre';\n\n// Compter les mots\nconst wordCount = article.split(/\\s+/).length;\n\nreturn [{\n  json: {\n    generated_article: article,\n    title: title,\n    word_count: wordCount\n  }\n}];"
      },
      "id": "4567b7ac-b23b-4fe5-b266-a6b26c410633",
      "name": "5. Parse Generated Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37824,
        89904
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "fe732820-b12e-4e97-a487-a9c49c969998",
      "name": "4. Read Supabase Validated",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        37024,
        89952
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'processing_with_toc',\n  article_id: $json.article_id,\n  message: 'TOC validated. Starting article generation.'\n} }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "6a2b25af-7d82-4049-baf4-30f116e59145",
      "name": "Response Validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        37024,
        89760
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\n\nif (!body.article_id) {\n  throw new Error('article_id is required');\n}\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    validated_toc: body.validated_toc || null,\n    user_modified: !!body.validated_toc,\n    retry_count: 0,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "96d7f85f-7b53-4113-b410-62f56d202558",
      "name": "Parse Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36800,
        89856
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/validate-toc",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "08f91607-6578-4593-bfb5-46c502f1ea55",
      "name": "Webhook Validate TOC",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        36576,
        89856
      ],
      "webhookId": "validate-toc"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nreturn [{\n  json: {\n    article_id: input.id,\n    status: input.status,\n    table_of_contents: input.table_of_contents,\n    message: 'Article en attente de validation du sommaire'\n  },\n  pairedItem: 0\n}];"
      },
      "id": "956e5181-28ba-49b4-825e-4c3a8f1ec1a7",
      "name": "PAUSE - Waiting Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        39264,
        88976
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Parse Webhook').item.json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.toc }}"
            },
            {
              "fieldId": "plan_options",
              "fieldValue": "={{ $json.plan_options }}"
            },
            {
              "fieldId": "sources",
              "fieldValue": "={{ $('Parse Research Output').item.json.all_sources }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "waiting_validation"
            },
            {
              "fieldId": "search_synthesis",
              "fieldValue": "={{ $('Parse Research Output').item.json.research }}"
            }
          ]
        }
      },
      "id": "0dafd207-eebe-4753-8dd7-abe6092b35d6",
      "name": "3. Update Supabase TOC",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        38912,
        88976
      ],
      "credentials": {
        "supabaseApi": {
          "id": "wsR97aCnWHDWGEIK",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst output = data.output || JSON.stringify(data);\nconst match = output.match(/\\{[\\s\\S]*\\}/);\nconst rawJson = match ? JSON.parse(match[0]) : { toc: { title: 'Sans titre', sections: [] } };\n\nreturn [{\n  json: {\n    toc: rawJson.toc || { title: 'Sans titre', sections: [] },\n    plan_options: rawJson.plan_options || null,\n    sources: rawJson.sources || []\n  }\n}];\n"
      },
      "id": "01290e52-6ffd-4937-95b6-97879fc0c7c4",
      "name": "Parse TOC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        38608,
        88976
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst output = data.output || JSON.stringify(data);\n\nconsole.log('=== PARSE RESEARCH OUTPUT ===');\n\n// Extraire le JSON\nconst match = output.match(/\\{[\\s\\S]*\\}/);\nconst research = match ? JSON.parse(match[0]) : {\n  key_concepts: [],\n  seo_keywords: {},\n  important_points: [],\n  sources: [],\n  sources_summary: ''\n};\n\n// VÃ©rification STRICTE\nconst serpapiUrls = research.search_performed?.urls_found_serpapi || [];\nconst serpapiQueries = research.search_performed?.serpapi_queries || [];\n\nif (serpapiQueries.length > 0 && serpapiUrls.length === 0) {\n  console.error('âŒ ERREUR CRITIQUE : SerpAPI a fait des recherches mais n\\'a extrait AUCUNE URL');\n  console.error('Queries:', serpapiQueries);\n  console.error('URLs trouvÃ©es:', serpapiUrls);\n  throw new Error('L\\'agent n\\'a pas extrait les URLs des rÃ©sultats SerpAPI. Relancer le workflow.');\n}\n\nconst inputUrls = research.search_performed?.urls_input || [];\nconst allUrls = research.search_performed?.urls_scraped || [];\nconst allSources = research.sources || [];\n\nconsole.log('ğŸ“Š SOURCES:');\nconsole.log('âœ… RequÃªtes SerpAPI:', serpapiQueries.length);\nconsole.log('âœ… URLs trouvÃ©es via SerpAPI:', serpapiUrls.length);\nconsole.log('âœ… URLs fournies en entrÃ©e:', inputUrls.length);\nconsole.log('âœ… Total scrappÃ©:', allUrls.length);\nconsole.log('âœ… Sources dÃ©taillÃ©es:', allSources.length);\n\nreturn [{\n  json: {\n    research: research,\n    all_sources: allSources,\n    urls_count: {\n      input: inputUrls.length,\n      serpapi: serpapiUrls.length,\n      total_scraped: allUrls.length\n    }\n  }\n}];\n```\n\n---\n\n## ğŸ¯ Exemple de ce que l'agent DEVRAIT faire\n\n**Ã‰tape 1 : SerpAPI**\n```\nQuery: \"amour mÃ©decine traditionnelle chinoise Saint-Valentin\"\nRÃ©sultats:\n[\n  { \"link\": \"https://site1.com/article1\", \"title\": \"...\" },\n  { \"link\": \"https://site2.com/article2\", \"title\": \"...\" },\n  { \"link\": \"https://site3.com/article3\", \"title\": \"...\" }\n]"
      },
      "id": "953c5482-4525-4800-804f-99fde45adba5",
      "name": "Parse Research Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37824,
        88976
      ]
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst originalData = $('Parse Webhook').first().json;\n\nreturn {\n  json: {\n    ...originalData,\n    article: {\n      id: article.id,\n      title: article.title,\n      prompt: article.prompt,\n      language: article.language || 'FR',\n      tone: article.tone || 'educational',\n      target_length: article.target_length || 2000,\n      attached_files: article.attached_files || [],\n      user_preferences: article.user_preferences || {}\n    }\n  }\n};"
      },
      "id": "1858c682-d41f-4bca-ade0-8a777399059f",
      "name": "Parse Article Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37248,
        88976
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'processing',\n  article_id: $json.article_id,\n  message: 'Article generation started'\n} }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "f8203811-f744-41bc-880f-402972cc73ce",
      "name": "Response 202",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        37024,
        88784
      ]
    },
    {
      "parameters": {
        "jsCode": "\nconst input = $input.item.json;\nconst body = input.body || input;\n\nconsole.log('=== DEBUG WEBHOOK ===');\nconsole.log('Input:', JSON.stringify(input, null, 2));\n\nconst article_id = body.article_id;\n\nif (!article_id) {\n  throw new Error('âŒ article_id is REQUIRED. Received: ' + JSON.stringify(input));\n}\n\n// Validation UUID\nconst uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\nif (!uuidRegex.test(article_id)) {\n  throw new Error('âŒ article_id must be a valid UUID. Got: ' + article_id);\n}\n\n// Extract topic/prompt for regeneration\n// The frontend sends \"topic\" as the regeneration instruction\nconst topic = body.topic || body.prompt;\n\nconsole.log('âœ… Valid article_id:', article_id);\nif (topic) console.log('âœ… Found topic/prompt override');\n\nreturn {\n  json: {\n    article_id: article_id,\n    user_id: body.user_id || null,\n    topic: topic, // PASS THROUGH THE TOPIC\n    language: body.language || body.target_language || 'french',\n    parameters: body.parameters || {},\n    retry_count: 0,\n    timestamp: new Date().toISOString()\n  }\n};\n"
      },
      "id": "ddf2fdaa-35fa-467f-80c4-29dcef8215f3",
      "name": "Parse Webhook",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36800,
        88880
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/generate",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "7a9df61c-b6fb-4a25-b149-fc44f36bafb4",
      "name": "Webhook Start",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        36576,
        88880
      ],
      "webhookId": "start-generation"
    },
    {
      "parameters": {
        "content": "# MODIFICATION TOC/ARTICLE\n",
        "height": 1312,
        "width": 2576
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        36800,
        90976
      ],
      "typeVersion": 1,
      "id": "8396b939-4432-4ffd-96f9-8f5d9d1e0217",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# TRANSLATE",
        "height": 1312,
        "width": 3088,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        36560,
        92480
      ],
      "typeVersion": 1,
      "id": "7a8d198e-9fe5-4f1f-b6e1-291b0fe98322",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "# NOUVELLE TOC / ARTICLE ",
        "height": 2176,
        "width": 6016,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        36096,
        88544
      ],
      "typeVersion": 1,
      "id": "b455085e-e61f-4e9d-9904-fe446e36d909",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst modifyRequest = $('Parse Modify Plan').first().json;\n\nconsole.log('ğŸ“„ PrÃ©paration modification:');\nconsole.log('- Article ID:', article.id);\nconsole.log('- TOC actuel:', !!article.table_of_contents);\nconsole.log('- Fichiers joints:', modifyRequest.attached_files.length);\n\n// PrÃ©parer le contexte des fichiers joints\nlet filesContext = '';\nif (modifyRequest.attached_files && modifyRequest.attached_files.length > 0) {\n  filesContext = '\\n\\n## FICHIERS JOINTS FOURNIS PAR L\\'UTILISATEUR\\n';\n  filesContext += 'L\\'utilisateur a fourni ces documents de rÃ©fÃ©rence :\\n';\n  modifyRequest.attached_files.forEach((file, index) => {\n    filesContext += `${index + 1}. ${file.name || file.url}\\n`;\n    filesContext += `   URL: ${file.url}\\n`;\n    if (file.type) filesContext += `   Type: ${file.type}\\n`;\n  });\n  filesContext += '\\nNote: Utilise ces fichiers comme rÃ©fÃ©rence pour les modifications si pertinent.\\n';\n}\n\nreturn [{\n  json: {\n    article_id: article.id,\n    table_of_contents: article.table_of_contents,\n    content: article.content,\n    topic: article.topic,\n    sources: article.sources || [],\n    modification_request: modifyRequest.modification_request,\n    attached_files: modifyRequest.attached_files,\n    files_context: filesContext\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37840,
        91168
      ],
      "id": "6ce18ccc-a46f-465f-bb6d-27889c5d78eb",
      "name": "Preparer Modification"
    }
  ],
  "connections": {
    "Set Translating Status": {
      "main": [
        [
          {
            "node": "Read Article Translate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Traduction": {
      "main": [
        [
          {
            "node": "AI Translator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory7": {
      "ai_memory": [
        [
          {
            "node": "AI Translator",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory6": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Modifier Article",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory5": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Modifier Plan",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Parse Translated Content": {
      "main": [
        [
          {
            "node": "Update Translated Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Translate": {
      "ai_languageModel": [
        [
          {
            "node": "AI Translator",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Translator": {
      "main": [
        [
          {
            "node": "Parse Translated Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Article Translate": {
      "main": [
        [
          {
            "node": "Preparer Traduction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Translate Request": {
      "main": [
        [
          {
            "node": "Response Translate",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set Translating Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Translate": {
      "main": [
        [
          {
            "node": "Parse Translate Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Modified Content": {
      "main": [
        [
          {
            "node": "Response Modify Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse New Content": {
      "main": [
        [
          {
            "node": "Update Modified Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Modify Article": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Modifier Article",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Modifier Article": {
      "main": [
        [
          {
            "node": "Parse New Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Article Modify Content": {
      "main": [
        [
          {
            "node": "AI Agent Modifier Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Modify Article": {
      "main": [
        [
          {
            "node": "Read Article Modify Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Modify Article": {
      "main": [
        [
          {
            "node": "Parse Modify Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Modified TOC": {
      "main": [
        [
          {
            "node": "Response Modify Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse New TOC": {
      "main": [
        [
          {
            "node": "Update Modified TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Modify Plan": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Modifier Plan",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Modifier Plan": {
      "main": [
        [
          {
            "node": "Parse New TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Article Modify": {
      "main": [
        [
          {
            "node": "Preparer Modification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Modify Plan": {
      "main": [
        [
          {
            "node": "Read Article Modify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Modify Plan": {
      "main": [
        [
          {
            "node": "Parse Modify Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verification": {
      "main": [
        [
          {
            "node": "AI Agent Planificateur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Supabase": {
      "main": [
        [
          {
            "node": "Parse Article Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Google Drive": {
      "main": [
        [
          {
            "node": "Update Supabase Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Ã‰valuateur": {
      "main": [
        [
          {
            "node": "Parse Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PrÃ©parer pour upload": {
      "main": [
        [
          {
            "node": "Upload Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Google Doc": {
      "main": [
        [
          {
            "node": "Convertir Markdown â†’ HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalisation Prep": {
      "main": [
        [
          {
            "node": "Format Google Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Retry (Loop)": {
      "main": [
        [
          {
            "node": "AI Agent RÃ©daction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Retry Loop": {
      "main": [
        [
          {
            "node": "Increment Retry (Loop)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Finalisation Prep",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Evaluation": {
      "main": [
        [
          {
            "node": "Check Retry Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Supabase Final": {
      "main": [
        [
          {
            "node": "Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convertir Markdown â†’ HTML": {
      "main": [
        [
          {
            "node": "PrÃ©parer pour upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Optimized Article": {
      "main": [
        [
          {
            "node": "AI Agent Ã‰valuateur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Optimisation": {
      "main": [
        [
          {
            "node": "Parse Optimized Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent RÃ©daction": {
      "main": [
        [
          {
            "node": "5. Parse Generated Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Validated TOC": {
      "main": [
        [
          {
            "node": "AI Agent RÃ©daction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory4": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Ã‰valuateur",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory3": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Optimisation",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent RÃ©daction",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Planificateur",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Planificateur",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Planificateur": {
      "main": [
        [
          {
            "node": "Parse TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SerpAPI": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Recherche": {
      "main": [
        [
          {
            "node": "Parse Research Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "firecrawl_scrape_url": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Download file in Google Drive": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Ã‰valuateur",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Optimisation",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent RÃ©daction",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "5. Parse Generated Article": {
      "main": [
        [
          {
            "node": "AI Agent Optimisation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. Read Supabase Validated": {
      "main": [
        [
          {
            "node": "Merge Validated TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Validation": {
      "main": [
        [
          {
            "node": "4. Read Supabase Validated",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Validate TOC": {
      "main": [
        [
          {
            "node": "Parse Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Update Supabase TOC": {
      "main": [
        [
          {
            "node": "PAUSE - Waiting Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse TOC": {
      "main": [
        [
          {
            "node": "3. Update Supabase TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Research Output": {
      "main": [
        [
          {
            "node": "Verification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Article Data": {
      "main": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook": {
      "main": [
        [
          {
            "node": "Read Supabase",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response 202",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Start": {
      "main": [
        [
          {
            "node": "Parse Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Modification": {
      "main": [
        [
          {
            "node": "AI Agent Modifier Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "27d8ac9fa8374675383d394ebac973685d6c9244c45e4e9460569139fe28fd97"
  }
}