{
  "nodes": [
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Parse Translate Request').item.json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "translation_status",
              "fieldValue": "translating"
            }
          ]
        }
      },
      "id": "3a88c13d-1103-4476-9558-74ff639228a4",
      "name": "Set Translating Status",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3280,
        7632
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst translateRequest = $('Parse Translate Request').first().json;\n\nconsole.log('=== PREPARER TRADUCTION ===');\nconsole.log('Article ID:', article.id);\nconsole.log('Target language:', translateRequest.target_language);\n\n// Validation\nif (!article || !article.id) {\n  console.error(' Article vide ou sans ID');\n  throw new Error('Article not found');\n}\n\nif (!translateRequest || !translateRequest.article_id) {\n  console.error(' Requête de traduction invalide');\n  throw new Error('Translation request invalid');\n}\n\n// PASSER TOUTES LES DONNÉES (le Merge les fusionnera avec l'output de l'AI)\nconst result = {\n  id: article.id,\n  article_id: translateRequest.article_id,\n  topic: article.topic || '',\n  content: article.content || '',\n  table_of_contents: article.table_of_contents || {},\n  plan_options: article.plan_options || {},\n  search_synthesis: article.search_synthesis || {},\n  evaluation_details: article.evaluation_details || {},\n  parameters: article.parameters || {},\n  score: article.score || 0,\n  drive_link: article.drive_link || '',\n  target_language: translateRequest.target_language || 'fr'\n};\n\nconsole.log(' Données préparées');\nconsole.log('- Article ID:', result.article_id);\nconsole.log('- Target language:', result.target_language);\nconsole.log('- Content length:', result.content.length);\n\nreturn [{\n  json: result\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3792,
        7632
      ],
      "id": "de00f9cc-fa40-4d8c-9319-77d9e6a82dd4",
      "name": "Preparer Traduction"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3872,
        5520
      ],
      "id": "182883d4-f9f5-4e6d-a51f-9ab5ff5b9203",
      "name": "Simple Memory6"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4112,
        4864
      ],
      "id": "d309e937-9554-4bf4-b89c-b7af5591d48d",
      "name": "Simple Memory5"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'processing', message: 'Translation started' } }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "fb5fdd29-1d4b-47f6-bd92-c07245ad11ac",
      "name": "Response Translate",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3456,
        7344
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Read Article Translate').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "topic",
              "fieldValue": "={{ $json.translated_topic }}"
            },
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.translated_toc }}"
            },
            {
              "fieldId": "plan_options",
              "fieldValue": "={{ $json.translated_plan_options }}"
            },
            {
              "fieldId": "search_synthesis",
              "fieldValue": "={{ $json.translated_search_synthesis }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ $json.translated_evaluation_details }}"
            },
            {
              "fieldId": "drive_link",
              "fieldValue": "={{ $('Read Article Translate').item.json.drive_link }}"
            },
            {
              "fieldId": "translation_status",
              "fieldValue": "completed"
            },
            {
              "fieldId": "parameters",
              "fieldValue": "={{ JSON.stringify({ ...$json.parameters, language: $json.new_language }) }}"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.docContent }}"
            }
          ]
        }
      },
      "id": "90497416-de53-4694-8ccb-72118a6b77b5",
      "name": "Update Translated Article",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5328,
        7632
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nconsole.log('=== PARSE TRANSLATED CONTENT ===');\nconsole.log(' Input keys:', Object.keys(input));\n\n// Vérification des données fusionnées par Merge\nif (!input.article_id) {\n  console.error(' article_id manquant après Merge');\n  console.error('Input complet:', JSON.stringify(input, null, 2));\n  throw new Error('article_id missing - Merge failed');\n}\n\nif (!input.output) {\n  console.error(' AI output manquant après Merge');\n  console.error('Input complet:', JSON.stringify(input, null, 2));\n  throw new Error('AI output missing - AI Translator failed');\n}\n\nconsole.log(' Données fusionnées reçues');\nconsole.log('- article_id:', input.article_id);\nconsole.log('- target_language:', input.target_language);\nconsole.log('- output length:', input.output.length);\n\nlet translatedData = {};\nlet cleanJson = '';\n\ntry {\n  const output = input.output;\n  \n  console.log(' Output preview (1000 chars):');\n  console.log(output.substring(0, 1000));\n  \n  // MÉTHODE 1 : Extraire entre ```json et ```\n  const jsonBlockMatch = output.match(/```json\\s*\\n([\\s\\S]*?)\\n\\s*```/);\n  \n  if (jsonBlockMatch) {\n    cleanJson = jsonBlockMatch[1].trim();\n    console.log(' JSON extrait des blocs markdown (méthode 1)');\n  } else {\n    // MÉTHODE 2 : Entre ``` et ```\n    const codeBlockMatch = output.match(/```\\s*\\n?([\\s\\S]*?)\\n?\\s*```/);\n    \n    if (codeBlockMatch) {\n      cleanJson = codeBlockMatch[1].trim();\n      console.log(' JSON extrait des blocs code (méthode 2)');\n    } else {\n      // MÉTHODE 3 : Entre { et }\n      const startIdx = output.indexOf('{');\n      const endIdx = output.lastIndexOf('}');\n      \n      if (startIdx !== -1 && endIdx !== -1) {\n        cleanJson = output.substring(startIdx, endIdx + 1);\n        console.log(' JSON extrait entre accolades (méthode 3)');\n      } else {\n        throw new Error('Aucun JSON trouvé dans l\\'output');\n      }\n    }\n  }\n  \n  console.log(' Clean JSON length:', cleanJson.length);\n  console.log(' Clean JSON preview (500 chars):', cleanJson.substring(0, 500));\n  \n  // Parse\n  translatedData = JSON.parse(cleanJson);\n  console.log(' JSON parsé avec succès');\n  console.log(' Clés trouvées:', Object.keys(translatedData));\n  \n  // Vérifier que le contenu est en Markdown\n  if (translatedData.translated_content && translatedData.translated_content.includes('<!DOCTYPE html>')) {\n    console.warn(' Le contenu est en HTML au lieu de Markdown');\n  }\n  \n} catch (e) {\n  console.error(' Erreur parsing:', e.message);\n  console.error(' cleanJson preview (800 chars):', cleanJson.substring(0, 800));\n  \n  // FALLBACK : Utiliser les données originales (pas de traduction)\n  console.warn(' FALLBACK : Utilisation des données originales (pas de traduction)');\n  translatedData = {\n    translated_topic: input.topic,\n    translated_content: input.content,\n    translated_toc: input.table_of_contents,\n    translated_plan_options: input.plan_options,\n    translated_search_synthesis: input.search_synthesis,\n    translated_evaluation_details: input.evaluation_details\n  };\n}\n\n// Construction du résultat (input contient déjà tout grâce au Merge)\nconst result = {\n  article_id: input.article_id,\n  new_language: input.target_language,\n  translated_topic: translatedData.translated_topic || input.topic,\n  translated_content: translatedData.translated_content || input.content,\n  translated_toc: translatedData.translated_toc || input.table_of_contents,\n  translated_plan_options: translatedData.translated_plan_options || input.plan_options,\n  translated_search_synthesis: translatedData.translated_search_synthesis || input.search_synthesis,\n  translated_evaluation_details: translatedData.translated_evaluation_details || input.evaluation_details,\n  parameters: input.parameters,\n  score: input.score,\n  drive_link: input.drive_link\n};\n\nconsole.log('');\nconsole.log(' RÉSULTAT FINAL:');\nconsole.log('- article_id:', result.article_id);\nconsole.log('- new_language:', result.new_language);\nconsole.log('- translated_topic length:', result.translated_topic?.length || 0);\nconsole.log('- translated_content length:', result.translated_content?.length || 0);\nconsole.log('- Is Markdown?', result.translated_content?.includes('#') && !result.translated_content?.includes('<!DOCTYPE'));\n\n// Validation finale\nif (!result.article_id || result.article_id === 'unknown') {\n  console.error('article_id invalide');\n}\n\nif (!result.translated_content || result.translated_content.length < 100) {\n  console.error(' translated_content trop court ou vide');\n}\n\nreturn [{\n  json: result\n}];"
      },
      "id": "4cde1253-2c5d-4085-8962-572c431fc6e5",
      "name": "Parse Translated Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4784,
        7632
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4048,
        7968
      ],
      "id": "19dfcc17-5822-4cba-a5df-1c64d346d3c0",
      "name": "Gemini Translate",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Traduis TOUT en {{ $json.target_language === 'fr' ? 'français' : $json.target_language === 'en' ? 'anglais' : $json.target_language === 'zh' ? 'chinois' : $json.target_language }}.\n\nRÈGLES :\n1. Traduis le texte mais GARDE le formatage Markdown (#, ##, **, -, etc.)\n2. Pour les clés JSON comme \"titles\" et \"axes\", garde les noms en anglais\n3. Traduis uniquement le CONTENU des tableaux et objets\n4. Réponds avec UN SEUL JSON contenant toutes les traductions\n\nDONNÉES À TRADUIRE :\n\nSUJET :\n{{ $json.topic }}\n\nPLAN (TOC) - Traduis les titres, garde les IDs :\n{{ JSON.stringify($json.table_of_contents) }}\n\nOPTIONS PLAN - Traduis le contenu, garde \"titles\" et \"axes\" :\n{{ JSON.stringify($json.plan_options) }}\n\nRECHERCHE - Traduis keywords et concepts :\n{{ JSON.stringify($json.search_synthesis) }}\n\nÉVALUATION - Traduis critères et explications :\n{{ JSON.stringify($json.evaluation_details) }}\n\nCONTENU (MARKDOWN) :\n{{ $json.content }}\n\nRETOURNE CE JSON (commence directement par { et finis par }) :\n{\n  \"translated_topic\": \"...\",\n  \"translated_toc\": {...},\n  \"translated_plan_options\": {...},\n  \"translated_search_synthesis\": {...},\n  \"translated_evaluation_details\": {...},\n  \"translated_content\": \"# Titre...\\n\\n...\"\n}",
        "options": {
          "systemMessage": "Tu es un traducteur professionnel.\n\nTu réponds UNIQUEMENT avec un JSON valide. Aucun texte avant ou après le JSON."
        }
      },
      "id": "787f0432-828b-4e5f-b592-0259d55d7150",
      "name": "AI Translator",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4080,
        7632
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.id }}"
            }
          ]
        }
      },
      "id": "fa40bb73-8aed-4d10-82f5-50a9960eba03",
      "name": "Read Article Translate",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3504,
        7632
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst body = input.body || input;\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    target_language: body.target_language,\n    current_status: body.current_status || 'published', // Fallback to published if missing\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "4928f0ac-34e0-46ef-be5f-96761408e194",
      "name": "Parse Translate Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3056,
        7632
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/translate",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "09c0a019-682e-4558-a279-de02cb5f4c96",
      "name": "Webhook Translate",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2592,
        7632
      ],
      "webhookId": "translate"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { status: 'completed', article_id: $json.id, message: 'Article modifié avec succès' } }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "5cac4095-00e5-4280-b88a-4c28c35626b4",
      "name": "Response Modify Article",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        5232,
        5296
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Read Article Modify Content').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "content",
              "fieldValue": "={{ $('Formatage').item.json.html_document }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "completed"
            }
          ]
        }
      },
      "id": "614f58a7-df5a-4e0b-a756-6e2de1bca333",
      "name": "Update Modified Content",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5008,
        5296
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst previousData = $input.first().json;\n\nconst newContent = input.output || '';\n\nreturn [{\n  json: {\n    article_id: previousData.article_id,\n    new_content: newContent\n  }\n}];"
      },
      "id": "1b3a4da5-a84e-43fb-b9f7-95c74145b48b",
      "name": "Parse New Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4272,
        5296
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3728,
        5520
      ],
      "id": "b21918a7-ed30-49f1-81d4-21d9656a9dbe",
      "name": "Gemini Modify Article",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un rédacteur expert.\n\n## MISSION\nRéécris uniquement sans plus des parties de l'article suivant selon les instructions.\n\n## INSTRUCTIONS\n{{ $json.instructions }}\n\n## SELECTION DES SECTIONS À RÉÉCRIRE\n{{ $('Webhook Modify Article').item.json.body.instructions }}\n\n## ARTICLE ACTUEL\n{{ $json.content }}\n\n## FORMAT ATTENDU\nOptimise et réécris DIRECTEMENT l'article complet au format Markdown.",
        "options": {
          "systemMessage": "=Tu es un rédacteur talentueux, professionnel et expert qui améliore le contenu de haute qualité, bien structuré et engageant en restant fidèle au style initial sauf indication contraire.\n\n##  2. TCM KNOWLEDGE\n\n# Glossaire Ingrédients - Pharmacopée Chinoise\n\n## Plantes Toniques du Qi\n\n### Ginseng (Ren Shen 人参)\n- **Famille** : Araliacées\n- **Partie utilisée** : Racine\n- **Nature** : Tiède\n- **Saveur** : Douce, légèrement amère\n- **Méridiens** : Rate, Poumon, Cœur\n- **Actions traditionnelles** :\n  - Tonifie le Qi originel\n  - Renforce la Rate et le Poumon\n  - Génère les liquides organiques\n  - Calme l'Esprit (Shen)\n- **Utilisations** : Fatigue profonde, faiblesse après maladie, transpiration spontanée\n- **Principes actifs** : Ginsénosides (saponines triterpéniques)\n- **Dosage traditionnel** : 3-9g par jour\n\n### Astragale (Huang Qi 黄芪)\n- **Famille** : Fabacées\n- **Partie utilisée** : Racine\n- **Nature** : Tiède\n- **Saveur** : Douce\n- **Méridiens** : Rate, Poumon\n- **Actions traditionnelles** :\n  - Tonifie le Qi de la Rate\n  - Consolide le Wei Qi (énergie défensive)\n  - Favorise la montée du Yang\n  - Favorise la diurèse\n- **Utilisations** : Fatigue chronique, transpiration spontanée, œdèmes\n- **Principes actifs** : Polysaccharides, flavonoïdes\n- **Dosage traditionnel** : 9-30g par jour\n\n## Plantes Toniques du Sang\n\n### Angélique Chinoise (Dang Gui 当归)\n- **Famille** : Apiacées\n- **Partie utilisée** : Racine\n- **Nature** : Tiède\n- **Saveur** : Douce, piquante\n- **Méridiens** : Foie, Cœur, Rate\n- **Actions traditionnelles** :\n  - Tonifie et harmonise le Sang\n  - Active la circulation sanguine\n  - Lubrifie les intestins\n- **Utilisations** : Troubles menstruels, anémie, constipation\n- **Principes actifs** : Acide férulique, ligustilide\n- **Dosage traditionnel** : 6-12g par jour\n\n## Plantes Toniques du Yin\n\n### Lyciet (Gou Qi Zi 枸杞子)\n- **Famille** : Solanacées\n- **Partie utilisée** : Baie\n- **Nature** : Neutre\n- **Saveur** : Douce\n- **Méridiens** : Foie, Rein, Poumon\n- **Actions traditionnelles** :\n  - Tonifie le Foie et le Rein\n  - Nourrit le Sang et le Yin\n  - Éclaircit les yeux\n- **Utilisations** : Fatigue oculaire, vertiges, toux sèche\n- **Principes actifs** : Caroténoïdes, polysaccharides\n- **Dosage traditionnel** : 6-12g par jour\n\n## Champignons Médicinaux\n\n### Reishi (Ling Zhi 灵芝)\n- **Famille** : Ganodermatacées\n- **Partie utilisée** : Carpophore\n- **Nature** : Neutre\n- **Saveur** : Douce, légèrement amère\n- **Méridiens** : Cœur, Foie, Poumon, Rein\n- **Actions traditionnelles** :\n  - Tonifie le Qi\n  - Calme l'Esprit\n  - Soulage la toux\n  - Transforme les Glaires\n- **Utilisations** : Insomnie, anxiété, toux chronique\n- **Principes actifs** : Polysaccharides, triterpènes\n- **Dosage traditionnel** : 6-12g par jour\n\n### Cordyceps (Dong Chong Xia Cao 冬虫夏草)\n- **Famille** : Cordycipitacées\n- **Partie utilisée** : Sclérote + larve\n- **Nature** : Tiède\n- **Saveur** : Douce\n- **Méridiens** : Poumon, Rein\n- **Actions traditionnelles** :\n  - Tonifie les Reins\n  - Renforce le Poumon\n  - Arrête les saignements\n- **Utilisations** : Toux chronique, lombalgie, asthénie\n- **Principes actifs** : Cordycépine, polysaccharides\n- **Dosage traditionnel** : 5-10g par jour\n\n\n# Concepts Fondamentaux MTC\n\n## Le Qi (气)\n\n### Définition\nLe Qi est l'énergie vitale qui anime tous les êtres vivants. C'est une substance subtile en mouvement constant, à la base de toutes les fonctions physiologiques.\n\n### Types de Qi\n- **Yuan Qi** (气原) : Qi originel, hérité des parents\n- **Zong Qi** (宗气) : Qi ancestral, formé par la respiration et l'alimentation\n- **Wei Qi** (卫气) : Qi défensif, protège contre les agressions externes\n- **Ying Qi** (营气) : Qi nourricier, circule dans les méridiens\n\n### Fonctions du Qi\n1. **Transformation** : Transformation des aliments et des liquides\n2. **Transport** : Déplacement du Sang et des liquides\n3. **Protection** : Défense contre les pathogènes externes\n4. **Réchauffement** : Maintien de la température corporelle\n5. **Contention** : Maintien des organes et du Sang dans leurs circuits\n\n## Le Sang (Xue 血)\n\nLe Sang nourrit et hydrate tous les tissus du corps. Il circule dans les vaisseaux sous l'impulsion du Qi.\n\n### Relation Qi-Sang\n- \"Le Qi est le commandant du Sang\"\n- \"Le Sang est la mère du Qi\"\n\n## Le Yin et le Yang (阴阳)\n\n### Principe Fondamental\nTous les phénomènes peuvent être classés selon leur nature Yin ou Yang :\n\n**Yang** :\n- Chaud, actif, extérieur\n- Ascendant, lumineux\n- Fonction, énergie\n\n**Yin** :\n- Froid, passif, intérieur\n- Descendant, sombre\n- Matière, structure\n\n### Équilibre Yin-Yang\nLa santé repose sur l'équilibre dynamique entre Yin et Yang.\n\n## Les Cinq Éléments (Wu Xing 五行)\n\n### Bois (木 Mu)\n- Organe : Foie / Vésicule Biliaire\n- Saison : Printemps\n- Émotion : Colère\n- Saveur : Acide\n\n### Feu (火 Huo)\n- Organe : Cœur / Intestin Grêle\n- Saison : Été\n- Émotion : Joie\n- Saveur : Amère\n\n### Terre (土 Tu)\n- Organe : Rate / Estomac\n- Saison : Intersaison\n- Émotion : Réflexion\n- Saveur : Douce\n\n### Métal (金 Jin)\n- Organe : Poumon / Gros Intestin\n- Saison : Automne\n- Émotion : Tristesse\n- Saveur : Piquante\n\n### Eau (水 Shui)\n- Organe : Rein / Vessie\n- Saison : Hiver\n- Émotion : Peur\n- Saveur : Salée\n\n## Les Méridiens (经络 Jing Luo)\n\nLes méridiens sont les canaux dans lesquels circulent le Qi et le Sang, reliant les Organes aux tissus périphériques.\n\n### 12 Méridiens Principaux\n- Poumon (Tai Yin de la main)\n- Gros Intestin (Yang Ming de la main)\n- Estomac (Yang Ming du pied)\n- Rate (Tai Yin du pied)\n- Cœur (Shao Yin de la main)\n- Intestin Grêle (Tai Yang de la main)\n- Vessie (Tai Yang du pied)\n- Rein (Shao Yin du pied)\n- Maître du Cœur (Jue Yin de la main)\n- Triple Réchauffeur (Shao Yang de la main)\n- Vésicule Biliaire (Shao Yang du pied)\n- Foie (Jue Yin du pied)\n\n\n\n## 1. BRAND GUIDELINES\n\n# Voix de Marque Calebasse - Français\n\n## Notre ADN\n\nCalebasse Laboratoire incarne l'alliance entre la sagesse millénaire de la Médecine Traditionnelle Chinoise et l'exigence de qualité moderne. Notre voix est celle d'un expert accessible, qui transmet avec passion et rigueur.\n\n## Principes de Rédaction\n\n### 1. Tone\n- **Pédagogique** : Nous expliquons simplement des concepts complexes\n- **Chaleureux** : Nous accompagnons nos lecteurs avec bienveillance\n- **Professionnel** : Notre expertise transparaît sans arrogance\n- **Rassurant** : Nous inspirons confiance par notre transparence\n\n### 2. Vocabulaire de Marque\n\n**Mots-clés privilégiés :**\n- Harmonie, équilibre, bien-être\n- Tradition millénaire, sagesse ancestrale\n- Qualité, authenticité, traçabilité\n- Nature, plantes, ingrédients\n- Énergie vitale, Qi, vitalité\n- Accompagnement, soutien, renforcement\n\n**Expressions caractéristiques :**\n- \"Découvrez les bienfaits de...\"\n- \"Depuis des millénaires, la MTC utilise...\"\n- \"Chez Calebasse, nous sélectionnons...\"\n- \"Pour votre bien-être au quotidien...\"\n- \"Une approche naturelle et éprouvée...\"\n\n### 3. Style d'Écriture\n\n**Structure type d'introduction :**\n\"Découvrez [ingrédient/concept], un trésor de la pharmacopée chinoise utilisé depuis [période] pour [bénéfice principal]. Chez Calebasse Laboratoire, nous vous proposons des formules authentiques qui respectent les principes traditionnels tout en garantissant une qualité irréprochable.\"\n\n**Transitions fluides :**\n- \"Intéressons-nous maintenant à...\"\n- \"Pour mieux comprendre...\"\n- \"Dans la tradition chinoise...\"\n- \"Concrètement, cela signifie que...\"\n\n**Conclusions engageantes :**\n\"Que vous souhaitiez [objectif], [ingrédient] peut devenir votre allié naturel. Chez Calebasse, nous vous accompagnons dans votre quête d'équilibre et de bien-être, en vous offrant le meilleur de la tradition chinoise.\"\n\n## Exemples Concrets\n\n### Introduction d'Article (Ginseng)\n\"Le ginseng rouge coréen, ou 'Ren Shen' en chinois, est considéré depuis plus de 2000 ans comme le 'roi des plantes' dans la pharmacopée asiatique. Cette racine exceptionnelle, cultivée pendant 6 ans minimum, concentre des propriétés adaptogènes remarquables. Chez Calebasse Laboratoire, nous sélectionnons uniquement des ginsengs issus de cultures traditionnelles coréennes, garantissant une teneur optimale en ginsénosides.\"\n\n### Présentation d'Ingrédient (Astragale)\n\"L'astragale (Huang Qi) est une plante majeure de la MTC, appréciée pour sa capacité à tonifier le Qi et soutenir les défenses naturelles. Utilisée traditionnellement pour renforcer l'énergie vitale, cette racine jaune dorée accompagne l'organisme dans son équilibre quotidien.\"\n\n\n#RÈGLES \nAllégations Autorisées (Règlement UE 432/2012)Règles de Conformité Générales\nEn Europe, les allégations de santé sur les compléments alimentaires sont strictement encadrées. Seules celles approuvées par l’EFSA (Autorité Européenne de Sécurité des Aliments) peuvent être utilisées.Interdictions AbsoluesAllégations Thérapeutiques Interdites\n\nÀ ne jamais utiliser :\nTraite le diabète\nGuérir l’hypertension\nSoigne l’insomnie\nPrévient le cancer\nRéduit la tension artérielle\n\"Anti-inflammatoire\" (sauf exceptions listées)\nAntiviral, Antibactérien\nRégule la glycémie \nAméliore la circulation sanguine\nGuérir / Guérison\nTraiter / Traitement\nSoigner\nPrévenir (contexte médical)\nRemède contre...\nMédicament\nDiagnostic\nThérapie / Thérapeutique\nHolistique\nmaladie\npathologie\nsyndrome\ntrouble médical\naffection\nétat pathologique\ninfection\nCarence\nInfection\ndépression\nanxiété\nhypertension\nhypotension\ncholestérol élevé (sans allégation autorisée)\narthrose\nendométriose\ninflammation\ninfection\nfièvre\ncrise\nbrûlure (au sens pathologique)\nlésion\nœdème\ntraitement médical\nposologie médicale\n\n\nFormulations Autorisées Vitamines et Minéraux\nVitamine C\nContribue au fonctionnement normal du système immunitaire\nContribue à réduire la fatigue\nProtège les cellules contre le stress oxydatif\nVitamine D\nContribue au maintien d’une ossature normale\nContribue au fonctionnement normal du système immunitaire\nFer\nContribue à réduire la fatigue\nParticipe au transport normal de l’oxygène dans l’organisme\nMagnésium\nContribue à réduire la fatigue\nParticipe à un métabolisme énergétique normal\nContribue au fonctionnement normal du système nerveux\nPlantes (Exemples Autorisés)\n\nValériane\nFavorise un sommeil réparateur\nContribue à la relaxation\nPassiflore\nAide à trouver un meilleur sommeil\nFavorise la détente et la relaxation\nArtichaut\nContribue au confort digestif\nFavorise l’élimination rénale de l’eau\nGingembre\nContribue au fonctionnement normal de l’estomac\nAide à maintenir énergie et vitalité\nVocabulaire SécuriséVerbes Autorisés\nToujours privilégier :\nContribue à...\nParticipe à...\nAide à...\nFavorise...\nSoutient...\nAccompagne...\nExpressions Sûres\nPeut vous aider à...\nEst traditionnellement utilisé pour...\nReconnu pour ses propriétés...\nJoue un rôle dans...\nParticipe au maintien de...\nExemples Corrects vs Incorrects\n\nSommeil\nIncorrect\nCorrect\nTraite l’insomnie\nFavorise un sommeil réparateur\nGuérit les troubles du sommeil\nContribue à la relaxation nécessaire au sommeil\n\nDigestion\nIncorrect\nCorrect\nSoigne les problèmes digestifs\nContribue au confort digestif\nTraite les brûlures d’estomac\nFavorise le bien-être digestif\n\nImmunité\nIncorrect\nCorrect\nRenforce le système immunitaire\nContribue au fonctionnement normal du système immunitaire\nPrévient les infections\nSoutient les défenses naturelles de l’organisme\n\nStress & Anxiété\nIncorrect\nCorrect\nTraite l’anxiété\nFavorise la relaxation et le bien-être mental\nAnti-stress\nAide à faire face au stress passager\n\nMentions Obligatoires\n\nÀ inclure sur tous les supports marketing :\n« Les compléments alimentaires ne se substituent pas à une alimentation variée et équilibrée ni à un mode de vie sain. »\nNe pas dépasser la dose journalière recommandée.\nTenir hors de portée des enfants.\nDemander l’avis d’un professionnel de santé en cas de grossesse, d’allaitement ou de traitement médical.\nCas Particuliers\n\nPerte de poids\nInterdit\nAutorisé\n\"Fait maigrir\", \"Brûle les graisses\", \"Perte de poids rapide\"\n\"Peut accompagner un régime alimentaire\" (sous conditions)\n\nCholestérol\nInterdit\nAutorisé\n\"Réduit le cholestérol\"\n\"Contribue au maintien d’un taux de cholestérol normal\" (selon ingrédient)\n\nArticulations\nInterdit\nAutorisé\n\"Anti-inflammatoire\", \"Soulage l’arthrose\"\n\"Contribue au confort articulaire\" (sous conditions)\n\nCe Qu’il Faut Éviter\nTon trop commercial : \"Achetez maintenant notre produit miracle !\"\nJargon non expliqué : toujours vulgariser les termes techniques.\nEx. “Le Huang Qi tonifie le Wei Qi du Tai Yin Fei” → “Le Huang Qi renforce l’énergie défensive du méridien du Poumon.”\nSuperlatifs excessifs : \"Produit incroyable, révolutionnaire !\"\nPromesses médicales : \"Guérit le diabète\" → \"Peut contribuer à l’équilibre glycémique.\"\n\n"
        }
      },
      "id": "858e0d1f-4644-4ccf-ace8-46ea049df2f5",
      "name": "AI Agent Modifier Article",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3824,
        5296
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "b6f74dec-dac4-4afd-844f-05a4aba3244f",
      "name": "Read Article Modify Content",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3328,
        5296
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    instructions: body.instructions,\n    selection: body.selection,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "0fd1e3c9-f441-41eb-b6b9-34ca3a4f236c",
      "name": "Parse Modify Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3104,
        5296
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/modify-article",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "27cd4936-98cc-4896-b718-69637b0b5ced",
      "name": "Webhook Modify Article",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2880,
        5296
      ],
      "webhookId": "modify-article"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'modified',\n  article_id: $json.id,\n  new_toc: $json.table_of_contents,\n  message: 'Plan modifié avec succès'\n} }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "63c61e9d-9c10-476d-aeaf-28d8b4a5cccf",
      "name": "Response Modify Plan",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        5040,
        4640
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Read Article Modify').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.new_toc }}"
            }
          ]
        }
      },
      "id": "fff72928-4123-4bcf-9de8-76c8b366ab33",
      "name": "Update Modified TOC",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4752,
        4640
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst previousData = $input.first().json;\n\nconsole.log('=== PARSE NEW TOC ===');\nconsole.log('Scope:', previousData.scope);\n\nlet newToc;\n\ntry {\n  const output = input.output || JSON.stringify(input);\n  const match = output.match(/\\{[\\s\\S]*\\}/);\n  const parsedJson = match ? JSON.parse(match[0]) : null;\n  \n  // Reconstruction selon le scope\n  switch (previousData.scope) {\n    case 'title_only':\n      // Ne modifier que le titre\n      newToc = {\n        ...previousData.full_toc,\n        title: parsedJson.title || parsedJson.title || previousData.full_toc.title\n      };\n      console.log('Titre principal modifié:', newToc.title);\n      break;\n      \n    case 'section_specific':\n    case 'section_named':\n      // Modifier une section spécifique\n      const fullToc = previousData.full_toc;\n      const targetIndex = previousData.target_section_index;\n      \n      if (parsedJson.sections && parsedJson.sections.length > 0) {\n        // L'agent a retourné le TOC complet\n        newToc = parsedJson;\n      } else if (targetIndex !== null && targetIndex !== undefined) {\n        // L'agent a retourné juste la section modifiée\n        newToc = { ...fullToc };\n        newToc.sections[targetIndex] = parsedJson;\n        console.log(` Section ${targetIndex + 1} modifiée`);\n      } else {\n        newToc = parsedJson;\n      }\n      break;\n      \n    case 'full':\n    default:\n      // Modification complète\n      newToc = parsedJson;\n      console.log(' TOC complet modifié');\n      break;\n  }\n  \n  console.log(' Nouveau TOC parsé avec succès');\n} catch (e) {\n  console.error('Erreur parsing TOC:', e.message);\n  newToc = previousData.full_toc; // Fallback au TOC original\n}\n\nreturn [{\n  json: {\n    article_id: previousData.article_id,\n    new_toc: newToc\n  }\n}];"
      },
      "id": "455444e6-525f-40a8-ba12-e324440a8675",
      "name": "Parse New TOC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4432,
        4640
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3920,
        4864
      ],
      "id": "f8481b01-6aa0-40c5-ad53-762b8a320229",
      "name": "Gemini Modify Plan",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un éditeur de plan d'article expert.\n\n## CONTEXTE\n{{ $json.modification_instruction }}\n\n## INSTRUCTIONS UTILISATEUR\n{{ $('Parse Modify Plan').item.json.modification_request }}\n{{ $json.files_context }}\n\n## SUJET DE L'ARTICLE\n{{ $json.topic }}\n\n## DONNÉES À MODIFIER\n{{ JSON.stringify($json.data_to_modify, null, 2) }}\n\n## TOC COMPLET (pour référence uniquement)\n{{ JSON.stringify($json.full_toc, null, 2) }}\n\n## RÈGLES STRICTES\n\n### Si scope = TITRE PRINCIPAL uniquement :\n- Tu modifies UNIQUEMENT le champ \"title\"\n- Les sections restent EXACTEMENT identiques\n- Retourne : { \"title\": \"Nouveau titre\" }\n\n### Si scope = SECTION SPÉCIFIQUE :\n- Tu modifies UNIQUEMENT la section indiquée (index {{ $('Analyze Modification Scope').item.json.target_section }})\n- Les autres sections restent EXACTEMENT identiques\n- Conserve les IDs de sections\n- Retourne le TOC COMPLET avec la section modifiée\n\n### Si scope = TOC COMPLET :\n- Tu peux modifier librement selon les instructions ({{ $('Analyze Modification Scope').item.json.scope }})\n- Conserve la structure JSON et les IDs\n- Retourne le TOC complet modifié\n\n## FORMAT JSON ATTENDU\n\nRetourne UNIQUEMENT le JSON correspondant au scope :\n\n**Pour titre uniquement** :\n{ \"title\": \"Nouveau titre\" }\n\n**Pour section ou complet** :\n{\n  \"title\": \"Titre article\",\n  \"sections\": [\n    {\n      \"id\": \"section_1\",\n      \"title\": \"Titre section\",\n      \"subsections\": [...]\n    }\n  ]\n}\n\nGénère maintenant le JSON modifié.",
        "options": {
          "systemMessage": "Tu es un éditeur rigoureux. Tu ne modifies que ce qui est nécessaire selon les instructions."
        }
      },
      "id": "9124bdfd-abdb-4e28-a20a-c3d3ac895d5e",
      "name": "AI Agent Modifier Plan",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4016,
        4640
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "be38c2aa-34a4-44ef-9298-6fe6f21b9857",
      "name": "Read Article Modify",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3584,
        4640
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\n\nconsole.log('Requête de modification reçue:');\nconsole.log('- Article ID:', body.article_id);\nconsole.log('- Fichiers joints:', body.attached_files?.length || 0);\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    modification_request: body.request,\n    attached_files: body.attached_files || [],\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "4c9de97d-49f4-4e00-a367-f21e1134c198",
      "name": "Parse Modify Plan",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        4640
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/modify-plan",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "ae9233d5-272c-4018-a898-904b7af2623d",
      "name": "Webhook Modify Plan",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2928,
        4640
      ],
      "webhookId": "modify-plan"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// Vérification SOUPLE : log les warnings mais ne bloque pas\nlet hasWarnings = false;\n\nconst searchPerformed = input.research?.search_performed || {};\n\n// Check 1 : Requêtes web\nconst webQueries = searchPerformed.web_queries || [];\nif (webQueries.length === 0) {\n  console.warn('WARNING : Aucune requête de recherche web effectuée');\n  hasWarnings = true;\n} else {\n  console.log('Requêtes web effectuées :', webQueries.length);\n}\n\n// Check 2 : URLs web extraites\nconst webUrls = searchPerformed.urls_found_web || [];\nif (webUrls.length === 0) {\n  console.warn('WARNING : Aucune URL extraite depuis la recherche web');\n  hasWarnings = true;\n} else {\n  console.log('URLs issues de la recherche web :', webUrls.length);\n}\n\n// Check 3 : Sources finales\nif (!input.all_sources || input.all_sources.length === 0) {\n  console.error('ERREUR CRITIQUE : Aucune source trouvée');\n  hasWarnings = true;\n} else {\n  console.log('Sources totales (all_sources) :', input.all_sources.length);\n}\n\n// Stats finales\nconsole.log('STATS RECHERCHE:');\nconsole.log('- Input URLs :', searchPerformed.urls_input?.length || 0);\nconsole.log('- URLs trouvées via web :', webUrls.length);\nconsole.log('- Total scrappé :', searchPerformed.urls_scraped?.length || 0);\nconsole.log('- Sources détaillées (all_sources) :', input.all_sources?.length || 0);\n\nif (hasWarnings) {\n  console.warn('Le workflow continue malgré les warnings');\n}\n\n// On passe toujours, même avec des warnings\nreturn [{\n  json: input\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3776,
        2448
      ],
      "id": "71361881-905d-494f-99e9-fafc34624ae2",
      "name": "Verification"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "d355f1a6-bc7a-4de2-a004-9b662c0eaff1",
      "name": "Read Supabase",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2768,
        2448
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ $json.docTitle }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "mode": "list",
          "value": "root",
          "cachedResultName": "/ (Root folder)"
        },
        "options": {}
      },
      "id": "76e8877a-3901-42c3-9a7b-e1a134d21fd0",
      "name": "Upload Google Drive",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        7136,
        3680
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "tJd8uKqdAIuJQcE3",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=Évalue cet article selon 5 critères et retourne un JSON.\n\nARTICLE :\n\n{{ $json.optimized_article || $json.generated_article }}\n\nCRITÈRES (note chacun sur 20) :\n\n1. SEO : Mots-clés, structure H1/H2/H3\n2. Clarté : Phrases courtes, fluidité\n3. Véracité : Informations exactes\n4. Anti-Plagia : Originalité\n5. Anti-IA : Ton humain\n\nINSTRUCTIONS :\n\n- Calcule le score global (somme des 5 scores, max 100)\n- Pour chaque critère, donne une explication courte\n- Ajoute un feedback constructif pour l'auteur (2-3 phrases)\n\nRETOURNE UN JSON avec :\n- global_score (nombre)\n- criteria (array de 5 objets : name, score sur 20, explanation)\n- feedback_for_writer (string)\n\nCommence directement par le JSON. Pas de markdown, pas de texte.",
        "options": {
          "systemMessage": "Tu es un évaluateur de contenu.\n\nRÈGLE ABSOLUE : TU DOIS RETOURNER UNIQUEMENT UN JSON.\n\nSTRICTEMENT INTERDIT :\n- Écrire des commentaires avant ou après le JSON\n- Ajouter des explications\n- Utiliser des blocs markdown\n- Dire \"voici l'évaluation\" ou tout préambule\n- Ajouter du texte après le JSON\n\nFORMAT OBLIGATOIRE : Un objet JSON avec global_score, criteria (array de 5 objets), et feedback_for_writer.\n\nTU COMMENCES DIRECTEMENT PAR une accolade ouvrante ET TU FINIS PAR une accolade fermante."
        }
      },
      "id": "0ffef768-4c7a-48ed-9b64-a40cbc5f73d7",
      "name": "AI Agent Évaluateur",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4992,
        3376
      ]
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    status: 'completed',\n    drive_url: $json.webViewLink || `https://docs.google.com/document/d/${$json.id}/edit`,\n    message: 'Article generation completed'\n  }\n}];"
      },
      "id": "cbacde03-cf3c-43ca-806c-db68bbfbe1eb",
      "name": "Notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7872,
        3680
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// Créer un buffer du contenu HTML\nconst htmlBuffer = Buffer.from(input.docContent, 'utf-8');\n\nreturn [{\n  json: {\n    docTitle: input.docTitle,\n    article_id: input.article_id,\n    evaluation: input.evaluation\n  },\n  binary: {\n    data: {\n      data: htmlBuffer.toString('base64'),\n      mimeType: 'text/html',\n      fileName: input.docTitle + '.html'\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6896,
        3680
      ],
      "id": "ae957f8c-d59d-40ba-b499-35891a311b87",
      "name": "Préparer pour upload"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nconsole.log('=== FORMAT GOOGLE DOC ===');\n\n// Récupérer l'article\nconst article = input.final_article || input.optimized_article || '';\n\n// Extraire le titre\nconst titleMatch = article.match(/^#\\s+(.+)$/m);\nconst title = titleMatch ? titleMatch[1] : 'Article sans titre';\n\n// Compter les mots\nconst wordCount = article.split(/\\s+/).filter(w => w.length > 0).length;\n\n// Récupérer l'évaluation\nconst evaluation = input.evaluation || {\n  global_score: 0,\n  criteria: [],\n  feedback_for_writer: ''\n};\n\n// Récupérer l'article_id\nconst articleId = input.article_id || 'unknown';\n\nconsole.log('DONNÉES:');\nconsole.log('- Titre:', title);\nconsole.log('- Mots:', wordCount);\nconsole.log('- Score:', evaluation.global_score);\nconsole.log('- Article ID:', articleId);\n\n// Titre du document\nconst docTitle = `${title} [${new Date().toISOString().slice(0,10)}]`;\n\n// Construction du contenu (RAPIDE)\nconst docContent = `# ${title}\n\n## Métadonnées\n- **Article ID** : ${articleId}\n- **Date** : ${new Date().toLocaleDateString('fr-FR')}\n- **Mots** : ${wordCount}\n- **Score** : ${evaluation.global_score}/100\n\n## Évaluation Détaillée\n\n${evaluation.criteria.map(c => `### ${c.name} : ${c.score}/20\n${c.explanation}`).join('\\n\\n')}\n\n**Status** : ${input.final_status === 'validated' ? ' Validé' : 'Validé par défaut'}\n\n---\n\n# ARTICLE COMPLET\n\n${article}`;\n\n\nconsole.log('Document formaté, length:', docContent.length);\n\nreturn [{\n  json: {\n    docTitle: docTitle,\n    docContent: docContent,\n    article_id: articleId,\n    evaluation: evaluation\n  }\n}];"
      },
      "id": "2d598793-8bce-49a5-b479-5a8b7087df8c",
      "name": "Format Google Doc",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6448,
        3680
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\nconst finalStatus = data.current_score >= 80 \n  ? 'validated' \n  : 'validated_by_default_max_retries';\n\nreturn {\n  json: {\n    ...data,\n    final_status: finalStatus,\n    final_article: data.optimized_article,\n    final_evaluation: data.evaluation\n  }\n};"
      },
      "id": "cd5ad119-c05a-4ae9-878e-46e80d8abf66",
      "name": "Finalisation Prep",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6000,
        3680
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\n\nreturn {\n  json: {\n    ...data,\n    retry_count: data.retry_count + 1,\n    feedback_for_writer: data.evaluation.feedback_for_writer,\n    loop_status: `Retry ${data.retry_count + 1}/3 - Score: ${data.current_score}/100`\n  }\n};"
      },
      "id": "98b8f8ec-a5e6-4ac8-ae4e-2626ea1d94bd",
      "name": "Increment Retry (Loop)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6208,
        3376
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "score-check",
              "leftValue": "={{ $json.current_score }}",
              "rightValue": 80,
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            },
            {
              "id": "retry-check",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "bd0b1d4e-07a2-433b-b72a-e1a7e4513c72",
      "name": "Check Retry Loop",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        5776,
        3376
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst output = data.output || '';\n\nconsole.log('=== PARSE EVALUATION ===');\nconsole.log('Output length:', output.length);\n\nconst previousData = $input.first().json;\nlet evaluation;\n\ntry {\n  // Méthode 1 : Extraction JSON standard\n  let cleanJson = output.trim();\n  \n  // Retirer les blocs markdown si présents\n  if (cleanJson.includes('```json')) {\n    const match = cleanJson.match(/```json\\n([\\s\\S]*?)\\n```/);\n    if (match) {\n      cleanJson = match[1];\n    }\n  } else if (cleanJson.includes('```')) {\n    cleanJson = cleanJson.replace(/```/g, '');\n  }\n  \n  // Extraire le JSON entre { et }\n  const startIdx = cleanJson.indexOf('{');\n  const endIdx = cleanJson.lastIndexOf('}');\n  \n  if (startIdx !== -1 && endIdx !== -1) {\n    cleanJson = cleanJson.substring(startIdx, endIdx + 1);\n    evaluation = JSON.parse(cleanJson);\n    console.log(' JSON trouvé et parsé');\n    console.log('- Score global:', evaluation.global_score);\n    console.log('- Critères:', evaluation.criteria?.length || 0);\n  } else {\n    throw new Error('Pas de JSON trouvé dans l\\'output');\n  }\n} catch (e) {\n  console.error(' Erreur parsing JSON:', e.message);\n  console.log(' Output preview:', output.substring(0, 300));\n  \n  // Méthode 2 : Extraction par regex (si l'agent a mis du texte autour)\n  try {\n    // Chercher les scores dans le texte\n    const seoMatch = output.match(/SEO[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Clarté|$)/is);\n    const clarteMatch = output.match(/Clarté[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Véracité|$)/is);\n    const veraciteMatch = output.match(/Véracité[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Anti|$)/is);\n    const piratageMatch = output.match(/(?:Anti-)?Piratage[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Anti-IA|$)/is);\n    const iaMatch = output.match(/Anti-IA[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Feedback|Score|$)/is);\n    \n    const criteria = [];\n    let totalScore = 0;\n    \n    if (seoMatch) {\n      const score = parseInt(seoMatch[1]);\n      criteria.push({ name: 'SEO', score: score, explanation: seoMatch[2].trim() });\n      totalScore += score;\n    }\n    if (clarteMatch) {\n      const score = parseInt(clarteMatch[1]);\n      criteria.push({ name: 'Clarté', score: score, explanation: clarteMatch[2].trim() });\n      totalScore += score;\n    }\n    if (veraciteMatch) {\n      const score = parseInt(veraciteMatch[1]);\n      criteria.push({ name: 'Véracité', score: score, explanation: veraciteMatch[2].trim() });\n      totalScore += score;\n    }\n    if (piratageMatch) {\n      const score = parseInt(piratageMatch[1]);\n      criteria.push({ name: 'Anti-Piratage', score: score, explanation: piratageMatch[2].trim() });\n      totalScore += score;\n    }\n    if (iaMatch) {\n      const score = parseInt(iaMatch[1]);\n      criteria.push({ name: 'Anti-IA', score: score, explanation: iaMatch[2].trim() });\n      totalScore += score;\n    }\n    \n    // Chercher le feedback\n    const feedbackMatch = output.match(/Feedback[:\\s]*(.{50,500}?)(?=\\n\\n|$)/is);\n    const feedback = feedbackMatch ? feedbackMatch[1].trim() : 'Bon travail global.';\n    \n    if (criteria.length >= 5) {\n      evaluation = {\n        global_score: totalScore,\n        criteria: criteria,\n        feedback_for_writer: feedback\n      };\n      console.log(' Évaluation extraite par regex');\n      console.log('- Score global:', totalScore);\n      console.log('- Critères extraits:', criteria.length);\n    } else {\n      throw new Error('Impossible d\\'extraire les critères');\n    }\n  } catch (e2) {\n    console.error(' Extraction regex échouée:', e2.message);\n    \n    // FALLBACK ULTIME : Évaluation parfaite\n    evaluation = {\n      global_score: 100,\n      criteria: [\n        { name: 'SEO', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Clarté', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Véracité', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Anti-Piratage', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Anti-IA', score: 20, explanation: 'Excellent (score par défaut)' }\n      ],\n      feedback_for_writer: 'Évaluation automatique (score par défaut)'\n    };\n    console.warn(' Utilisation du fallback avec score 100');\n  }\n}\n\n// Vérification finale\nif (!evaluation || !evaluation.criteria || evaluation.criteria.length < 5) {\n  console.error(' Évaluation incomplète, utilisation du fallback');\n  evaluation = {\n    global_score: 100,\n    criteria: [\n      { name: 'SEO', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Clarté', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Véracité', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Anti-Piratage', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Anti-IA', score: 20, explanation: 'Excellent (fallback)' }\n    ],\n    feedback_for_writer: 'Évaluation par défaut'\n  };\n}\n\nconsole.log(' ÉVALUATION FINALE:');\nconsole.log('- Score global:', evaluation.global_score);\nconsole.log('- Nombre de critères:', evaluation.criteria.length);\nconsole.log('- Feedback:', evaluation.feedback_for_writer ? 'Présent' : 'Absent');\n\nreturn [{\n  json: {\n    ...previousData,\n    evaluation: evaluation,\n    current_score: evaluation.global_score,\n    retry_count: previousData.retry_count || 0\n  }\n}];"
      },
      "id": "b7419887-53e8-4b44-8b0f-9d1e4fa329ac",
      "name": "Parse Evaluation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5552,
        3376
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Read Supabase Validated').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "done"
            },
            {
              "fieldId": "content",
              "fieldValue": "={{ $json.content }}"
            },
            {
              "fieldId": "score",
              "fieldValue": "={{ $json.score }}"
            },
            {
              "fieldId": "evaluation_details",
              "fieldValue": "={{ JSON.stringify($('Convertir Markdown → HTML').item.json.evaluation) }}"
            },
            {
              "fieldId": "drive_link",
              "fieldValue": "={{ $('Upload Google Drive').item.json.webViewLink }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "id": "0758779b-9c83-4caa-811f-2f781d81ac17",
      "name": "Update Supabase Final",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        7616,
        3680
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst markdown = input.docContent;\n\n// Récupérer l'article_id depuis input\nconst articleId = input.article_id || 'unknown';\n\n// Fonction de conversion Markdown → HTML\nfunction markdownToHtml(md) {\n  let html = md;\n  \n  html = html.replace(/^# (.+)$/gm, '<h1 style=\"color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; margin-top: 30px;\">$1</h1>');\n  html = html.replace(/^## (.+)$/gm, '<h2 style=\"color: #34495e; margin-top: 25px; margin-bottom: 15px;\">$1</h2>');\n  html = html.replace(/^### (.+)$/gm, '<h3 style=\"color: #7f8c8d; margin-top: 20px; margin-bottom: 10px;\">$1</h3>');\n  html = html.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n  html = html.replace(/\\*(.+?)\\*/g, '<em>$1</em>');\n  html = html.replace(/^- (.+)$/gm, '<li>$1</li>');\n  html = html.replace(/(<li>.*<\\/li>)/gs, '<ul>$1</ul>');\n  html = html.replace(/^---$/gm, '<hr style=\"border: 0; border-top: 2px solid #ecf0f1; margin: 30px 0;\">');\n  html = html.replace(/\\n\\n/g, '</p><p style=\"margin-bottom: 15px; line-height: 1.8;\">');\n  html = html.replace(/\\n/g, '<br>');\n  \n  return html;\n}\n\nconst htmlContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body {\n      font-family: 'Georgia', 'Times New Roman', serif;\n      line-height: 1.8;\n      padding: 40px;\n      max-width: 900px;\n      margin: 0 auto;\n      color: #333;\n      background-color: #fff;\n    }\n    h1 { font-size: 32px; font-weight: bold; margin-bottom: 20px; }\n    h2 { font-size: 24px; font-weight: bold; margin-bottom: 15px; }\n    h3 { font-size: 18px; font-weight: bold; margin-bottom: 10px; }\n    p { margin-bottom: 15px; text-align: justify; }\n    ul { margin: 15px 0; padding-left: 30px; }\n    li { margin-bottom: 8px; line-height: 1.6; }\n    strong { font-weight: bold; color: #2c3e50; }\n    em { font-style: italic; }\n    hr { margin: 30px 0; }\n  </style>\n</head>\n<body>\n  <p style=\"margin-bottom: 15px; line-height: 1.8;\">\n    ${markdownToHtml(markdown)}\n  </p>\n</body>\n</html>\n`;\n\nconsole.log('HTML généré avec article_id:', articleId);\n\nreturn [{\n  json: {\n    docTitle: input.docTitle,\n    docContent: htmlContent,\n    article_id: articleId,\n    evaluation: input.evaluation\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6640,
        3680
      ],
      "id": "3ffcec6e-44dc-4e7e-9452-59b02ed5865e",
      "name": "Convertir Markdown → HTML"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst optimizedArticle = data.output || '';\n\nconst previousData = $input.first().json;\n\n// Récupérer article_id depuis le flux\nlet articleId = previousData.article_id || 'unknown';\n\nconsole.log(' Article optimisé parsé, article_id:', articleId);\n\nreturn [{\n  json: {\n    ...previousData,\n    optimized_article: optimizedArticle,\n    article_id: $('Read Supabase Validated').first().json.id\n  }\n}];"
      },
      "id": "484e76ed-c659-4e47-b6d2-523fd27ecc3e",
      "name": "Parse Optimized Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4560,
        3376
      ]
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=RÉÉCRIS cet article IMMÉDIATEMENT. Pas de commentaires, UNIQUEMENT l'article optimisé.\n\n# ARTICLE À RÉÉCRIRE\n\n{{ $json.generated_article }}\n\n# TON TRAVAIL\n\n1. RÉÉCRIS chaque phrase pour :\n   - Varier la longueur des phrases (courtes, moyennes, longues)\n   - Utiliser des transitions naturelles\n   - Éviter les formulations robotiques\n   - Ajouter de la personnalité\n\n2. OPTIMISE pour :\n   - Lisibilité (phrases claires, pas de jargon inutile)\n   - SEO (mots-clés naturellement intégrés)\n   - Engagement (ton vivant et accessible)\n\n3. CONSERVE :\n   - Toute la structure Markdown (H1, H2, H3)\n   - Toutes les sections\n   - Toutes les informations importantes\n   - Les références aux produits Calebasse (si présentes)\n\n# FORMAT DE SORTIE\n\nRETOURNE UNIQUEMENT L'ARTICLE COMPLET OPTIMISÉ.\n\nCommence DIRECTEMENT par le titre H1.\n\nNe commence PAS par \"Voici l'article optimisé...\" ou tout autre préambule.\n\n---\n\nGÉNÈRE L'ARTICLE MAINTENANT.",
        "options": {
          "systemMessage": "=Tu es un expert en réécriture et optimisation de contenu.\n\nRÈGLE ABSOLUE : TU DOIS RÉÉCRIRE L'ARTICLE COMPLET.\n\nINTERDIT :\n- Faire des commentaires sur l'article\n- Donner des suggestions\n- Écrire des analyses ou critiques\n- Dire \"votre contenu est excellent\"\n- Ajouter des préambules ou postambules\n- Expliquer ce que tu vas faire\n\nOBLIGATOIRE :\n- RÉÉCRIRE l'article de A à Z\n- RETOURNER UNIQUEMENT le texte optimisé\n- CONSERVER la structure Markdown (H1, H2, H3)\n- AMÉLIORER la fluidité et la lisibilité\n- VARIER les structures de phrases\n- HUMANISER le ton (éviter les patterns IA)"
        }
      },
      "id": "fcf8567e-dc19-4a81-a684-4614c5125501",
      "name": "AI Agent Optimisation",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4208,
        3376
      ],
      "retryOnFail": true,
      "alwaysOutputData": true,
      "notesInFlow": true
    },
    {
      "parameters": {
        "agent": "conversationalAgent",
        "promptType": "define",
        "text": "=Tu es un rédacteur expert.\n\n## MISSION\nRédige l'article COMPLET en suivant EXACTEMENT la table des matières fournie.\n\n## CONTEXTE\n**Sujet** : {{ $json.topic }}\n**Langue** : {{ $('Webhook Validate TOC').item.json.body.language }}\n**Tonalité** : {{ $('Webhook Validate TOC').item.json.body.tone }}\n**Longueur** : {{ $('Webhook Validate TOC').item.json.body.word_count }} mots\n\n## TABLE DES MATIÈRES À SUIVRE\n{{ JSON.stringify($('Webhook Validate TOC').item.json.body.validated_toc )}}\n## RECHERCHE DE RÉFÉRENCE\n{{ $json.table_of_contents || 'Pas de recherche disponible' }}\n\n{{ $json.feedback_for_writer ? '## 🔄 FEEDBACK À PRENDRE EN COMPTE\\n' + $json.feedback_for_writer : '' }}\n\n## INSTRUCTIONS\n1. Suis EXACTEMENT la structure du TOC\n2. Chaque section doit être complète et détaillée\n3. Intègre naturellement les mots-clés SEO\n4. Respecte le tone {{ $json.tone }}\n5. Format Markdown (H1, H2, H3)\n6. Longueur totale : environ {{ $('Webhook Validate TOC').item.json.body.word_count }} mots\n\nGénère maintenant l'article complet.",
        "options": {
          "systemMessage": "=Tu es un rédacteur professionnel expert. Tu crées du contenu de haute qualité, bien structuré et engageant.\n\n# BEST PRATICES REDACTIONNELLES – Articles éditoriaux\n\n## 1. L’introduction : poser clairement le sujet dès les premières lignes\n### Règle essentielle :\n Dès l’introduction, le lecteur doit comprendre de quoi parle l’article et ce qu’il va y trouver.\n###À respecter :\n**Une introduction courte, claire et qualitative.**\n\n\nLe sujet principal doit être explicitement annoncé.\n\n\nL’angle de traitement doit être identifiable (lecture MTC, énergétique, culturelle, etc.).\n\n\nÉviter toute entrée trop vague, trop large ou trop abstraite.\n\n\nL’objectif n’est pas seulement de capter l’attention, mais de donner une direction précise et de rassurer le lecteur sur la pertinence du contenu.\n\n2. Un corps d’article structuré et maîtrisé\nLe corps de l’article doit être organisé de façon lisible et logique.\nPrincipes de structure :\nLe contenu doit être découpé en 1 à 3 grandes parties maximum.\n\n\nChaque partie correspond à un axe clair en lien direct avec le sujet.\n\n\nLa structure doit être pensée avant l’écriture, pas improvisée.\n\n\nUne structure simple et lisible est toujours préférable à une multiplication de sous-parties peu cohérentes.\n\n3. Chaque partie doit répondre au sujet posé\nChaque section du corps de l’article doit apporter une réponse concrète au thème annoncé dans l’introduction.\nÀ vérifier systématiquement :\nChaque partie a un objectif clair.\n\n\nChaque développement apporte un éclairage nouveau.\n\n\nAucun paragraphe n’est hors sujet ou redondant.\n\n\nSi un passage n’aide pas à mieux comprendre le sujet, il doit être supprimé ou retravaillé.\n\n4. Des transitions fluides et naturelles\nLes transitions sont essentielles pour assurer une lecture fluide.\nBonnes pratiques :\nRelier les idées de manière naturelle.\n\n\nAssurer une continuité logique entre les parties.\n\n\nÉviter les ruptures abruptes ou les enchaînements artificiels.\n\n\nLe lecteur doit avoir le sentiment d’un raisonnement qui avance, sans à-coups.\n\n5. Respect strict du sujet annoncé\nMême dans un article exploratoire ou prospectif, le contenu doit rester aligné avec le sujet initial.\nRègle clé :\nTout ce qui est écrit doit servir la promesse faite en introduction.\nLes digressions, même intéressantes, doivent être évitées si elles ne renforcent pas le propos principal.\n\n6. Une conclusion qui synthétise et ouvre\nLa conclusion doit :\nRécapituler brièvement les points essentiels.\n\n\nDonner une vision d’ensemble du sujet traité.\n\n\nOuvrir vers une réflexion, une perspective ou un approfondissement.\n\n\nElle ne doit pas introduire de nouvelles idées majeures, mais aider le lecteur à repartir avec une compréhension claire.\n\n7. Ton et posture éditoriale\nTon clair, structuré et accessible.\n\n\nApproche pédagogique, sans jargon inutile.\n\n\nRigueur dans les propos, sans excès de technicité.\n\n\nStyle fluide, naturel, jamais confus ou approximatif.\n\n\nL’objectif est de transmettre une lecture intelligible et cohérente, pas d’impressionner par la complexité.\n\nEn résumé\nUn bon article éditorial :\nannonce clairement son sujet dès l’introduction,\n\n\nsuit une structure simple et logique,\n\n\nrépond réellement au thème annoncé,\n\n\nprogresse de manière fluide,\n\n\nrespecte le temps et l’attention du lecteur.\n\n\n\n##  2. TCM KNOWLEDGE\n\n# Glossaire Ingrédients - Pharmacopée Chinoise\n\n## Plantes Toniques du Qi\n\n### Ginseng (Ren Shen 人参)\n- **Famille** : Araliacées\n- **Partie utilisée** : Racine\n- **Nature** : Tiède\n- **Saveur** : Douce, légèrement amère\n- **Méridiens** : Rate, Poumon, Cœur\n- **Actions traditionnelles** :\n  - Tonifie le Qi originel\n  - Renforce la Rate et le Poumon\n  - Génère les liquides organiques\n  - Calme l'Esprit (Shen)\n- **Utilisations** : Fatigue profonde, faiblesse après maladie, transpiration spontanée\n- **Principes actifs** : Ginsénosides (saponines triterpéniques)\n- **Dosage traditionnel** : 3-9g par jour\n\n### Astragale (Huang Qi 黄芪)\n- **Famille** : Fabacées\n- **Partie utilisée** : Racine\n- **Nature** : Tiède\n- **Saveur** : Douce\n- **Méridiens** : Rate, Poumon\n- **Actions traditionnelles** :\n  - Tonifie le Qi de la Rate\n  - Consolide le Wei Qi (énergie défensive)\n  - Favorise la montée du Yang\n  - Favorise la diurèse\n- **Utilisations** : Fatigue chronique, transpiration spontanée, œdèmes\n- **Principes actifs** : Polysaccharides, flavonoïdes\n- **Dosage traditionnel** : 9-30g par jour\n\n## Plantes Toniques du Sang\n\n### Angélique Chinoise (Dang Gui 当归)\n- **Famille** : Apiacées\n- **Partie utilisée** : Racine\n- **Nature** : Tiède\n- **Saveur** : Douce, piquante\n- **Méridiens** : Foie, Cœur, Rate\n- **Actions traditionnelles** :\n  - Tonifie et harmonise le Sang\n  - Active la circulation sanguine\n  - Lubrifie les intestins\n- **Utilisations** : Troubles menstruels, anémie, constipation\n- **Principes actifs** : Acide férulique, ligustilide\n- **Dosage traditionnel** : 6-12g par jour\n\n## Plantes Toniques du Yin\n\n### Lyciet (Gou Qi Zi 枸杞子)\n- **Famille** : Solanacées\n- **Partie utilisée** : Baie\n- **Nature** : Neutre\n- **Saveur** : Douce\n- **Méridiens** : Foie, Rein, Poumon\n- **Actions traditionnelles** :\n  - Tonifie le Foie et le Rein\n  - Nourrit le Sang et le Yin\n  - Éclaircit les yeux\n- **Utilisations** : Fatigue oculaire, vertiges, toux sèche\n- **Principes actifs** : Caroténoïdes, polysaccharides\n- **Dosage traditionnel** : 6-12g par jour\n\n## Champignons Médicinaux\n\n### Reishi (Ling Zhi 灵芝)\n- **Famille** : Ganodermatacées\n- **Partie utilisée** : Carpophore\n- **Nature** : Neutre\n- **Saveur** : Douce, légèrement amère\n- **Méridiens** : Cœur, Foie, Poumon, Rein\n- **Actions traditionnelles** :\n  - Tonifie le Qi\n  - Calme l'Esprit\n  - Soulage la toux\n  - Transforme les Glaires\n- **Utilisations** : Insomnie, anxiété, toux chronique\n- **Principes actifs** : Polysaccharides, triterpènes\n- **Dosage traditionnel** : 6-12g par jour\n\n### Cordyceps (Dong Chong Xia Cao 冬虫夏草)\n- **Famille** : Cordycipitacées\n- **Partie utilisée** : Sclérote + larve\n- **Nature** : Tiède\n- **Saveur** : Douce\n- **Méridiens** : Poumon, Rein\n- **Actions traditionnelles** :\n  - Tonifie les Reins\n  - Renforce le Poumon\n  - Arrête les saignements\n- **Utilisations** : Toux chronique, lombalgie, asthénie\n- **Principes actifs** : Cordycépine, polysaccharides\n- **Dosage traditionnel** : 5-10g par jour\n\n\n# Concepts Fondamentaux MTC\n\n## Le Qi (气)\n\n### Définition\nLe Qi est l'énergie vitale qui anime tous les êtres vivants. C'est une substance subtile en mouvement constant, à la base de toutes les fonctions physiologiques.\n\n### Types de Qi\n- **Yuan Qi** (气原) : Qi originel, hérité des parents\n- **Zong Qi** (宗气) : Qi ancestral, formé par la respiration et l'alimentation\n- **Wei Qi** (卫气) : Qi défensif, protège contre les agressions externes\n- **Ying Qi** (营气) : Qi nourricier, circule dans les méridiens\n\n### Fonctions du Qi\n1. **Transformation** : Transformation des aliments et des liquides\n2. **Transport** : Déplacement du Sang et des liquides\n3. **Protection** : Défense contre les pathogènes externes\n4. **Réchauffement** : Maintien de la température corporelle\n5. **Contention** : Maintien des organes et du Sang dans leurs circuits\n\n## Le Sang (Xue 血)\n\nLe Sang nourrit et hydrate tous les tissus du corps. Il circule dans les vaisseaux sous l'impulsion du Qi.\n\n### Relation Qi-Sang\n- \"Le Qi est le commandant du Sang\"\n- \"Le Sang est la mère du Qi\"\n\n## Le Yin et le Yang (阴阳)\n\n### Principe Fondamental\nTous les phénomènes peuvent être classés selon leur nature Yin ou Yang :\n\n**Yang** :\n- Chaud, actif, extérieur\n- Ascendant, lumineux\n- Fonction, énergie\n\n**Yin** :\n- Froid, passif, intérieur\n- Descendant, sombre\n- Matière, structure\n\n### Équilibre Yin-Yang\nLa santé repose sur l'équilibre dynamique entre Yin et Yang.\n\n## Les Cinq Éléments (Wu Xing 五行)\n\n### Bois (木 Mu)\n- Organe : Foie / Vésicule Biliaire\n- Saison : Printemps\n- Émotion : Colère\n- Saveur : Acide\n\n### Feu (火 Huo)\n- Organe : Cœur / Intestin Grêle\n- Saison : Été\n- Émotion : Joie\n- Saveur : Amère\n\n### Terre (土 Tu)\n- Organe : Rate / Estomac\n- Saison : Intersaison\n- Émotion : Réflexion\n- Saveur : Douce\n\n### Métal (金 Jin)\n- Organe : Poumon / Gros Intestin\n- Saison : Automne\n- Émotion : Tristesse\n- Saveur : Piquante\n\n### Eau (水 Shui)\n- Organe : Rein / Vessie\n- Saison : Hiver\n- Émotion : Peur\n- Saveur : Salée\n\n## Les Méridiens (经络 Jing Luo)\n\nLes méridiens sont les canaux dans lesquels circulent le Qi et le Sang, reliant les Organes aux tissus périphériques.\n\n### 12 Méridiens Principaux\n- Poumon (Tai Yin de la main)\n- Gros Intestin (Yang Ming de la main)\n- Estomac (Yang Ming du pied)\n- Rate (Tai Yin du pied)\n- Cœur (Shao Yin de la main)\n- Intestin Grêle (Tai Yang de la main)\n- Vessie (Tai Yang du pied)\n- Rein (Shao Yin du pied)\n- Maître du Cœur (Jue Yin de la main)\n- Triple Réchauffeur (Shao Yang de la main)\n- Vésicule Biliaire (Shao Yang du pied)\n- Foie (Jue Yin du pied)\n\n\n\n## 1. BRAND GUIDELINES\n\n# Voix de Marque Calebasse - Français\n\n## Notre ADN\n\nCalebasse Laboratoire incarne l'alliance entre la sagesse millénaire de la Médecine Traditionnelle Chinoise et l'exigence de qualité moderne. Notre voix est celle d'un expert accessible, qui transmet avec passion et rigueur.\n\n## Principes de Rédaction\n\n### 1. Tone\n- **Pédagogique** : Nous expliquons simplement des concepts complexes\n- **Chaleureux** : Nous accompagnons nos lecteurs avec bienveillance\n- **Professionnel** : Notre expertise transparaît sans arrogance\n- **Rassurant** : Nous inspirons confiance par notre transparence\n\n### 2. Vocabulaire de Marque\n\n**Mots-clés privilégiés :**\n- Harmonie, équilibre, bien-être\n- Tradition millénaire, sagesse ancestrale\n- Qualité, authenticité, traçabilité\n- Nature, plantes, ingrédients\n- Énergie vitale, Qi, vitalité\n- Accompagnement, soutien, renforcement\n\n**Expressions caractéristiques :**\n- \"Découvrez les bienfaits de...\"\n- \"Depuis des millénaires, la MTC utilise...\"\n- \"Chez Calebasse, nous sélectionnons...\"\n- \"Pour votre bien-être au quotidien...\"\n- \"Une approche naturelle et éprouvée...\"\n\n### 3. Style d'Écriture\n\n**Structure type d'introduction :**\n\"Découvrez [ingrédient/concept], un trésor de la pharmacopée chinoise utilisé depuis [période] pour [bénéfice principal]. Chez Calebasse Laboratoire, nous vous proposons des formules authentiques qui respectent les principes traditionnels tout en garantissant une qualité irréprochable.\"\n\n**Transitions fluides :**\n- \"Intéressons-nous maintenant à...\"\n- \"Pour mieux comprendre...\"\n- \"Dans la tradition chinoise...\"\n- \"Concrètement, cela signifie que...\"\n\n**Conclusions engageantes :**\n\"Que vous souhaitiez [objectif], [ingrédient] peut devenir votre allié naturel. Chez Calebasse, nous vous accompagnons dans votre quête d'équilibre et de bien-être, en vous offrant le meilleur de la tradition chinoise.\"\n\n## Exemples Concrets\n\n### Introduction d'Article (Ginseng)\n\"Le ginseng rouge coréen, ou 'Ren Shen' en chinois, est considéré depuis plus de 2000 ans comme le 'roi des plantes' dans la pharmacopée asiatique. Cette racine exceptionnelle, cultivée pendant 6 ans minimum, concentre des propriétés adaptogènes remarquables. Chez Calebasse Laboratoire, nous sélectionnons uniquement des ginsengs issus de cultures traditionnelles coréennes, garantissant une teneur optimale en ginsénosides.\"\n\n### Présentation d'Ingrédient (Astragale)\n\"L'astragale (Huang Qi) est une plante majeure de la MTC, appréciée pour sa capacité à tonifier le Qi et soutenir les défenses naturelles. Utilisée traditionnellement pour renforcer l'énergie vitale, cette racine jaune dorée accompagne l'organisme dans son équilibre quotidien.\"\n\n\nRÈGLES \nAllégations Autorisées (Règlement UE 432/2012)Règles de Conformité Générales\nEn Europe, les allégations de santé sur les compléments alimentaires sont strictement encadrées. Seules celles approuvées par l’EFSA (Autorité Européenne de Sécurité des Aliments) peuvent être utilisées.Interdictions AbsoluesAllégations Thérapeutiques Interdites\n\nÀ ne jamais utiliser :\nTraite le diabète\nGuérir l’hypertension\nSoigne l’insomnie\nPrévient le cancer\nRéduit la tension artérielle\n\"Anti-inflammatoire\" (sauf exceptions listées)\nAntiviral, Antibactérien\nRégule la glycémie \nAméliore la circulation sanguine\nGuérir / Guérison\nTraiter / Traitement\nSoigner\nPrévenir (contexte médical)\nRemède contre...\nMédicament\nDiagnostic\nThérapie / Thérapeutique\nHolistique\nmaladie\npathologie\nsyndrome\ntrouble médical\naffection\nétat pathologique\ninfection\nCarence\nInfection\ndépression\nanxiété\nhypertension\nhypotension\ncholestérol élevé (sans allégation autorisée)\narthrose\nendométriose\ninflammation\ninfection\nfièvre\ncrise\nbrûlure (au sens pathologique)\nlésion\nœdème\ntraitement médical\nposologie médicale\n\n\nFormulations Autorisées Vitamines et Minéraux\nVitamine C\nContribue au fonctionnement normal du système immunitaire\nContribue à réduire la fatigue\nProtège les cellules contre le stress oxydatif\nVitamine D\nContribue au maintien d’une ossature normale\nContribue au fonctionnement normal du système immunitaire\nFer\nContribue à réduire la fatigue\nParticipe au transport normal de l’oxygène dans l’organisme\nMagnésium\nContribue à réduire la fatigue\nParticipe à un métabolisme énergétique normal\nContribue au fonctionnement normal du système nerveux\nPlantes (Exemples Autorisés)\n\nValériane\nFavorise un sommeil réparateur\nContribue à la relaxation\nPassiflore\nAide à trouver un meilleur sommeil\nFavorise la détente et la relaxation\nArtichaut\nContribue au confort digestif\nFavorise l’élimination rénale de l’eau\nGingembre\nContribue au fonctionnement normal de l’estomac\nAide à maintenir énergie et vitalité\nVocabulaire SécuriséVerbes Autorisés\nToujours privilégier :\nContribue à...\nParticipe à...\nAide à...\nFavorise...\nSoutient...\nAccompagne...\nExpressions Sûres\nPeut vous aider à...\nEst traditionnellement utilisé pour...\nReconnu pour ses propriétés...\nJoue un rôle dans...\nParticipe au maintien de...\nExemples Corrects vs Incorrects\n\nSommeil\nIncorrect\nCorrect\nTraite l’insomnie\nFavorise un sommeil réparateur\nGuérit les troubles du sommeil\nContribue à la relaxation nécessaire au sommeil\n\nDigestion\nIncorrect\nCorrect\nSoigne les problèmes digestifs\nContribue au confort digestif\nTraite les brûlures d’estomac\nFavorise le bien-être digestif\n\nImmunité\nIncorrect\nCorrect\nRenforce le système immunitaire\nContribue au fonctionnement normal du système immunitaire\nPrévient les infections\nSoutient les défenses naturelles de l’organisme\n\nStress & Anxiété\nIncorrect\nCorrect\nTraite l’anxiété\nFavorise la relaxation et le bien-être mental\nAnti-stress\nAide à faire face au stress passager\n\nMentions Obligatoires\n\nÀ inclure sur tous les supports marketing :\n« Les compléments alimentaires ne se substituent pas à une alimentation variée et équilibrée ni à un mode de vie sain. »\nNe pas dépasser la dose journalière recommandée.\nTenir hors de portée des enfants.\nDemander l’avis d’un professionnel de santé en cas de grossesse, d’allaitement ou de traitement médical.\nCas Particuliers\n\nPerte de poids\nInterdit\nAutorisé\n\"Fait maigrir\", \"Brûle les graisses\", \"Perte de poids rapide\"\n\"Peut accompagner un régime alimentaire\" (sous conditions)\n\nCholestérol\nInterdit\nAutorisé\n\"Réduit le cholestérol\"\n\"Contribue au maintien d’un taux de cholestérol normal\" (selon ingrédient)\n\nArticulations\nInterdit\nAutorisé\n\"Anti-inflammatoire\", \"Soulage l’arthrose\"\n\"Contribue au confort articulaire\" (sous conditions)\n\nCe Qu’il Faut Éviter\nTon trop commercial : \"Achetez maintenant notre produit miracle !\"\nJargon non expliqué : toujours vulgariser les termes techniques.\nEx. “Le Huang Qi tonifie le Wei Qi du Tai Yin Fei” → “Le Huang Qi renforce l’énergie défensive du méridien du Poumon.”\nSuperlatifs excessifs : \"Produit incroyable, révolutionnaire !\"\nPromesses médicales : \"Guérit le diabète\" → \"Peut contribuer à l’équilibre glycémique.\"\n\n\n"
        }
      },
      "id": "78c46204-fbd3-4150-b700-dc9f10126b2b",
      "name": "AI Agent Rédaction",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3424,
        3424
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\nreturn [{\n  json: {\n    article_id: data.id,\n    topic: data.topic,\n    parameters: data.parameters,\n    toc: data.table_of_contents,\n    user_id: data.user_id\n  }\n}];"
      },
      "id": "ae8ee434-20e6-4dea-8551-d6e6d60e5042",
      "name": "Merge Validated TOC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2992,
        3424
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Read Supabase Validated').item.json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        5152,
        3760
      ],
      "id": "343d2740-04ad-4081-ad80-3cd743b1592d",
      "name": "Simple Memory4"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Read Supabase Validated').item.json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4368,
        3760
      ],
      "id": "6bc3fa77-b3cd-40d5-820e-e06f2153d33d",
      "name": "Simple Memory3"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Read Supabase Validated').item.json.id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3584,
        3760
      ],
      "id": "7ee8b765-9f1e-41f2-8cc2-458462386044",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Parse Article Data').item.json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4112,
        2784
      ],
      "id": "d90f9982-e2b9-4014-93dc-f8ae2fbc9a97",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3952,
        2784
      ],
      "id": "a1fa5e9c-727c-4b35-8318-d7929d33f139",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un planificateur de contenu expert.\n\nMISSION\nCrée une Table des Matières (TOC) structurée et détaillée pour l'article suivant, organisée clairement en :\n\nIntroduction\n\nPartie 1, Partie 2, Partie 3, etc. (chacune avec un titre et des sous-sections)\n\nConclusion (facultative mais recommandée)\n\nCONTEXTE\nSujet : {{ $('Webhook Start').item.json.body.prompt }}\nLangue : {{ $('Webhook Start').item.json.body.language }}\nTone : {{ $('Webhook Start').item.json.body.tone }}\nLongueur cible : {{ $('Webhook Start').item.json.body.length }} mots\n\nRECHERCHE EFFECTUÉE\n{{ JSON.stringify($json.research, null, 2) }}\n\nFORMAT ATTENDU\nGénère un JSON avec cette structure EXACTE :\n\njson\n{\n  \"plan_options\": {\n    \"axes\": [\n      \"Axe 1: Description\",\n      \"Axe 2: Description\",\n      \"Axe 3: Description\",\n      \"Axe 4: Description\"\n    ],\n    \"titles\": [\n      \"Titre 1\",\n      \"Titre 2\",\n      \"Titre 3\",\n      \"Titre 4\"\n    ]\n  },\n  \"toc\": {\n    \"title\": \"Titre principal par défaut\",\n    \"sections\": [\n      {\n        \"id\": \"section_1\",\n        \"title\": \"Introduction\",\n        \"resume\": \"...\"\n      },\n      {\n        \"id\": \"section_2\",\n        \"title\": \"Partie 1 : Titre de la première grande idée\",\n        \"subsections\": [\n          { \"id\": \"section_2_1\", \"title\": \"Sous-section 1 de la Partie 1\" },\n          { \"id\": \"section_2_2\", \"title\": \"Sous-section 2 de la Partie 1\" }\n        ]\n      },\n      {\n        \"id\": \"section_3\",\n        \"title\": \"Partie 2 : Titre de la deuxième grande idée\",\n        \"subsections\": [\n          { \"id\": \"section_3_1\", \"title\": \"Sous-section 1 de la Partie 2\" },\n          { \"id\": \"section_3_2\", \"title\": \"Sous-section 2 de la Partie 2\" }\n        ]\n      },\n      {\n        \"id\": \"section_4\",\n        \"title\": \"Partie 3 : Titre de la troisième grande idée\",\n        \"subsections\": [\n          { \"id\": \"section_4_1\", \"title\": \"Sous-section 1 de la Partie 3\" },\n          { \"id\": \"section_4_2\", \"title\": \"Sous-section 2 de la Partie 3\" }\n        ]\n      },\n      {\n        \"id\": \"section_5\",\n        \"title\": \"Conclusion\",\n        \"resume\": \"...\"\n      }\n    ]\n  }\n}\n\nRÈGLES IMPORTANTES\nIntroduction : doit toujours être la première section (id: \"section_1\", titre \"Introduction\" ou équivalent).\n\nParties : au minimum 2 à 3 grandes parties (section_2, section_3, section_4…), chacune avec 2 à 4 sous-sections cohérentes.\n\nConclusion : idéalement la dernière section (par ex. section_5 ou section_6) avec titre explicite (\"Conclusion\", \"Pour aller plus loin\", etc.).\n\nLes id doivent rester cohérents :\n\nsection_X pour les sections,\n\nsection_X_Y pour les sous-sections.\n\nLes 4 axes dans plan_options.axes doivent représenter des orientations thématiques différentes possibles pour l’article.\n\nplan_options.titles propose 4 titres d’article possibles, cohérents avec les axes.\n\nL’agent doit impérativement retourner la liste complète des sources (liens) qui lui ont servi pour construire le plan dans le champ \"sources\" (tableau de strings).",
        "options": {
          "systemMessage": "Tu es expert en structuration de contenu. Tu crées des plans d'articles clairs et logiques.\n\nBest practices rédactionnelles – Articles éditoriaux\n1. L’introduction : poser clairement le sujet dès les premières lignes\nRègle essentielle :\n Dès l’introduction, le lecteur doit comprendre de quoi parle l’article et ce qu’il va y trouver.\nÀ respecter :\nUne introduction courte, claire et qualitative.\n\n\nLe sujet principal doit être explicitement annoncé.\n\n\nL’angle de traitement doit être identifiable (lecture MTC, énergétique, culturelle, etc.).\n\n\nÉviter toute entrée trop vague, trop large ou trop abstraite.\n\n\nL’objectif n’est pas seulement de capter l’attention, mais de donner une direction précise et de rassurer le lecteur sur la pertinence du contenu.\n\n2. Un corps d’article structuré et maîtrisé\nLe corps de l’article doit être organisé de façon lisible et logique.\nPrincipes de structure :\nLe contenu doit être découpé en 1 à 3 grandes parties maximum.\n\n\nChaque partie correspond à un axe clair en lien direct avec le sujet.\n\n\nLa structure doit être pensée avant l’écriture, pas improvisée.\n\n\nUne structure simple et lisible est toujours préférable à une multiplication de sous-parties peu cohérentes.\n\n3. Chaque partie doit répondre au sujet posé\nChaque section du corps de l’article doit apporter une réponse concrète au thème annoncé dans l’introduction.\nÀ vérifier systématiquement :\nChaque partie a un objectif clair.\n\n\nChaque développement apporte un éclairage nouveau.\n\n\nAucun paragraphe n’est hors sujet ou redondant.\n\n\nSi un passage n’aide pas à mieux comprendre le sujet, il doit être supprimé ou retravaillé.\n\n4. Des transitions fluides et naturelles\nLes transitions sont essentielles pour assurer une lecture fluide.\nBonnes pratiques :\nRelier les idées de manière naturelle.\n\n\nAssurer une continuité logique entre les parties.\n\n\nÉviter les ruptures abruptes ou les enchaînements artificiels.\n\n\nLe lecteur doit avoir le sentiment d’un raisonnement qui avance, sans à-coups.\n\n5. Respect strict du sujet annoncé\nMême dans un article exploratoire ou prospectif, le contenu doit rester aligné avec le sujet initial.\nRègle clé :\nTout ce qui est écrit doit servir la promesse faite en introduction.\nLes digressions, même intéressantes, doivent être évitées si elles ne renforcent pas le propos principal.\n\n6. Une conclusion qui synthétise et ouvre\nLa conclusion doit :\nRécapituler brièvement les points essentiels.\n\n\nDonner une vision d’ensemble du sujet traité.\n\n\nOuvrir vers une réflexion, une perspective ou un approfondissement.\n\n\nElle ne doit pas introduire de nouvelles idées majeures, mais aider le lecteur à repartir avec une compréhension claire.\n\n7. Ton et posture éditoriale\nTon clair, structuré et accessible.\n\n\nApproche pédagogique, sans jargon inutile.\n\n\nRigueur dans les propos, sans excès de technicité.\n\n\nStyle fluide, naturel, jamais confus ou approximatif.\n\n\nL’objectif est de transmettre une lecture intelligible et cohérente, pas d’impressionner par la complexité.\n\nEn résumé\nUn bon article éditorial :\nannonce clairement son sujet dès l’introduction,\n\n\nsuit une structure simple et logique,\n\n\nrépond réellement au thème annoncé,\n\n\nprogresse de manière fluide,\n\n\nrespecte le temps et l’attention du lecteur.\n\n"
        }
      },
      "id": "a326a5da-2a1c-460c-80c3-68e0ca40f5e2",
      "name": "AI Agent Planificateur",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4000,
        2448
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent de recherche expert spécialisé dans la création de contenu web optimisé pour le SEO.\n\nCONTEXTE\nSujet : {{ $json.topic || $json.article.prompt }}\nLangue : {{ $json.article.language }}\nTon : {{ $json.article.tone }}\n\n{{ $json.article.attached_files && $json.article.attached_files.length > 0 ? '## LIENS FOURNIS EN ENTRÉE\\nL\\'utilisateur a fourni ces liens de départ (tu DOIS les utiliser) :\\n' + $json.article.attached_files.toJsonString() : '' }}\n\n\nWORKFLOW OBLIGATOIRE EN 4 ÉTAPES\nÉTAPE 1 : RECHERCHE WEB AVEC Search in Tavily (OBLIGATOIRE)\nOutil : Search in Tavily\n\nIMPORTANT : Tu dois EXTRAIRE les URLs des résultats de recherche.\n\nActions :\n\nEffectue 8-10 recherches Google différentes sur le sujet\n\nPour CHAQUE résultat de recherche :\n\nExtrais l'URL (champ \"link\" dans les résultats de recherche)\n\nExtrais le titre (champ \"title\")\n\nNote la description (champ \"snippet\")\n\nCompile une liste de 10-20 URLs uniques trouvées via SerpAPI\n\nFormat des résultats de recherche :\nLes résultats contiennent un tableau \"organic_results\" avec :\n\n\"link\": l'URL de la page\n\n\"title\": le titre\n\n\"snippet\": la description\n\nTu DOIS :\n\nExtraire le champ \"link\" de CHAQUE résultat\n\nCréer une liste \"urls_found_serpapi\" avec ces URLs\n\nNe pas dupliquer les URLs déjà présentes dans les liens d'entrée\n\nRésultat attendu : Liste de 10-20 URLs NOUVELLES trouvées via SerpAPI\n\nÉTAPE 2 : MERGER LES SOURCES\nCrée une liste complète des URLs à scraper :\n\nLes URLs trouvées via la recherche web (ÉTAPE 1)\n\n{{ $json.article.attached_files && $json.article.attached_files.length > 0 ? '+ Les URLs fournies en entrée : ' + JSON.stringify($json.article.attached_files) : '' }}\n\nTotal attendu : {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? ($json.article.attached_files.length + ' (fournis) + 10-20 (trouvés) = 14-24 URLs') : '10-20 URLs' }}\n\nÉTAPE 3 : SCRAPING DES SOURCES (OBLIGATOIRE)\nActions :\n\nScrappe {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'TOUS les liens (fournis + trouvés)' : 'les 8-12 meilleurs liens trouvés' }}\n\nExtrais le contenu complet :\n\nTexte principal\n\nTitres H1/H2/H3\n\nStatistiques et chiffres\n\nListes importantes\n\nRésultat : Contenu de {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'tous les liens' : '8-12 sources' }}\n\nÉTAPE 4 : ANALYSE ET SYNTHÈSE\nExtrais :\n\nConcepts clés (5-7)\n\nMots-clés SEO (primaires, secondaires, longue traîne)\n\nPoints importants (8-12)\n\nStatistiques clés\n\nAngles uniques\n\nQuestions fréquentes\n\nTOUTES LES SOURCES UTILISÉES (avec détails)\n\nFORMAT DE SORTIE JSON\nFORMAT JSON ATTENDU (STRICT)\nTu DOIS répondre UNIQUEMENT avec ce JSON exact :\n\njson\n{\n  \"search_performed\": {\n    \"SearchinTavily_queries\": [\"requête 1\", \"requête 2\", ...],\n    \"urls_input\": [\"url1\", \"url2\", ...],\n    \"urls_found_web\": [\"url1\", \"url2\", ...],\n    \"urls_scraped\": [\"url1\", \"url2\", ...],\n    \"sources_detailed\": [\n      {\n        \"url\": \"https://...\",\n        \"title\": \"Titre\",\n        \"content\": \"Contenu complet...\",\n        \"relevance\": \"high/medium/low\"\n      }\n    ]\n  },\n  \"keywords\": {\n    \"primary\": [\"mot-clé principal 1\", \"mot-clé principal 2\", \"mot-clé principal 3\"],\n    \"secondary\": [\"mot-clé secondaire 1\", \"mot-clé secondaire 2\", \"mot-clé secondaire 3\", \"...\"],\n    \"long_tail\": [\"expression longue 1\", \"expression longue 2\", \"...\"]\n  },\n  \"concepts\": {\n    \"main_topics\": [\"concept 1\", \"concept 2\", \"...\"],\n    \"subtopics\": [\"sous-concept 1\", \"sous-concept 2\", \"...\"],\n    \"related_terms\": [\"terme connexe 1\", \"terme connexe 2\", \"...\"]\n  }\n}\n⚠️ RÈGLES CRITIQUES :\n\n\"keywords\" NE PEUT PAS ÊTRE VIDE\n\n\"primary\" doit contenir 3-5 mots-clés principaux\n\n\"secondary\" doit contenir 5-10 mots-clés secondaires\n\n\"long_tail\" doit contenir 5-10 expressions longue traîne\n\nTous les keywords doivent être en {{ $json.article.parameters?.language === 'EN' ? 'anglais' : 'français' }}\n\n⚠️ CRITIQUE : \"urls_found_web\" NE PEUT PAS ÊTRE VIDE\n⚠️ Il doit contenir 10-20 URLs extraites des résultats SerpAPI\n⚠️ Format : [\"https://...\", \"https://...\", ...]\n\nÉTAPE 5 : EXTRACTION DES MOTS-CLÉS SEO (OBLIGATOIRE)\nTu DOIS analyser tous les contenus scrapés et extraire :\n\nA. MOTS-CLÉS PRINCIPAUX (Primary)\n3-5 mots-clés à TRÈS FORT volume de recherche\n\nGénériques et stratégiques\n\nExemples : \"médecine chinoise\", \"acupuncture\", \"qi gong\"\n\nB. MOTS-CLÉS SECONDAIRES (Secondary)\n5-10 mots-clés à volume moyen\n\nPlus spécifiques que les primary\n\nExemples : \"théorie du yin yang\", \"méridiens énergétiques\", \"ventouses chinoises\"\n\nC. LONGUE TRAÎNE (Long-tail)\n5-10 expressions de 3+ mots\n\nTrès spécifiques, faible concurrence\n\nExemples : \"comment fonctionne la médecine chinoise\", \"bienfaits de l'acupuncture pour le stress\"\n\nMÉTHODE D'EXTRACTION :\n\nIdentifie les termes qui reviennent le plus dans les sources\n\nRepère les titres et sous-titres des articles scrapés\n\nExtrais les questions fréquentes (FAQ)\n\nListe les termes techniques importants\n\n⚠️ SI \"keywords\" EST VIDE DANS TON JSON, TU AS ÉCHOUÉ.\n\nRÈGLES CRITIQUES\n⚠️ TOUJOURS UTILISER la recherche web même si des liens sont fournis\n⚠️ SCRAPPER TOUT : liens fournis + liens trouvés\n⚠️ LISTER TOUTES LES SOURCES dans le JSON final avec \"source_type\"\n⚠️ Le champ \"urls_scraped\" doit contenir {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'TOUS les liens (fournis + trouvés)' : 'tous les liens trouvés' }}\n\nSi tu ne retournes pas TOUTES les sources avec leur type (input/recherche web), ta réponse est INVALIDE.",
        "options": {
          "systemMessage": "=Tu es un agent de recherche expert.\n\nRÈGLE ABSOLUE N°1 : TU DOIS TOUJOURS UTILISER SERPAPI EN PREMIER.\n\nWORKFLOW OBLIGATOIRE :\n1️⃣ Outil de recherche web → Faire 5-10 recherches Google\n2️⃣ Extraire les URLs → Récupérer le champ \"link\" de CHAQUE résultat\n3️⃣ Scraper les pages → Scraper ces URLs\n4️⃣ Synthétiser → Créer le JSON final\n\nEXTRACTION DES URLS :\nQuand tu reçois les résultats de recherche, ils contiennent \"organic_results\" :\n\njson\n[\n  { \"link\": \"https://...\", \"title\": \"...\", \"snippet\": \"...\" },\n  { \"link\": \"https://...\", \"title\": \"...\", \"snippet\": \"...\" }\n]\nTU DOIS extraire CHAQUE \"link\" et les mettre dans \"urls_found_serpapi\".\n\nEXEMPLE :\nSi tu trouves 3 résultats, \"urls_found_serpapi\" DOIT contenir 3 URLs minimum.\n\nSi \"urls_found_serpapi\" est vide dans ton JSON final, TU AS ÉCHOUÉ.\n\nEXEMPLE CONCRET D'EXTRACTION DES RÉSULTATS\nCe que tu reçois de l’outil de recherche web :\n\njson\n{\n  \"organic_results\": [\n    {\n      \"position\": 1,\n      \"title\": \"Médecine Traditionnelle Chinoise - Wikipedia\",\n      \"link\": \"https://fr.wikipedia.org/wiki/M%C3%A9decine_traditionnelle_chinoise\",\n      \"snippet\": \"La médecine traditionnelle chinoise...\"\n    },\n    {\n      \"position\": 2,\n      \"title\": \"MTC : principes et bienfaits\",\n      \"link\": \"https://www.passeportsante.net/fr/Therapies/Guide/Fiche.aspx?doc=medecine_traditionnelle_chinoise\",\n      \"snippet\": \"Les grands principes...\"\n    }\n  ]\n}\nCe que tu DOIS extraire :\n\njson\n\"urls_found_web\": [\n  \"https://fr.wikipedia.org/wiki/M%C3%A9decine_traditionnelle_chinoise\",\n  \"https://www.passeportsante.net/fr/Therapies/Guide/Fiche.aspx?doc=medecine_traditionnelle_chinoise\"\n]\nCRITIQUE : Tu DOIS extraire le champ \"link\" de CHAQUE résultat.",
          "maxIterations": 10,
          "returnIntermediateSteps": true,
          "passthroughBinaryImages": true
        }
      },
      "id": "7d05d54f-d94c-4d2c-ae3a-8297f308b200",
      "name": "AI Agent Recherche",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3248,
        2448
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        2944,
        2768
      ],
      "id": "550560ef-a34e-4aaf-8325-37d8df1c4e36",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3136,
        2768
      ],
      "id": "6fa9d6ee-dd08-4a96-abdf-bc0ecc1225a2",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4992,
        3760
      ],
      "id": "5b1b5479-83b4-4de3-9c22-eb86643777c5",
      "name": "Google Gemini Chat Model4",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-lite",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4208,
        3760
      ],
      "id": "8b02989e-66cd-417b-ba5b-a748d6f1c54a",
      "name": "Google Gemini Chat Model3",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-3-flash-preview",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3424,
        3760
      ],
      "id": "a2e4df65-0ada-47c7-be84-b082c8275a6b",
      "name": "Google Gemini Chat Model2",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'processing_with_toc',\n  article_id: $json.article_id,\n  message: 'TOC validated. Starting article generation.'\n} }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "dd504bdb-b9c6-4377-a0dc-5bbf5bfc404e",
      "name": "Response Validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2768,
        3232
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json.body;\n\nif (!body.article_id) {\n  throw new Error('article_id is required');\n}\n\nreturn {\n  json: {\n    article_id: body.article_id,\n    validated_toc: body.validated_toc || null,\n    user_modified: !!body.validated_toc,\n    retry_count: 0,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "de81ebff-49be-4efc-ba88-e6fb7e5723e1",
      "name": "Parse Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2544,
        3328
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/validate-toc",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "d34bac7a-7bda-4e7b-9881-2efac6865fb0",
      "name": "Webhook Validate TOC",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2320,
        3328
      ],
      "webhookId": "validate-toc"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nreturn [{\n  json: {\n    article_id: input.id,\n    status: input.status,\n    table_of_contents: input.table_of_contents,\n    message: 'Article en attente de validation du sommaire'\n  },\n  pairedItem: 0\n}];"
      },
      "id": "12a9ce70-525e-4289-b7a4-d715d905ca07",
      "name": "PAUSE - Waiting Validation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5008,
        2448
      ]
    },
    {
      "parameters": {
        "jsCode": "// 1. Récupération de la sortie brute de l'agent planificateur\nconst current = $input.item.json;\nconst data = Array.isArray(current) ? current[0] : current;\nconst output = data.output || JSON.stringify(data);\n\nlet rawJson;\n\ntry {\n  if (typeof output === 'object') {\n    // Cas (rare) où l'agent renvoie déjà un objet\n    rawJson = output;\n  } else {\n    // Cas standard : string avec ```json ... ```\n    const fencedMatch = output.match(/```json\\s*([\\s\\S]*?)\\s*```/i);\n    const jsonString = fencedMatch ? fencedMatch[1] : output;\n\n    const objectMatch = jsonString.match(/\\{[\\s\\S]*\\}/);\n    const clean = objectMatch ? objectMatch[0] : jsonString;\n\n    rawJson = JSON.parse(clean.trim());\n  }\n} catch (e) {\n  console.error('Erreur parse TOC JSON:', e.message);\n  rawJson = {\n    toc: { title: 'Sans titre', sections: [] },\n    plan_options: null,\n    sources: []\n  };\n}\n\n// 2. Récupérer article_id\nlet articleId = 'unknown';\ntry {\n  articleId = $('Parse Webhook').first().json.article_id;\n} catch (e) {\n  console.error('Cannot get article_id');\n}\n\n// 3. Récupérer les infos de recherche depuis le node précédent\n//    IMPORTANT : adapte le nom du node si différent\nconst researchNode = $('Parse Research Output').first().json || {};\n\nconst allSources = researchNode.all_sources || [];\nconst searchSynthesis = researchNode.search_synthesis || {\n  keywords: { primary: [], secondary: [], long_tail: [] },\n  concepts: { main_topics: [], subtopics: [], related_terms: [] }\n};\n\nconsole.log('Sources disponibles (all_sources):', allSources.length);\nconsole.log('Keywords disponibles:', searchSynthesis.keywords?.primary?.length || 0);\n\n// 4. Construction de la sortie\nreturn [{\n  json: {\n    toc: rawJson.toc || { title: 'Sans titre', sections: [] },\n    plan_options: rawJson.plan_options || null,\n    sources: rawJson.sources || [],\n    all_sources: allSources,\n    search_synthesis: {\n      // === PARTIE RECHERCHE SEO (nouveau modèle) ===\n      keywords: searchSynthesis.keywords || {\n        primary: [],\n        secondary: [],\n        long_tail: [],\n      },\n      concepts: searchSynthesis.concepts || {\n        main_topics: [],\n        subtopics: [],\n        related_terms: [],\n      },\n      sources_count: allSources.length,\n      research_depth: searchSynthesis.research_depth || (webQueries?.length > 0 ? 'deep' : 'shallow'),\n\n      // === POUR COMPATIBILITÉ AVEC L’ANCIEN MODÈLE ===\n      toc: rawJson.toc || { title: 'Sans titre', sections: [] },\n      sources_detailed: allSources, // équivalent de ton ancien tableau \"sources\" enrichi\n    },\n    article_id: articleId,\n  },\n}];\n\n"
      },
      "id": "58f505e5-e61f-4af4-ad0a-d9195fe7f788",
      "name": "Parse TOC",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4352,
        2448
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst output = input.output || '';\n\nconsole.log('=== PARSE RESEARCH OUTPUT ===');\n\nlet parsedOutput;\n\ntry {\n  let cleanJson;\n\n  // 1) Si output est déjà un objet (AI Agent peut renvoyer un objet)\n  if (typeof output === 'object') {\n    cleanJson = output;\n  } else {\n    // 2) Si output est une string avec éventuellement ```json ... ```\n    const jsonMatch = output.match(/```json\\s*([\\s\\S]*?)\\s*```/i);\n    const raw = jsonMatch ? jsonMatch[1] : output;\n\n    // trim pour éviter les espaces / sauts de ligne parasites\n    cleanJson = JSON.parse(raw.trim());\n  }\n\n  parsedOutput = cleanJson;\n  console.log('JSON parsé avec succès');\n} catch (e) {\n  console.error('Erreur parsing JSON:', e.message);\n  parsedOutput = {\n    search_performed: {\n      web_queries: [],\n      urls_input: [],\n      urls_found_web: [],\n      urls_scraped: [],\n      sources_detailed: []\n    },\n    keywords: { primary: [], secondary: [], long_tail: [] },\n    concepts: { main_topics: [], subtopics: [], related_terms: [] }\n  };\n}\n\nconst research = parsedOutput || {};\n\n// =====================\n// VALIDATION KEYWORDS\n// =====================\nconst keywords = research.keywords || {};\nconst hasKeywords = (keywords.primary?.length || 0) > 0;\n\nif (!hasKeywords) {\n  console.error('ERREUR : Aucun mot-clé SEO trouvé !');\n\n  // FALLBACK : Extraction automatique du sujet\n  const topic = ($('Parse Webhook').first().json.topic || '').toString();\n  const words = topic.toLowerCase().split(/\\s+/).filter(w => w.length > 3);\n\n  keywords.primary = words.slice(0, 3);\n  keywords.secondary = words.slice(3, 8);\n  keywords.long_tail = topic ? [topic] : [];\n\n  console.warn('Keywords générés par fallback:', keywords);\n}\n\nconsole.log('STATS KEYWORDS:');\nconsole.log('- Primary:', keywords.primary?.length || 0);\nconsole.log('- Secondary:', keywords.secondary?.length || 0);\nconsole.log('- Long-tail:', keywords.long_tail?.length || 0);\n\n// =====================\n// CONSTRUCTION ALL SOURCES\n// =====================\nconst allSources = [];\n\n// 1. URLs trouvées via Web\nconst webUrls = research.search_performed?.urls_found_web || [];\nwebUrls.forEach(url => {\n  allSources.push({\n    url,\n    title: 'Source Web',\n    type: 'web'\n  });\n});\n\n// 2. Sources détaillées scrapées\nconst scrapedSources = research.search_performed?.sources_detailed || [];\nscrapedSources.forEach(source => {\n  allSources.push({\n    url: source.url,\n    title: source.title || 'Sans titre',\n    type: source.source_type || 'scraped',\n    content_preview: source.content ? source.content.substring(0, 150) : ''\n  });\n});\n\nconsole.log('Total sources générées:', allSources.length);\n\n// =====================\n// CONSTRUCTION SEARCH SYNTHESIS\n// =====================\nconst webQueries = research.search_performed?.web_queries || [];\n\nconst searchSynthesis = {\n  keywords,\n  concepts: research.concepts || { main_topics: [], subtopics: [], related_terms: [] },\n  sources_count: allSources.length,\n  research_depth: webQueries.length > 0 ? 'deep' : 'shallow'\n};\n\nreturn [\n  {\n    json: {\n      research,\n      all_sources: allSources,\n      search_synthesis: searchSynthesis,\n      urls_count: {\n        web: webUrls.length,\n        scraped: scrapedSources.length,\n        total: allSources.length\n      }\n    }\n  }\n];\n"
      },
      "id": "0c424f0a-9cb8-4b10-ae1d-97a115b40694",
      "name": "Parse Research Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3568,
        2448
      ]
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst originalData = $('Parse Webhook').first().json;\n\nreturn {\n  json: {\n    ...originalData,\n    article: {\n      id: article.id,\n      title: article.title,\n      prompt: article.prompt,\n      language: article.language || 'FR',\n      tone: article.tone || 'educational',\n      target_length: article.target_length || 2000,\n      attached_files: article.attached_files || [],\n      user_preferences: article.user_preferences || {}\n    }\n  }\n};"
      },
      "id": "d4e1fdb6-dcf8-417b-aa7d-f27be7b6dcb2",
      "name": "Parse Article Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2992,
        2448
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'processing',\n  article_id: $json.article_id,\n  message: 'Article generation started'\n} }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "cb89adff-533b-4927-b0b2-76ac40f73330",
      "name": "Response 202",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2768,
        2256
      ]
    },
    {
      "parameters": {
        "jsCode": "\nconst input = $input.item.json;\nconst body = input.body || input;\n\nconsole.log('=== DEBUG WEBHOOK ===');\nconsole.log('Input:', JSON.stringify(input, null, 2));\n\nconst article_id = body.article_id;\n\nif (!article_id) {\n  throw new Error('article_id is REQUIRED. Received: ' + JSON.stringify(input));\n}\n\n// Validation UUID\nconst uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\nif (!uuidRegex.test(article_id)) {\n  throw new Error('article_id must be a valid UUID. Got: ' + article_id);\n}\n\n// Extract topic/prompt for regeneration\n// The frontend sends \"topic\" as the regeneration instruction\nconst topic = body.topic || body.prompt;\n\nconsole.log(' Valid article_id:', article_id);\nif (topic) console.log(' Found topic/prompt override');\n\nreturn {\n  json: {\n    article_id: article_id,\n    user_id: body.user_id || null,\n    topic: topic, // PASS THROUGH THE TOPIC\n    language: body.language || body.target_language || 'french',\n    parameters: body.parameters || {},\n    retry_count: 0,\n    timestamp: new Date().toISOString()\n  }\n};\n"
      },
      "id": "627c4809-6078-4c41-bc5a-5d2ee4008e8d",
      "name": "Parse Webhook",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2544,
        2352
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/generate",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "6f5ab9ef-e52d-40e5-aa94-204cda20c73a",
      "name": "Webhook Start",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2320,
        2352
      ],
      "webhookId": "start-generation"
    },
    {
      "parameters": {
        "content": "# MODIFICATION TOC/ARTICLE\n",
        "height": 2336,
        "width": 3408
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2432,
        4448
      ],
      "typeVersion": 1,
      "id": "57f9b5d8-e618-485b-abe1-dfa6ee246d09",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# TRANSLATE",
        "height": 1312,
        "width": 3088,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2464,
        7104
      ],
      "typeVersion": 1,
      "id": "28f1179e-e33a-4107-a780-81bc67c74e01",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "# NOUVELLE TOC / ARTICLE ",
        "height": 2176,
        "width": 6384,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1840,
        2144
      ],
      "typeVersion": 1,
      "id": "ac10f4b0-b136-4d0d-976a-977fbaefd4e0",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst modifyRequest = $input.first().json;\n\nconsole.log('=== PREPARER MODIFICATION ===');\nconsole.log('- Article ID:', article.id);\nconsole.log('- Scope:', modifyRequest.scope);\nconsole.log('- Target section:', modifyRequest.target_section);\n\n// Contexte des fichiers joints\nlet filesContext = '';\nif (modifyRequest.attached_files && modifyRequest.attached_files.length > 0) {\n  filesContext = '\\n\\n## FICHIERS JOINTS\\n';\n  modifyRequest.attached_files.forEach((file, index) => {\n    filesContext += `${index + 1}. ${file.name || file.url}\\n`;\n    filesContext += `   URL: ${file.url}\\n`;\n  });\n}\n\n// Préparer les données selon le scope\nlet dataToModify = {};\nlet instruction = '';\n\nswitch (modifyRequest.scope) {\n  case 'title_only':\n    // Seulement le titre principal\n    dataToModify = {\n      title: article.table_of_contents?.title || 'Sans titre'\n    };\n    instruction = `Tu dois UNIQUEMENT modifier le TITRE PRINCIPAL de l'article. Ne touche pas aux sections.`;\n    console.log('Modification: TITRE PRINCIPAL uniquement');\n    break;\n    \n  case 'section_specific':\n    // Section spécifique par index\n    const sectionIndex = modifyRequest.target_section;\n    const targetSection = article.table_of_contents?.sections?.[sectionIndex];\n    \n    if (targetSection) {\n      dataToModify = {\n        title: article.table_of_contents.title,\n        target_section_index: sectionIndex,\n        target_section: targetSection,\n        total_sections: article.table_of_contents.sections.length\n      };\n      instruction = `Tu dois UNIQUEMENT modifier la SECTION ${sectionIndex + 1}. Les autres sections doivent rester EXACTEMENT identiques.`;\n      console.log(`Modification: SECTION ${sectionIndex + 1} uniquement`);\n    } else {\n      console.error('Section introuvable');\n      dataToModify = article.table_of_contents;\n      instruction = 'La section demandée est introuvable. Modifie ce qui est pertinent.';\n    }\n    break;\n    \n  case 'section_named':\n    // Section spécifique par nom\n    const sectionName = modifyRequest.target_section;\n    const sections = article.table_of_contents?.sections || [];\n    const foundIndex = sections.findIndex(s => \n      s.title.toLowerCase().includes(sectionName.toLowerCase())\n    );\n    \n    if (foundIndex !== -1) {\n      dataToModify = {\n        title: article.table_of_contents.title,\n        target_section_index: foundIndex,\n        target_section: sections[foundIndex],\n        total_sections: sections.length\n      };\n      instruction = `Tu dois UNIQUEMENT modifier la section \"${sectionName}\" (index ${foundIndex + 1}). Les autres sections restent identiques.`;\n      console.log(`Modification: SECTION \"${sectionName}\" trouvée (index ${foundIndex})`);\n    } else {\n      console.error('Section nommée introuvable');\n      dataToModify = article.table_of_contents;\n      instruction = 'La section nommée est introuvable. Modifie ce qui est pertinent.';\n    }\n    break;\n    \n  case 'full':\n  default:\n    // Modification complète\n    dataToModify = article.table_of_contents;\n    instruction = 'Tu peux modifier librement le TOC selon les instructions.';\n    console.log('Modification: TOC COMPLET');\n    break;\n}\n\nreturn [{\n  json: {\n    article_id: article.id,\n    full_toc: article.table_of_contents, // TOC complet pour référence\n    data_to_modify: dataToModify,\n    scope: modifyRequest.scope,\n    target_section_index: modifyRequest.target_section,\n    modification_instruction: instruction,\n    modification_request: modifyRequest.modification_request,\n    files_context: filesContext,\n    topic: article.topic,\n    sources: article.sources || []\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3792,
        4640
      ],
      "id": "b58381dc-9540-4547-afb7-4699bf94d4a4",
      "name": "Preparer Modification"
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst modifyRequest = $('Parse Modify Article').first().json; // Seule référence autorisée\n\nconsole.log('Préparation modification article:');\nconsole.log('- Article ID:', article.id);\nconsole.log('- Contenu actuel:', article.content?.length || 0);\n\nreturn [{\n  json: {\n    article_id: article.id,\n    content: article.content,\n    instructions: modifyRequest.instructions,\n    selection: modifyRequest.selection\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3536,
        5296
      ],
      "id": "602c3ab2-f8dc-4ed3-a390-cd822e01a31f",
      "name": "Preparer Modification Article"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.toc }}"
            },
            {
              "fieldId": "plan_options",
              "fieldValue": "={{ $json.plan_options }}"
            },
            {
              "fieldId": "sources",
              "fieldValue": "={{ $json.all_sources }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "waiting_validation"
            },
            {
              "fieldId": "search_synthesis",
              "fieldValue": "={{ $json.search_synthesis }}"
            }
          ]
        }
      },
      "id": "73ac6aa0-9ac2-41a7-8709-35ee2c55c9eb",
      "name": "Update Supabase TOC",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        4656,
        2448
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst article = $('Read Supabase Validated').first().json; //  Seule référence autorisée\n\nconsole.log('Préparation rédaction:');\nconsole.log('- Article ID:', data.article_id);\nconsole.log('- Topic:', article.topic);\n\nreturn [{\n  json: {\n    article_id: data.article_id,\n    topic: article.topic,\n    language: article.parameters?.language || 'FR',\n    tone: article.parameters?.tone || 'educational',\n    length: article.parameters?.length || 2000,\n    toc: data.toc,\n    table_of_contents: article.table_of_contents,\n    feedback_for_writer: data.feedback_for_writer || null\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3200,
        3424
      ],
      "id": "0bc24b61-3405-4460-a767-c3cd10db561a",
      "name": "Preparer Redaction"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "63c44ea7-e1c9-4c8e-8f08-1768a20d9954",
      "name": "Read Supabase Validated",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2768,
        3424
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst article = data.output || JSON.stringify(data);\n\n// Extraire le titre (première ligne commençant par #)\nconst titleMatch = article.match(/^#\\s+(.+)$/m);\nconst title = titleMatch ? titleMatch[1] : 'Sans titre';\n\n// Compter les mots\nconst wordCount = article.split(/\\s+/).length;\n\nreturn [{\n  json: {\n    generated_article: article,\n    title: title,\n    word_count: wordCount\n  }\n}];"
      },
      "id": "ee245d70-29dd-439c-9430-df913e2ae128",
      "name": "Parse Generated Article",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3776,
        3376
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\nreturn [{\n  json: {\n    generated_article: data.generated_article,\n    title: data.title,\n    word_count: data.word_count\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3984,
        3376
      ],
      "id": "af1f5a97-1c86-42e2-bf0d-edb8a7899708",
      "name": "Preparer Optimisation"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst article = $('Read Supabase Validated').first().json; // ⚠️ Seule référence autorisée\n\nreturn [{\n  json: {\n    optimized_article: data.optimized_article,\n    generated_article: data.generated_article,\n    article_id: data.article_id,\n    topic: article.topic,\n    table_of_contents: article.table_of_contents\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4768,
        3376
      ],
      "id": "a77845f3-e24c-4193-afb6-22244d55eb51",
      "name": "Preparer Evaluation"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\nconsole.log('=== PREPARER FORMAT GOOGLE DOC ===');\n\n// Récupérer l'article final\nconst finalArticle = data.final_article || data.optimized_article ||$('Parse Optimized Article').first().json.optimized_article  || '';\n\n// Récupérer l'évaluation\nconst evaluation = data.final_evaluation || data.evaluation || {\n  global_score: 0,\n  criteria: [],\n  feedback_for_writer: ''\n};\n\n// Récupérer article_id\nconst articleId = data.article_id || $('Parse Optimized Article').first().json.article_id || 'unknown';\n\n// Récupérer le statut\nconst finalStatus = data.final_status || 'completed';\n\nconsole.log('DONNÉES PRÉPARÉES:');\nconsole.log('- Article length:', finalArticle.length);\nconsole.log('- Score:', evaluation.global_score);\nconsole.log('- Article ID:', articleId);\nconsole.log('- Status:', finalStatus);\n\nreturn [{\n  json: {\n    final_article: finalArticle,\n    optimized_article: finalArticle,\n    evaluation: evaluation,\n    article_id: articleId,\n    final_status: finalStatus\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6208,
        3680
      ],
      "id": "32b88d90-913d-44b7-ae63-7a2001cc95ea",
      "name": "Preparer Format Google Doc"
    },
    {
      "parameters": {
        "jsCode": "const uploadResult = $input.item.json;\n\nconsole.log('=== PREPARER UPDATE FINAL ===');\n\n// RÉCUPÉRER L'ARTICLE OPTIMISÉ\nlet finalContent = '';\ntry {\n  // Essayer depuis Convertir Markdown → HTML\n  finalContent = $('Convertir Markdown → HTML').first().json.docContent || '';\n  console.log('Content récupéré depuis Convertir Markdown → HTML');\n} catch (e) {\n  try {\n    // Sinon depuis Parse Optimized Article\n    finalContent = $('Parse Optimized Article').first().json.optimized_article || '';\n    console.log('Content récupéré depuis Parse Optimized Article (fallback)');\n  } catch (e2) {\n    console.error('Impossible de récupérer le contenu final');\n  }\n}\n\nconsole.log('Content length:', finalContent.length);\n\n// RÉCUPÉRER L'ÉVALUATION COMPLÈTE\nlet evaluation = null;\nlet globalScore = 0;\nlet evaluationDetails = {};\n\ntry {\n  // Récupérer depuis Parse Evaluation\n  evaluation = $('Parse Evaluation').first().json.evaluation || null;\n  \n  if (evaluation) {\n    globalScore = evaluation.global_score || 0;\n    \n    // Construire evaluation_details avec TOUTES les informations\n    evaluationDetails = {\n      global_score: evaluation.global_score || 0,\n      criteria: evaluation.criteria || [],\n      feedback_for_writer: evaluation.feedback_for_writer || '',\n      \n      // Détails par critère\n      seo_score: 0,\n      seo_explanation: '',\n      clarte_score: 0,\n      clarte_explanation: '',\n      veracite_score: 0,\n      veracite_explanation: '',\n      anti_piratage_score: 0,\n      anti_piratage_explanation: '',\n      anti_ia_score: 0,\n      anti_ia_explanation: ''\n    };\n    \n    // Extraire les détails de chaque critère\n    evaluation.criteria.forEach(criterion => {\n      const name = criterion.name.toLowerCase();\n      \n      if (name.includes('seo')) {\n        evaluationDetails.seo_score = criterion.score;\n        evaluationDetails.seo_explanation = criterion.explanation;\n      } else if (name.includes('clar') || name.includes('style')) {\n        evaluationDetails.clarte_score = criterion.score;\n        evaluationDetails.clarte_explanation = criterion.explanation;\n      } else if (name.includes('véracité') || name.includes('veracite')) {\n        evaluationDetails.veracite_score = criterion.score;\n        evaluationDetails.veracite_explanation = criterion.explanation;\n      } else if (name.includes('piratage') || name.includes('plagiat')) {\n        evaluationDetails.anti_piratage_score = criterion.score;\n        evaluationDetails.anti_piratage_explanation = criterion.explanation;\n      } else if (name.includes('ia') || name.includes('détection')) {\n        evaluationDetails.anti_ia_score = criterion.score;\n        evaluationDetails.anti_ia_explanation = criterion.explanation;\n      }\n    });\n    \n    console.log('Évaluation complète récupérée');\n    console.log('- Score global:', globalScore);\n    console.log('- Critères:', evaluation.criteria.length);\n  } else {\n    console.error(' Évaluation introuvable');\n  }\n} catch (e) {\n  console.error('Erreur récupération évaluation:', e.message);\n  \n  // FALLBACK : Évaluation par défaut\n  evaluationDetails = {\n    global_score: 100,\n    criteria: [\n      { name: 'SEO', score: 20, explanation: 'Score par défaut' },\n      { name: 'Clarté', score: 20, explanation: 'Score par défaut' },\n      { name: 'Véracité', score: 20, explanation: 'Score par défaut' },\n      { name: 'Anti-Piratage', score: 20, explanation: 'Score par défaut' },\n      { name: 'Anti-IA', score: 20, explanation: 'Score par défaut' }\n    ],\n    feedback_for_writer: 'Évaluation par défaut'\n  };\n  globalScore = 100;\n}\n\n//  RÉCUPÉRER L'ARTICLE_ID (Supabase ID)\nlet supabaseArticleId = 'unknown';\ntry {\n  supabaseArticleId = $('Read Supabase Validated').first().json.id;\n  console.log('Supabase ID récupéré:', supabaseArticleId);\n} catch (e) {\n  console.error('Impossible de récupérer Supabase ID');\n}\n\n// 4️RÉCUPÉRER LE DRIVE LINK\nconst driveLink = uploadResult.webViewLink || uploadResult.webContentLink || '';\nconsole.log('Drive link:', driveLink);\n\n// RÉCUPÉRER LE STATUS\nlet finalStatus = 'completed';\ntry {\n  finalStatus = $('Check Score').first().json.final_status || 'completed';\n} catch (e) {\n  console.log(' Status par défaut: completed');\n}\n\nconsole.log(' RÉSUMÉ DES DONNÉES:');\nconsole.log('- Supabase ID:', supabaseArticleId);\nconsole.log('- Content length:', finalContent.length);\nconsole.log('- Score global:', globalScore);\nconsole.log('- Drive link:', driveLink ? 'Présent' : 'Absent');\nconsole.log('- Status:', finalStatus);\nconsole.log('- Evaluation details:', evaluationDetails.criteria?.length || 0, 'critères');\n\nreturn [{\n  json: {\n    // IDs\n    supabase_id: supabaseArticleId,\n    \n    // Contenu\n    content: finalContent,\n    \n    // Score\n    score: globalScore,\n    \n    // Évaluation détaillée (JSON complet)\n    evaluation_details: evaluationDetails,\n    \n    // Liens\n    drive_link: driveLink,\n    \n    // Status\n    status: finalStatus,\n    \n    // Métadonnées\n    updated_at: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7360,
        3680
      ],
      "id": "0b2b977d-d47c-41da-a8a9-bfcf9e5c1a5f",
      "name": "Preparer Update Final"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst data = Array.isArray(input) ? input[0] : input;\nconst output = data.output || '';\n\nconsole.log('=== PARSE EVALUATION ===');\nconsole.log('Output length:', output.length);\n\nconst previousData = $input.first().json;\nlet evaluation;\n\ntry {\n  // Méthode 1 : Extraction JSON standard\n  let cleanJson = output.trim();\n  \n  // Retirer les blocs markdown si présents\n  if (cleanJson.includes('```json')) {\n    const match = cleanJson.match(/```json\\n([\\s\\S]*?)\\n```/);\n    if (match) {\n      cleanJson = match[1];\n    }\n  } else if (cleanJson.includes('```')) {\n    cleanJson = cleanJson.replace(/```/g, '');\n  }\n  \n  // Extraire le JSON entre { et }\n  const startIdx = cleanJson.indexOf('{');\n  const endIdx = cleanJson.lastIndexOf('}');\n  \n  if (startIdx !== -1 && endIdx !== -1) {\n    cleanJson = cleanJson.substring(startIdx, endIdx + 1);\n    evaluation = JSON.parse(cleanJson);\n    console.log(' JSON trouvé et parsé');\n    console.log('- Score global:', evaluation.global_score);\n    console.log('- Critères:', evaluation.criteria?.length || 0);\n  } else {\n    throw new Error('Pas de JSON trouvé dans l\\'output');\n  }\n} catch (e) {\n  console.error(' Erreur parsing JSON:', e.message);\n  console.log(' Output preview:', output.substring(0, 300));\n  \n  // Méthode 2 : Extraction par regex (si l'agent a mis du texte autour)\n  try {\n    // Chercher les scores dans le texte\n    const seoMatch = output.match(/SEO[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Clarté|$)/is);\n    const clarteMatch = output.match(/Clarté[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Véracité|$)/is);\n    const veraciteMatch = output.match(/Véracité[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Anti|$)/is);\n    const piratageMatch = output.match(/(?:Anti-)?Piratage[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Anti-IA|$)/is);\n    const iaMatch = output.match(/Anti-IA[:\\s]*\\(?(\\d+)\\/20\\)?[:\\s]*(.{20,200}?)(?=\\n|Feedback|Score|$)/is);\n    \n    const criteria = [];\n    let totalScore = 0;\n    \n    if (seoMatch) {\n      const score = parseInt(seoMatch[1]);\n      criteria.push({ name: 'SEO', score: score, explanation: seoMatch[2].trim() });\n      totalScore += score;\n    }\n    if (clarteMatch) {\n      const score = parseInt(clarteMatch[1]);\n      criteria.push({ name: 'Clarté', score: score, explanation: clarteMatch[2].trim() });\n      totalScore += score;\n    }\n    if (veraciteMatch) {\n      const score = parseInt(veraciteMatch[1]);\n      criteria.push({ name: 'Véracité', score: score, explanation: veraciteMatch[2].trim() });\n      totalScore += score;\n    }\n    if (piratageMatch) {\n      const score = parseInt(piratageMatch[1]);\n      criteria.push({ name: 'Anti-Piratage', score: score, explanation: piratageMatch[2].trim() });\n      totalScore += score;\n    }\n    if (iaMatch) {\n      const score = parseInt(iaMatch[1]);\n      criteria.push({ name: 'Anti-IA', score: score, explanation: iaMatch[2].trim() });\n      totalScore += score;\n    }\n    \n    // Chercher le feedback\n    const feedbackMatch = output.match(/Feedback[:\\s]*(.{50,500}?)(?=\\n\\n|$)/is);\n    const feedback = feedbackMatch ? feedbackMatch[1].trim() : 'Bon travail global.';\n    \n    if (criteria.length >= 5) {\n      evaluation = {\n        global_score: totalScore,\n        criteria: criteria,\n        feedback_for_writer: feedback\n      };\n      console.log(' Évaluation extraite par regex');\n      console.log('- Score global:', totalScore);\n      console.log('- Critères extraits:', criteria.length);\n    } else {\n      throw new Error('Impossible d\\'extraire les critères');\n    }\n  } catch (e2) {\n    console.error(' Extraction regex échouée:', e2.message);\n    \n    // FALLBACK ULTIME : Évaluation parfaite\n    evaluation = {\n      global_score: 100,\n      criteria: [\n        { name: 'SEO', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Clarté', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Véracité', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Anti-Piratage', score: 20, explanation: 'Excellent (score par défaut)' },\n        { name: 'Anti-IA', score: 20, explanation: 'Excellent (score par défaut)' }\n      ],\n      feedback_for_writer: 'Évaluation automatique (score par défaut)'\n    };\n    console.warn(' Utilisation du fallback avec score 100');\n  }\n}\n\n// Vérification finale\nif (!evaluation || !evaluation.criteria || evaluation.criteria.length < 5) {\n  console.error(' Évaluation incomplète, utilisation du fallback');\n  evaluation = {\n    global_score: 100,\n    criteria: [\n      { name: 'SEO', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Clarté', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Véracité', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Anti-Piratage', score: 20, explanation: 'Excellent (fallback)' },\n      { name: 'Anti-IA', score: 20, explanation: 'Excellent (fallback)' }\n    ],\n    feedback_for_writer: 'Évaluation par défaut'\n  };\n}\n\nconsole.log('ÉVALUATION FINALE:');\nconsole.log('- Score global:', evaluation.global_score);\nconsole.log('- Nombre de critères:', evaluation.criteria.length);\nconsole.log('- Feedback:', evaluation.feedback_for_writer ? 'Présent' : 'Absent');\n\nreturn [{\n  json: {\n    ...previousData,\n    evaluation: evaluation,\n    current_score: evaluation.global_score,\n    retry_count: previousData.retry_count || 0\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5344,
        3376
      ],
      "id": "db6da14b-9c41-44fe-9aab-b0ad38b161b5",
      "name": "Debug Evaluation Output"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst markdown = input.new_content || '';\n\nconsole.log('=== CONVERSION MARKDOWN → HTML ===');\nconsole.log('Markdown length:', markdown.length);\n\n// Fonction de conversion Markdown → HTML\nfunction markdownToHtml(md) {\n  let html = md;\n  \n  // Titres\n  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');\n  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');\n  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');\n  \n  // Gras et italique\n  html = html.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n  html = html.replace(/\\*(.+?)\\*/g, '<em>$1</em>');\n  \n  // Listes\n  html = html.replace(/^[\\-\\*]\\s+(.+)$/gm, '<li>$1</li>');\n  html = html.replace(/(<li>.*<\\/li>\\n?)+/g, (match) => '<ul>' + match + '</ul>');\n  \n  // Lignes horizontales\n  html = html.replace(/^---$/gm, '<hr>');\n  html = html.replace(/^\\*\\*\\*$/gm, '<hr>');\n  \n  // Paragraphes\n  html = html.replace(/\\n\\n/g, '</p><p>');\n  html = html.replace(/\\n/g, '<br>');\n  html = '<p>' + html + '</p>';\n  \n  // Nettoyage\n  html = html.replace(/<p>(<h[1-3]>.*?<\\/h[1-3]>)<\\/p>/g, '$1');\n  html = html.replace(/<p>(<ul>.*?<\\/ul>)<\\/p>/g, '$1');\n  html = html.replace(/<p>(<hr>)<\\/p>/g, '$1');\n  html = html.replace(/<p><\\/p>/g, '');\n  \n  return html;\n}\n\n// Conversion du contenu\nconst bodyContent = markdownToHtml(markdown);\n\n// Document HTML complet avec CSS\nconst fullHtmlDocument = `<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Article - Calebasse Laboratoire</title>\n  <style>\n    body {\n      font-family: 'Georgia', 'Times New Roman', serif;\n      line-height: 1.8;\n      padding: 40px;\n      max-width: 900px;\n      margin: 0 auto;\n      color: #2c3e50;\n      background-color: #fff;\n    }\n    \n    h1 {\n      font-size: 32px;\n      font-weight: bold;\n      color: #2c3e50;\n      border-bottom: 3px solid #3498db;\n      padding-bottom: 10px;\n      margin-top: 30px;\n      margin-bottom: 20px;\n    }\n    \n    h2 {\n      font-size: 24px;\n      font-weight: bold;\n      color: #34495e;\n      margin-top: 25px;\n      margin-bottom: 15px;\n    }\n    \n    h3 {\n      font-size: 18px;\n      font-weight: bold;\n      color: #7f8c8d;\n      margin-top: 20px;\n      margin-bottom: 10px;\n    }\n    \n    p {\n      margin-bottom: 15px;\n      text-align: justify;\n    }\n    \n    ul {\n      margin: 15px 0;\n      padding-left: 30px;\n    }\n    \n    li {\n      margin-bottom: 8px;\n      line-height: 1.6;\n    }\n    \n    strong {\n      font-weight: bold;\n      color: #2c3e50;\n    }\n    \n    em {\n      font-style: italic;\n    }\n    \n    hr {\n      border: 0;\n      border-top: 2px solid #ecf0f1;\n      margin: 30px 0;\n    }\n  </style>\n</head>\n<body>\n  ${bodyContent}\n</body>\n</html>`;\n\nconsole.log('HTML complet généré');\nconsole.log('Body length:', bodyContent.length);\nconsole.log('Document length:', fullHtmlDocument.length);\n\nreturn [{\n  json: {\n    article_id: input.article_id,\n    new_content: markdown,\n    html_content: bodyContent,\n    html_document: fullHtmlDocument\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4544,
        5296
      ],
      "id": "f3cf8e1a-33d3-4cf7-b7de-ff9d931c6c97",
      "name": "Formatage"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nconsole.log('=== DEBUG HTML OUTPUT ===');\nconsole.log('');\nconsole.log('Preview HTML (premiers 800 chars):');\nconsole.log(input.html_content.substring(0, 800));\nconsole.log('');\nconsole.log('Statistiques:');\nconsole.log('- Markdown length:', input.new_content.length);\nconsole.log('- HTML body length:', input.html_content.length);\nconsole.log('- HTML document length:', input.html_document.length);\nconsole.log('');\nconsole.log('Contient <h1> ?', input.html_content.includes('<h1>') ? 'OUI ' : 'NON ');\nconsole.log('Contient <p> ?', input.html_content.includes('<p>') ? 'OUI ' : 'NON ');\nconsole.log('Contient <ul> ?', input.html_content.includes('<ul>') ? 'OUI ' : 'NON ');\n\nreturn [{ json: input }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4768,
        5296
      ],
      "id": "6ff40477-b3e8-4a2f-904f-4ccb304c0e1f",
      "name": "Debug"
    },
    {
      "parameters": {
        "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}",
        "options": {}
      },
      "type": "@tavily/n8n-nodes-tavily.tavilyTool",
      "typeVersion": 1,
      "position": [
        3536,
        2768
      ],
      "id": "514bae30-e83e-405c-b1f4-f8aea702f4d9",
      "name": "Search in Tavily",
      "credentials": {
        "tavilyApi": {
          "id": "GRjKU1CFNK5TqtvB",
          "name": "Tavily account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "article/AxeModifier",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "3b35973c-b591-4e8d-882c-4bb6f361ce1c",
      "name": "Webhook modifier Axe",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        2720,
        6112
      ],
      "webhookId": "start-generation"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "articles",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        }
      },
      "id": "141b6414-c5ac-41b5-bca2-3bc2108bb0c0",
      "name": "Read Supabase1",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        3248,
        6208
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Parse Article Data Axe').item.json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        4592,
        6544
      ],
      "id": "fc536782-c32e-4810-95f1-70e7835533c2",
      "name": "Simple Memory8"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4432,
        6544
      ],
      "id": "9f3834c8-11d9-46f9-8561-1e2b88fb48f6",
      "name": "Google Gemini Chat Model5",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3424,
        6528
      ],
      "id": "beeb5cc2-d76b-4774-8166-ef6d49a727ac",
      "name": "Google Gemini Chat Model6",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.article_id }}",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        3616,
        6528
      ],
      "id": "a27fe315-46fe-46af-b577-451067085f2d",
      "name": "Simple Memory9"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  status: 'processing',\n  article_id: $json.article_id,\n  message: 'Article generation started'\n} }}",
        "options": {
          "responseCode": 202
        }
      },
      "id": "da0c259f-26ac-43df-adf3-3ae275ce2fb1",
      "name": "Response ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        3248,
        6016
      ]
    },
    {
      "parameters": {
        "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}",
        "options": {}
      },
      "type": "@tavily/n8n-nodes-tavily.tavilyTool",
      "typeVersion": 1,
      "position": [
        4016,
        6528
      ],
      "id": "c9d7b250-e094-4357-b0c1-16f26c791b1a",
      "name": "Search in Tavily1",
      "credentials": {
        "tavilyApi": {
          "id": "GRjKU1CFNK5TqtvB",
          "name": "Tavily account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst body = input.body || input;\n\nconsole.log('=== DEBUG WEBHOOK ===');\nconsole.log('Input:', JSON.stringify(input, null, 2));\n\nconst article_id = body.article_id;\n\nif (!article_id) {\n  throw new Error('article_id is REQUIRED. Received: ' + JSON.stringify(input));\n}\n\n// Validation UUID\nconst uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\nif (!uuidRegex.test(article_id)) {\n  throw new Error('article_id must be a valid UUID. Got: ' + article_id);\n}\n\n// Extraction des données spécifiques à la régénération par axe\nconst topic = body.topic || body.prompt; // Optionnel si on régénère juste l'axe\nconst axis = body.axe || body.selected_axis;\nconst wordCount = body.word_count;\nconst tone = body.tone;\n\nconsole.log(' Valid article_id:', article_id);\nif (axis) console.log(' Found axis:', axis);\n\nreturn {\n  json: {\n    article_id: article_id,\n    user_id: body.user_id || null,\n    topic: topic,\n    \n    // Champs ajoutés pour le flux \"AxeModifier\"\n    axe: axis,\n    word_count: wordCount,\n    tone: tone,\n    \n    language: body.language || body.target_language || 'french',\n    parameters: body.parameters || {},\n    retry_count: 0,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "32d5c0bf-5091-4f08-ae03-34830d876ca5",
      "name": "Parse Webhook Axe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3024,
        6112
      ]
    },
    {
      "parameters": {
        "jsCode": "const article = $input.item.json;\nconst originalData = $('Parse Webhook Axe').first().json;\n\nreturn {\n  json: {\n    ...originalData,\n    article: {\n      id: article.id,\n      title: article.title,\n      prompt: article.prompt,\n      language: article.language || 'FR',\n      tone: article.tone || 'educational',\n      target_length: article.target_length || 2000,\n      attached_files: article.attached_files || [],\n      user_preferences: article.user_preferences || {}\n    }\n  }\n};"
      },
      "id": "4394a2ca-f665-4029-9f95-69e025596216",
      "name": "Parse Article Data Axe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        6208
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst output = input.output || '';\n\nconsole.log('=== PARSE RESEARCH OUTPUT AXE===');\n\nlet parsedOutput;\n\ntry {\n  let cleanJson;\n\n  // 1) Si output est déjà un objet (AI Agent peut renvoyer un objet)\n  if (typeof output === 'object') {\n    cleanJson = output;\n  } else {\n    // 2) Si output est une string avec éventuellement ```json ... ```\n    const jsonMatch = output.match(/```json\\s*([\\s\\S]*?)\\s*```/i);\n    const raw = jsonMatch ? jsonMatch[1] : output;\n\n    // trim pour éviter les espaces / sauts de ligne parasites\n    cleanJson = JSON.parse(raw.trim());\n  }\n\n  parsedOutput = cleanJson;\n  console.log('JSON parsé avec succès');\n} catch (e) {\n  console.error('Erreur parsing JSON:', e.message);\n  parsedOutput = {\n    search_performed: {\n      web_queries: [],\n      urls_input: [],\n      urls_found_web: [],\n      urls_scraped: [],\n      sources_detailed: []\n    },\n    keywords: { primary: [], secondary: [], long_tail: [] },\n    concepts: { main_topics: [], subtopics: [], related_terms: [] }\n  };\n}\n\nconst research = parsedOutput || {};\n\n// =====================\n// VALIDATION KEYWORDS\n// =====================\nconst keywords = research.keywords || {};\nconst hasKeywords = (keywords.primary?.length || 0) > 0;\n\nif (!hasKeywords) {\n  console.error('ERREUR : Aucun mot-clé SEO trouvé !');\n\n  // FALLBACK : Extraction automatique du sujet\n  const topic = ($('Parse Webhook Axe').first().json.topic || '').toString();\n  const words = topic.toLowerCase().split(/\\s+/).filter(w => w.length > 3);\n\n  keywords.primary = words.slice(0, 3);\n  keywords.secondary = words.slice(3, 8);\n  keywords.long_tail = topic ? [topic] : [];\n\n  console.warn('Keywords générés par fallback:', keywords);\n}\n\nconsole.log('STATS KEYWORDS:');\nconsole.log('- Primary:', keywords.primary?.length || 0);\nconsole.log('- Secondary:', keywords.secondary?.length || 0);\nconsole.log('- Long-tail:', keywords.long_tail?.length || 0);\n\n// =====================\n// CONSTRUCTION ALL SOURCES\n// =====================\nconst allSources = [];\n\n// 1. URLs trouvées via Web\nconst webUrls = research.search_performed?.urls_found_web || [];\nwebUrls.forEach(url => {\n  allSources.push({\n    url,\n    title: 'Source Web',\n    type: 'web'\n  });\n});\n\n// 2. Sources détaillées scrapées\nconst scrapedSources = research.search_performed?.sources_detailed || [];\nscrapedSources.forEach(source => {\n  allSources.push({\n    url: source.url,\n    title: source.title || 'Sans titre',\n    type: source.source_type || 'scraped',\n    content_preview: source.content ? source.content.substring(0, 150) : ''\n  });\n});\n\nconsole.log('Total sources générées:', allSources.length);\n\n// =====================\n// CONSTRUCTION SEARCH SYNTHESIS\n// =====================\nconst webQueries = research.search_performed?.web_queries || [];\n\nconst searchSynthesis = {\n  keywords,\n  concepts: research.concepts || { main_topics: [], subtopics: [], related_terms: [] },\n  sources_count: allSources.length,\n  research_depth: webQueries.length > 0 ? 'deep' : 'shallow'\n};\n\nreturn [\n  {\n    json: {\n      research,\n      all_sources: allSources,\n      search_synthesis: searchSynthesis,\n      urls_count: {\n        web: webUrls.length,\n        scraped: scrapedSources.length,\n        total: allSources.length\n      }\n    }\n  }\n];\n"
      },
      "id": "c3b7df0d-2693-41fe-b8c3-ec2cdea2d4ff",
      "name": "Parse Research Output Axe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4048,
        6208
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.item.json;\nconst request = body.modification_request.toLowerCase();\n\nconsole.log('=== ANALYSE DU SCOPE ===');\nconsole.log('Requête:', body.modification_request);\n\n// Détection du scope\nlet scope = 'full'; // Par défaut : modification complète\nlet targetSection = null;\n\n// Mots-clés pour le titre principal uniquement\nconst titleOnlyKeywords = [\n  'titre principal',\n  'titre de l\\'article',\n  'changer le titre',\n  'modifier le titre',\n  'renommer l\\'article',\n  'title only',\n  'just the title'\n];\n\n// Mots-clés pour une section spécifique\nconst sectionKeywords = [\n  'section',\n  'chapitre',\n  'partie',\n  'paragraphe'\n];\n\n// Détection : Titre principal uniquement\nconst isTitleOnly = titleOnlyKeywords.some(keyword => request.includes(keyword));\nif (isTitleOnly && !sectionKeywords.some(k => request.includes(k))) {\n  scope = 'title_only';\n  console.log('Scope détecté: TITRE PRINCIPAL uniquement');\n}\n\n// Détection : Section spécifique\nelse {\n  // Chercher \"section 1\", \"section 2\", etc.\n  const sectionMatch = request.match(/section\\s+(\\d+)/i) || \n                       request.match(/chapitre\\s+(\\d+)/i) ||\n                       request.match(/partie\\s+(\\d+)/i);\n  \n  if (sectionMatch) {\n    scope = 'section_specific';\n    targetSection = parseInt(sectionMatch[1]) - 1; // Index 0-based\n    console.log(`Scope détecté: SECTION ${sectionMatch[1]} (index ${targetSection})`);\n  }\n  \n  // Chercher \"section Introduction\", \"section Conclusion\", etc.\n  else {\n    const namedSectionMatch = request.match(/section\\s+[\\\"«]([^\\\"»]+)[\\\"»]/i) ||\n                             request.match(/section\\s+(\\w+)/i);\n    \n    if (namedSectionMatch) {\n      scope = 'section_named';\n      targetSection = namedSectionMatch[1];\n      console.log(`Scope détecté: SECTION nommée \"${targetSection}\"`);\n    }\n    \n    // Sinon : modification complète\n    else {\n      scope = 'full';\n      console.log('Scope détecté: MODIFICATION COMPLÈTE');\n    }\n  }\n}\n\nreturn [{\n  json: {\n    article_id: body.article_id,\n    modification_request: body.modification_request,\n    attached_files: body.attached_files || [],\n    scope: scope,\n    target_section: targetSection,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3360,
        4640
      ],
      "id": "f86a0e05-b0cc-4b81-8e25-ad6c3597e078",
      "name": "Analyze Modification Scope"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un agent de recherche expert spécialisé dans la création de contenu web optimisé pour le SEO.\n\nCONTEXTE\nSujet : {{ $json.axe }}\nLangue : {{ $json.language }}\nTon : {{ $json.tone }}\n\n{{ $json.article.attached_files && $json.article.attached_files.length > 0 ? '## LIENS FOURNIS EN ENTRÉE\\nL\\'utilisateur a fourni ces liens de départ (tu DOIS les utiliser) :\\n' + $json.article.attached_files.toJsonString() : '' }}\n\n\nWORKFLOW OBLIGATOIRE EN 4 ÉTAPES\nÉTAPE 1 : RECHERCHE WEB AVEC Search in Tavily (OBLIGATOIRE)\nOutil : Search in Tavily\n\nIMPORTANT : Tu dois EXTRAIRE les URLs des résultats de recherche.\n\nActions :\n\nEffectue 8-10 recherches Google différentes sur le sujet\n\nPour CHAQUE résultat de recherche :\n\nExtrais l'URL (champ \"link\" dans les résultats de recherche)\n\nExtrais le titre (champ \"title\")\n\nNote la description (champ \"snippet\")\n\nCompile une liste de 10-20 URLs uniques trouvées via SerpAPI\n\nFormat des résultats de recherche :\nLes résultats contiennent un tableau \"organic_results\" avec :\n\n\"link\": l'URL de la page\n\n\"title\": le titre\n\n\"snippet\": la description\n\nTu DOIS :\n\nExtraire le champ \"link\" de CHAQUE résultat\n\nCréer une liste \"urls_found_serpapi\" avec ces URLs\n\nNe pas dupliquer les URLs déjà présentes dans les liens d'entrée\n\nRésultat attendu : Liste de 10-20 URLs NOUVELLES trouvées via SerpAPI\n\nÉTAPE 2 : MERGER LES SOURCES\nCrée une liste complète des URLs à scraper :\n\nLes URLs trouvées via la recherche web (ÉTAPE 1)\n\n{{ $json.article.attached_files && $json.article.attached_files.length > 0 ? '+ Les URLs fournies en entrée : ' + JSON.stringify($json.article.attached_files) : '' }}\n\nTotal attendu : {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? ($json.article.attached_files.length + ' (fournis) + 10-20 (trouvés) = 14-24 URLs') : '10-20 URLs' }}\n\nÉTAPE 3 : SCRAPING DES SOURCES (OBLIGATOIRE)\nActions :\n\nScrappe {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'TOUS les liens (fournis + trouvés)' : 'les 8-12 meilleurs liens trouvés' }}\n\nExtrais le contenu complet :\n\nTexte principal\n\nTitres H1/H2/H3\n\nStatistiques et chiffres\n\nListes importantes\n\nRésultat : Contenu de {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'tous les liens' : '8-12 sources' }}\n\nÉTAPE 4 : ANALYSE ET SYNTHÈSE\nExtrais :\n\nConcepts clés (5-7)\n\nMots-clés SEO (primaires, secondaires, longue traîne)\n\nPoints importants (8-12)\n\nStatistiques clés\n\nAngles uniques\n\nQuestions fréquentes\n\nTOUTES LES SOURCES UTILISÉES (avec détails)\n\nFORMAT DE SORTIE JSON\nFORMAT JSON ATTENDU (STRICT)\nTu DOIS répondre UNIQUEMENT avec ce JSON exact :\n\njson\n{\n  \"search_performed\": {\n    \"SearchinTavily_queries\": [\"requête 1\", \"requête 2\", ...],\n    \"urls_input\": [\"url1\", \"url2\", ...],\n    \"urls_found_web\": [\"url1\", \"url2\", ...],\n    \"urls_scraped\": [\"url1\", \"url2\", ...],\n    \"sources_detailed\": [\n      {\n        \"url\": \"https://...\",\n        \"title\": \"Titre\",\n        \"content\": \"Contenu complet...\",\n        \"relevance\": \"high/medium/low\"\n      }\n    ]\n  },\n  \"keywords\": {\n    \"primary\": [\"mot-clé principal 1\", \"mot-clé principal 2\", \"mot-clé principal 3\"],\n    \"secondary\": [\"mot-clé secondaire 1\", \"mot-clé secondaire 2\", \"mot-clé secondaire 3\", \"...\"],\n    \"long_tail\": [\"expression longue 1\", \"expression longue 2\", \"...\"]\n  },\n  \"concepts\": {\n    \"main_topics\": [\"concept 1\", \"concept 2\", \"...\"],\n    \"subtopics\": [\"sous-concept 1\", \"sous-concept 2\", \"...\"],\n    \"related_terms\": [\"terme connexe 1\", \"terme connexe 2\", \"...\"]\n  }\n}\n⚠️ RÈGLES CRITIQUES :\n\n\"keywords\" NE PEUT PAS ÊTRE VIDE\n\n\"primary\" doit contenir 3-5 mots-clés principaux\n\n\"secondary\" doit contenir 5-10 mots-clés secondaires\n\n\"long_tail\" doit contenir 5-10 expressions longue traîne\n\nTous les keywords doivent être en {{ $json.article.parameters?.language === 'EN' ? 'anglais' : 'français' }}\n\n⚠️ CRITIQUE : \"urls_found_web\" NE PEUT PAS ÊTRE VIDE\n⚠️ Il doit contenir 10-20 URLs extraites des résultats SerpAPI\n⚠️ Format : [\"https://...\", \"https://...\", ...]\n\nÉTAPE 5 : EXTRACTION DES MOTS-CLÉS SEO (OBLIGATOIRE)\nTu DOIS analyser tous les contenus scrapés et extraire :\n\nA. MOTS-CLÉS PRINCIPAUX (Primary)\n3-5 mots-clés à TRÈS FORT volume de recherche\n\nGénériques et stratégiques\n\nExemples : \"médecine chinoise\", \"acupuncture\", \"qi gong\"\n\nB. MOTS-CLÉS SECONDAIRES (Secondary)\n5-10 mots-clés à volume moyen\n\nPlus spécifiques que les primary\n\nExemples : \"théorie du yin yang\", \"méridiens énergétiques\", \"ventouses chinoises\"\n\nC. LONGUE TRAÎNE (Long-tail)\n5-10 expressions de 3+ mots\n\nTrès spécifiques, faible concurrence\n\nExemples : \"comment fonctionne la médecine chinoise\", \"bienfaits de l'acupuncture pour le stress\"\n\nMÉTHODE D'EXTRACTION :\n\nIdentifie les termes qui reviennent le plus dans les sources\n\nRepère les titres et sous-titres des articles scrapés\n\nExtrais les questions fréquentes (FAQ)\n\nListe les termes techniques importants\n\n⚠️ SI \"keywords\" EST VIDE DANS TON JSON, TU AS ÉCHOUÉ.\n\nRÈGLES CRITIQUES\n⚠️ TOUJOURS UTILISER la recherche web même si des liens sont fournis\n⚠️ SCRAPPER TOUT : liens fournis + liens trouvés\n⚠️ LISTER TOUTES LES SOURCES dans le JSON final avec \"source_type\"\n⚠️ Le champ \"urls_scraped\" doit contenir {{ $json.article.attached_files && $json.article.attached_files.length > 0 ? 'TOUS les liens (fournis + trouvés)' : 'tous les liens trouvés' }}\n\nSi tu ne retournes pas TOUTES les sources avec leur type (input/recherche web), ta réponse est INVALIDE.",
        "options": {
          "systemMessage": "=Tu es un agent de recherche expert.\n\nRÈGLE ABSOLUE N°1 : TU DOIS TOUJOURS UTILISER SERPAPI EN PREMIER.\n\nWORKFLOW OBLIGATOIRE :\n1️⃣ Outil de recherche web → Faire 5-10 recherches Google\n2️⃣ Extraire les URLs → Récupérer le champ \"link\" de CHAQUE résultat\n3️⃣ Scraper les pages → Scraper ces URLs\n4️⃣ Synthétiser → Créer le JSON final\n\nEXTRACTION DES URLS :\nQuand tu reçois les résultats de recherche, ils contiennent \"organic_results\" :\n\njson\n[\n  { \"link\": \"https://...\", \"title\": \"...\", \"snippet\": \"...\" },\n  { \"link\": \"https://...\", \"title\": \"...\", \"snippet\": \"...\" }\n]\nTU DOIS extraire CHAQUE \"link\" et les mettre dans \"urls_found_serpapi\".\n\nEXEMPLE :\nSi tu trouves 3 résultats, \"urls_found_serpapi\" DOIT contenir 3 URLs minimum.\n\nSi \"urls_found_serpapi\" est vide dans ton JSON final, TU AS ÉCHOUÉ.\n\nEXEMPLE CONCRET D'EXTRACTION DES RÉSULTATS\nCe que tu reçois de l’outil de recherche web :\n\njson\n{\n  \"organic_results\": [\n    {\n      \"position\": 1,\n      \"title\": \"Médecine Traditionnelle Chinoise - Wikipedia\",\n      \"link\": \"https://fr.wikipedia.org/wiki/M%C3%A9decine_traditionnelle_chinoise\",\n      \"snippet\": \"La médecine traditionnelle chinoise...\"\n    },\n    {\n      \"position\": 2,\n      \"title\": \"MTC : principes et bienfaits\",\n      \"link\": \"https://www.passeportsante.net/fr/Therapies/Guide/Fiche.aspx?doc=medecine_traditionnelle_chinoise\",\n      \"snippet\": \"Les grands principes...\"\n    }\n  ]\n}\nCe que tu DOIS extraire :\n\njson\n\"urls_found_web\": [\n  \"https://fr.wikipedia.org/wiki/M%C3%A9decine_traditionnelle_chinoise\",\n  \"https://www.passeportsante.net/fr/Therapies/Guide/Fiche.aspx?doc=medecine_traditionnelle_chinoise\"\n]\nCRITIQUE : Tu DOIS extraire le champ \"link\" de CHAQUE résultat.",
          "maxIterations": 10,
          "returnIntermediateSteps": true,
          "passthroughBinaryImages": true
        }
      },
      "id": "049f162d-db8f-4bd6-ad72-b095b9a838d7",
      "name": "AI Agent Recherche Axe",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3728,
        6208
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un planificateur de contenu expert.\n\nMISSION\nCrée une Table des Matières (TOC) structurée et détaillée pour l'article suivant, organisée clairement en :\n\nIntroduction\n\nPartie 1, Partie 2, Partie 3, etc. (chacune avec un titre et des sous-sections)\n\nConclusion (facultative mais recommandée)\n\nCONTEXTE\nSujet : {{ $('Webhook modifier Axe').item.json.body.axe }}\nLangue : {{ $('Webhook modifier Axe').item.json.body.language }}\nTone : {{ $('Webhook modifier Axe').item.json.body.tone }}\nLongueur cible : {{ $('Webhook modifier Axe').item.json.body.word_count }}mots\n\nRECHERCHE EFFECTUÉE\n{{ JSON.stringify($json.research, null, 2) }}\n\nFORMAT ATTENDU\nGénère un JSON avec cette structure EXACTE :\n\njson\n{\n  \"plan_options\": {\n    \"axes\": [\n      \"Axe 1: Description\",\n      \"Axe 2: Description\",\n      \"Axe 3: Description\",\n      \"Axe 4: Description\"\n    ],\n    \"titles\": [\n      \"Titre 1\",\n      \"Titre 2\",\n      \"Titre 3\",\n      \"Titre 4\"\n    ]\n  },\n  \"toc\": {\n    \"title\": \"Titre principal par défaut\",\n    \"sections\": [\n      {\n        \"id\": \"section_1\",\n        \"title\": \"Introduction\",\n        \"resume\": \"...\"\n      },\n      {\n        \"id\": \"section_2\",\n        \"title\": \"Partie 1 : Titre de la première grande idée\",\n        \"subsections\": [\n          { \"id\": \"section_2_1\", \"title\": \"Sous-section 1 de la Partie 1\" },\n          { \"id\": \"section_2_2\", \"title\": \"Sous-section 2 de la Partie 1\" }\n        ]\n      },\n      {\n        \"id\": \"section_3\",\n        \"title\": \"Partie 2 : Titre de la deuxième grande idée\",\n        \"subsections\": [\n          { \"id\": \"section_3_1\", \"title\": \"Sous-section 1 de la Partie 2\" },\n          { \"id\": \"section_3_2\", \"title\": \"Sous-section 2 de la Partie 2\" }\n        ]\n      },\n      {\n        \"id\": \"section_4\",\n        \"title\": \"Partie 3 : Titre de la troisième grande idée\",\n        \"subsections\": [\n          { \"id\": \"section_4_1\", \"title\": \"Sous-section 1 de la Partie 3\" },\n          { \"id\": \"section_4_2\", \"title\": \"Sous-section 2 de la Partie 3\" }\n        ]\n      },\n      {\n        \"id\": \"section_5\",\n        \"title\": \"Conclusion\",\n        \"resume\": \"...\"\n      }\n    ]\n  }\n}\n\nRÈGLES IMPORTANTES\nIntroduction : doit toujours être la première section (id: \"section_1\", titre \"Introduction\" ou équivalent).\n\nParties : au minimum 2 à 3 grandes parties (section_2, section_3, section_4…), chacune avec 2 à 4 sous-sections cohérentes.\n\nConclusion : idéalement la dernière section (par ex. section_5 ou section_6) avec titre explicite (\"Conclusion\", \"Pour aller plus loin\", etc.).\n\nLes id doivent rester cohérents :\n\nsection_X pour les sections,\n\nsection_X_Y pour les sous-sections.\n\nLes 4 axes dans plan_options.axes doivent représenter des orientations thématiques différentes possibles pour l’article.\n\nplan_options.titles propose 4 titres d’article possibles, cohérents avec les axes.\n\nL’agent doit impérativement retourner la liste complète des sources (liens) qui lui ont servi pour construire le plan dans le champ \"sources\" (tableau de strings).",
        "options": {
          "systemMessage": "Tu es expert en structuration de contenu. Tu crées des plans d'articles clairs et logiques.\n\nBest practices rédactionnelles – Articles éditoriaux\n1. L’introduction : poser clairement le sujet dès les premières lignes\nRègle essentielle :\n Dès l’introduction, le lecteur doit comprendre de quoi parle l’article et ce qu’il va y trouver.\nÀ respecter :\nUne introduction courte, claire et qualitative.\n\n\nLe sujet principal doit être explicitement annoncé.\n\n\nL’angle de traitement doit être identifiable (lecture MTC, énergétique, culturelle, etc.).\n\n\nÉviter toute entrée trop vague, trop large ou trop abstraite.\n\n\nL’objectif n’est pas seulement de capter l’attention, mais de donner une direction précise et de rassurer le lecteur sur la pertinence du contenu.\n\n2. Un corps d’article structuré et maîtrisé\nLe corps de l’article doit être organisé de façon lisible et logique.\nPrincipes de structure :\nLe contenu doit être découpé en 1 à 3 grandes parties maximum.\n\n\nChaque partie correspond à un axe clair en lien direct avec le sujet.\n\n\nLa structure doit être pensée avant l’écriture, pas improvisée.\n\n\nUne structure simple et lisible est toujours préférable à une multiplication de sous-parties peu cohérentes.\n\n3. Chaque partie doit répondre au sujet posé\nChaque section du corps de l’article doit apporter une réponse concrète au thème annoncé dans l’introduction.\nÀ vérifier systématiquement :\nChaque partie a un objectif clair.\n\n\nChaque développement apporte un éclairage nouveau.\n\n\nAucun paragraphe n’est hors sujet ou redondant.\n\n\nSi un passage n’aide pas à mieux comprendre le sujet, il doit être supprimé ou retravaillé.\n\n4. Des transitions fluides et naturelles\nLes transitions sont essentielles pour assurer une lecture fluide.\nBonnes pratiques :\nRelier les idées de manière naturelle.\n\n\nAssurer une continuité logique entre les parties.\n\n\nÉviter les ruptures abruptes ou les enchaînements artificiels.\n\n\nLe lecteur doit avoir le sentiment d’un raisonnement qui avance, sans à-coups.\n\n5. Respect strict du sujet annoncé\nMême dans un article exploratoire ou prospectif, le contenu doit rester aligné avec le sujet initial.\nRègle clé :\nTout ce qui est écrit doit servir la promesse faite en introduction.\nLes digressions, même intéressantes, doivent être évitées si elles ne renforcent pas le propos principal.\n\n6. Une conclusion qui synthétise et ouvre\nLa conclusion doit :\nRécapituler brièvement les points essentiels.\n\n\nDonner une vision d’ensemble du sujet traité.\n\n\nOuvrir vers une réflexion, une perspective ou un approfondissement.\n\n\nElle ne doit pas introduire de nouvelles idées majeures, mais aider le lecteur à repartir avec une compréhension claire.\n\n7. Ton et posture éditoriale\nTon clair, structuré et accessible.\n\n\nApproche pédagogique, sans jargon inutile.\n\n\nRigueur dans les propos, sans excès de technicité.\n\n\nStyle fluide, naturel, jamais confus ou approximatif.\n\n\nL’objectif est de transmettre une lecture intelligible et cohérente, pas d’impressionner par la complexité.\n\nEn résumé\nUn bon article éditorial :\nannonce clairement son sujet dès l’introduction,\n\n\nsuit une structure simple et logique,\n\n\nrépond réellement au thème annoncé,\n\n\nprogresse de manière fluide,\n\n\nrespecte le temps et l’attention du lecteur.\n\n"
        }
      },
      "id": "c3c57e8a-512f-4077-9841-34020f73c85e",
      "name": "AI Agent Planificateur Axe",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        4480,
        6208
      ],
      "alwaysOutputData": true,
      "retryOnFail": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\n// Vérification SOUPLE : log les warnings mais ne bloque pas\nlet hasWarnings = false;\n\nconst searchPerformed = input.research?.search_performed || {};\n\n// Check 1 : Requêtes web\nconst webQueries = searchPerformed.web_queries || [];\nif (webQueries.length === 0) {\n  console.warn('WARNING : Aucune requête de recherche web effectuée');\n  hasWarnings = true;\n} else {\n  console.log('Requêtes web effectuées :', webQueries.length);\n}\n\n// Check 2 : URLs web extraites\nconst webUrls = searchPerformed.urls_found_web || [];\nif (webUrls.length === 0) {\n  console.warn('WARNING : Aucune URL extraite depuis la recherche web');\n  hasWarnings = true;\n} else {\n  console.log('URLs issues de la recherche web :', webUrls.length);\n}\n\n// Check 3 : Sources finales\nif (!input.all_sources || input.all_sources.length === 0) {\n  console.error('ERREUR CRITIQUE : Aucune source trouvée');\n  hasWarnings = true;\n} else {\n  console.log('Sources totales (all_sources) :', input.all_sources.length);\n}\n\n// Stats finales\nconsole.log('STATS RECHERCHE:');\nconsole.log('- Input URLs :', searchPerformed.urls_input?.length || 0);\nconsole.log('- URLs trouvées via web :', webUrls.length);\nconsole.log('- Total scrappé :', searchPerformed.urls_scraped?.length || 0);\nconsole.log('- Sources détaillées (all_sources) :', input.all_sources?.length || 0);\n\nif (hasWarnings) {\n  console.warn('Le workflow continue malgré les warnings');\n}\n\n// On passe toujours, même avec des warnings\nreturn [{\n  json: input\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4256,
        6208
      ],
      "id": "c065ac79-0de1-4f2a-98fa-c27b83264037",
      "name": "Verification Axe"
    },
    {
      "parameters": {
        "jsCode": "// 1. Récupération de la sortie brute de l'agent planificateur\nconst current = $input.item.json;\nconst data = Array.isArray(current) ? current[0] : current;\nconst output = data.output || JSON.stringify(data);\n\nlet rawJson;\n\ntry {\n  if (typeof output === 'object') {\n    // Cas (rare) où l'agent renvoie déjà un objet\n    rawJson = output;\n  } else {\n    // Cas standard : string avec ```json ... ```\n    const fencedMatch = output.match(/```json\\s*([\\s\\S]*?)\\s*```/i);\n    const jsonString = fencedMatch ? fencedMatch[1] : output;\n\n    const objectMatch = jsonString.match(/\\{[\\s\\S]*\\}/);\n    const clean = objectMatch ? objectMatch[0] : jsonString;\n\n    rawJson = JSON.parse(clean.trim());\n  }\n} catch (e) {\n  console.error('Erreur parse TOC JSON:', e.message);\n  rawJson = {\n    toc: { title: 'Sans titre', sections: [] },\n    plan_options: null,\n    sources: []\n  };\n}\n\n// 2. Récupérer article_id\nlet articleId = 'unknown';\ntry {\n  articleId = $('Parse Webhook Axe').first().json.article_id;\n} catch (e) {\n  console.error('Cannot get article_id');\n}\n\n// 3. Récupérer les infos de recherche depuis le node précédent\n//    IMPORTANT : adapte le nom du node si différent\nconst researchNode = $('Parse Research Output Axe').first().json || {};\n\nconst allSources = researchNode.all_sources || [];\nconst searchSynthesis = researchNode.search_synthesis || {\n  keywords: { primary: [], secondary: [], long_tail: [] },\n  concepts: { main_topics: [], subtopics: [], related_terms: [] }\n};\n\nconsole.log('Sources disponibles (all_sources):', allSources.length);\nconsole.log('Keywords disponibles:', searchSynthesis.keywords?.primary?.length || 0);\n\n// 4. Construction de la sortie\nreturn [{\n  json: {\n    toc: rawJson.toc || { title: 'Sans titre', sections: [] },\n    plan_options: rawJson.plan_options || null,\n    sources: rawJson.sources || [],\n    all_sources: allSources,\n    search_synthesis: {\n      // === PARTIE RECHERCHE SEO (nouveau modèle) ===\n      keywords: searchSynthesis.keywords || {\n        primary: [],\n        secondary: [],\n        long_tail: [],\n      },\n      concepts: searchSynthesis.concepts || {\n        main_topics: [],\n        subtopics: [],\n        related_terms: [],\n      },\n      sources_count: allSources.length,\n      research_depth: searchSynthesis.research_depth || (webQueries?.length > 0 ? 'deep' : 'shallow'),\n\n      // === POUR COMPATIBILITÉ AVEC L’ANCIEN MODÈLE ===\n      toc: rawJson.toc || { title: 'Sans titre', sections: [] },\n      sources_detailed: allSources, // équivalent de ton ancien tableau \"sources\" enrichi\n    },\n    article_id: articleId,\n  },\n}];\n\n"
      },
      "id": "599768d6-fdb6-4ba6-bbb5-eb80c429a811",
      "name": "Parse TOC Axe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4832,
        6208
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "articles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.article_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "table_of_contents",
              "fieldValue": "={{ $json.toc }}"
            },
            {
              "fieldId": "plan_options",
              "fieldValue": "={{ $json.plan_options }}"
            },
            {
              "fieldId": "sources",
              "fieldValue": "={{ $json.all_sources }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "waiting_validation"
            },
            {
              "fieldId": "search_synthesis",
              "fieldValue": "={{ $json.search_synthesis }}"
            }
          ]
        }
      },
      "id": "bb8b4d82-7f6b-4c5f-b793-d4466d196218",
      "name": "Update Supabase TOC Axe",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        5136,
        6208
      ],
      "credentials": {
        "supabaseApi": {
          "id": "ggu5YF4JUNS4wHgg",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nreturn [{\n  json: {\n    article_id: input.id,\n    status: input.status,\n    table_of_contents: input.table_of_contents,\n    message: 'Article en attente de validation du sommaire'\n  },\n  pairedItem: 0\n}];"
      },
      "id": "ee06334a-8d24-4978-a6ee-77637c3725f9",
      "name": "PAUSE - Waiting Validation Axe",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5488,
        6208
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\nconst markdown = input.translated_content || '';\n\nconsole.log('=== CONVERSION MARKDOWN → HTML ===');\nconsole.log('Article ID:', input.article_id);\nconsole.log('Markdown length:', markdown.length);\n\n// Fonction de conversion\nfunction markdownToHtml(md) {\n  let html = md;\n  \n  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');\n  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');\n  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');\n  html = html.replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>');\n  html = html.replace(/\\*(.+?)\\*/g, '<em>$1</em>');\n  html = html.replace(/^[\\-\\*]\\s+(.+)$/gm, '<li>$1</li>');\n  html = html.replace(/(<li>.*<\\/li>\\n?)+/g, (m) => '<ul>' + m + '</ul>');\n  html = html.replace(/^---$/gm, '<hr>');\n  html = html.replace(/\\n\\n/g, '</p><p>');\n  html = html.replace(/\\n/g, '<br>');\n  html = '<p>' + html + '</p>';\n  \n  // Nettoyage\n  html = html.replace(/<p>(<h[1-3]>.*?<\\/h[1-3]>)<\\/p>/g, '$1');\n  html = html.replace(/<p>(<ul>.*?<\\/ul>)<\\/p>/g, '$1');\n  html = html.replace(/<p>(<hr>)<\\/p>/g, '$1');\n  html = html.replace(/<p><\\/p>/g, '');\n  \n  return html;\n}\n\nconst bodyContent = markdownToHtml(markdown);\n\nconst htmlDocument = `<!DOCTYPE html>\n<html lang=\"fr\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <style>\n    body {\n      font-family: 'Georgia', serif;\n      line-height: 1.8;\n      padding: 40px;\n      max-width: 900px;\n      margin: 0 auto;\n      color: #2c3e50;\n    }\n    h1 { font-size: 32px; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px; }\n    h2 { font-size: 24px; margin: 25px 0 15px; }\n    h3 { font-size: 18px; margin: 20px 0 10px; }\n    p { margin-bottom: 15px; text-align: justify; }\n    ul { margin: 15px 0; padding-left: 30px; }\n    li { margin-bottom: 8px; }\n    strong { font-weight: bold; }\n    em { font-style: italic; }\n    hr { border: 0; border-top: 2px solid #ecf0f1; margin: 30px 0; }\n  </style>\n</head>\n<body>\n  ${bodyContent}\n</body>\n</html>`;\n\nconsole.log('✅ HTML généré');\nconsole.log('Document length:', htmlDocument.length);\n\nreturn [{\n  json: {\n    translated_content: markdown,\n    docContent: htmlDocument,\n    article_id: input.article_id,\n    translated_topic: input.translated_topic,\n    translated_toc: input.translated_toc,\n    translated_plan_options: input.translated_plan_options,\n    translated_search_synthesis: input.translated_search_synthesis,\n    translated_evaluation_details: input.translated_evaluation_details,\n    parameters: input.parameters,\n    score: input.score,\n    drive_link: input.drive_link,\n    new_language: input.new_language\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5024,
        7632
      ],
      "id": "8b967bb8-9a62-411e-8cf6-3e433ffcf0b0",
      "name": "Transformer Markdown - HTML"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {
          "includeUnpaired": true
        }
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4496,
        7328
      ],
      "id": "15fdf4be-56f1-428f-8015-0dabf1d9549f",
      "name": "Merge"
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Utilise cette outil pour consulter le magasin d'article déjà rédigé et t'en inspirer sur la forme et le fond.",
        "pineconeIndex": {
          "__rl": true,
          "value": "content-factory",
          "mode": "list",
          "cachedResultName": "content-factory"
        },
        "topK": 10,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1.3,
      "position": [
        3776,
        3648
      ],
      "id": "78f5fa18-caa8-4c8d-8265-023e4b216268",
      "name": "Pinecone Vector Store",
      "credentials": {
        "pineconeApi": {
          "id": "EIg8sqwXH2dtPVCD",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/embedding-001"
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        3792,
        3872
      ],
      "id": "758ece31-9d44-44ca-9a90-777400336f5a",
      "name": "Embeddings Google Gemini",
      "credentials": {
        "googlePalmApi": {
          "id": "l6LzqmUVQJAC6E6r",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "connections": {
    "Set Translating Status": {
      "main": [
        [
          {
            "node": "Read Article Translate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Traduction": {
      "main": [
        [
          {
            "node": "AI Translator",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Simple Memory6": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Modifier Article",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory5": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Modifier Plan",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Parse Translated Content": {
      "main": [
        [
          {
            "node": "Transformer Markdown - HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Translate": {
      "ai_languageModel": [
        [
          {
            "node": "AI Translator",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Translator": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Article Translate": {
      "main": [
        [
          {
            "node": "Preparer Traduction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Translate Request": {
      "main": [
        [
          {
            "node": "Response Translate",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set Translating Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Translate": {
      "main": [
        [
          {
            "node": "Parse Translate Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Modified Content": {
      "main": [
        [
          {
            "node": "Response Modify Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse New Content": {
      "main": [
        [
          {
            "node": "Formatage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Modify Article": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Modifier Article",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Modifier Article": {
      "main": [
        [
          {
            "node": "Parse New Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Article Modify Content": {
      "main": [
        [
          {
            "node": "Preparer Modification Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Modify Article": {
      "main": [
        [
          {
            "node": "Read Article Modify Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Modify Article": {
      "main": [
        [
          {
            "node": "Parse Modify Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Modified TOC": {
      "main": [
        [
          {
            "node": "Response Modify Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse New TOC": {
      "main": [
        [
          {
            "node": "Update Modified TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Modify Plan": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Modifier Plan",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Modifier Plan": {
      "main": [
        [
          {
            "node": "Parse New TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Article Modify": {
      "main": [
        [
          {
            "node": "Preparer Modification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Modify Plan": {
      "main": [
        [
          {
            "node": "Analyze Modification Scope",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Modify Plan": {
      "main": [
        [
          {
            "node": "Parse Modify Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verification": {
      "main": [
        [
          {
            "node": "AI Agent Planificateur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Supabase": {
      "main": [
        [
          {
            "node": "Parse Article Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Google Drive": {
      "main": [
        [
          {
            "node": "Preparer Update Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Évaluateur": {
      "main": [
        [
          {
            "node": "Debug Evaluation Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Préparer pour upload": {
      "main": [
        [
          {
            "node": "Upload Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Google Doc": {
      "main": [
        [
          {
            "node": "Convertir Markdown → HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalisation Prep": {
      "main": [
        [
          {
            "node": "Preparer Format Google Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Retry (Loop)": {
      "main": [
        [
          {
            "node": "AI Agent Rédaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Retry Loop": {
      "main": [
        [
          {
            "node": "Increment Retry (Loop)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Finalisation Prep",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Evaluation": {
      "main": [
        [
          {
            "node": "Check Retry Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Supabase Final": {
      "main": [
        [
          {
            "node": "Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convertir Markdown → HTML": {
      "main": [
        [
          {
            "node": "Préparer pour upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Optimized Article": {
      "main": [
        [
          {
            "node": "Preparer Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Optimisation": {
      "main": [
        [
          {
            "node": "Parse Optimized Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Rédaction": {
      "main": [
        [
          {
            "node": "Parse Generated Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Validated TOC": {
      "main": [
        [
          {
            "node": "Preparer Redaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory4": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Évaluateur",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory3": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Optimisation",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Rédaction",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Planificateur",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Planificateur",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Planificateur": {
      "main": [
        [
          {
            "node": "Parse TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Recherche": {
      "main": [
        [
          {
            "node": "Parse Research Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Évaluateur",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Optimisation",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Rédaction",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse Validation": {
      "main": [
        [
          {
            "node": "Read Supabase Validated",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Validate TOC": {
      "main": [
        [
          {
            "node": "Parse Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse TOC": {
      "main": [
        [
          {
            "node": "Update Supabase TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Research Output": {
      "main": [
        [
          {
            "node": "Verification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Article Data": {
      "main": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook": {
      "main": [
        [
          {
            "node": "Read Supabase",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response 202",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Start": {
      "main": [
        [
          {
            "node": "Parse Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Modification": {
      "main": [
        [
          {
            "node": "AI Agent Modifier Plan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Modification Article": {
      "main": [
        [
          {
            "node": "AI Agent Modifier Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Supabase TOC": {
      "main": [
        [
          {
            "node": "PAUSE - Waiting Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Redaction": {
      "main": [
        [
          {
            "node": "AI Agent Rédaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Supabase Validated": {
      "main": [
        [
          {
            "node": "Merge Validated TOC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Generated Article": {
      "main": [
        [
          {
            "node": "Preparer Optimisation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Optimisation": {
      "main": [
        [
          {
            "node": "AI Agent Optimisation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Evaluation": {
      "main": [
        [
          {
            "node": "AI Agent Évaluateur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Format Google Doc": {
      "main": [
        [
          {
            "node": "Format Google Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparer Update Final": {
      "main": [
        [
          {
            "node": "Update Supabase Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Evaluation Output": {
      "main": [
        [
          {
            "node": "Parse Evaluation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatage": {
      "main": [
        [
          {
            "node": "Debug",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug": {
      "main": [
        [
          {
            "node": "Update Modified Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search in Tavily": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Recherche",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Webhook modifier Axe": {
      "main": [
        [
          {
            "node": "Parse Webhook Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Supabase1": {
      "main": [
        [
          {
            "node": "Parse Article Data Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory8": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Planificateur Axe",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Planificateur Axe",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent Recherche Axe",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory9": {
      "ai_memory": [
        [
          {
            "node": "AI Agent Recherche Axe",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Search in Tavily1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Recherche Axe",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook Axe": {
      "main": [
        [
          {
            "node": "Read Supabase1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Article Data Axe": {
      "main": [
        [
          {
            "node": "AI Agent Recherche Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Research Output Axe": {
      "main": [
        [
          {
            "node": "Verification Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Modification Scope": {
      "main": [
        [
          {
            "node": "Read Article Modify",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Recherche Axe": {
      "main": [
        [
          {
            "node": "Parse Research Output Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent Planificateur Axe": {
      "main": [
        [
          {
            "node": "Parse TOC Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verification Axe": {
      "main": [
        [
          {
            "node": "AI Agent Planificateur Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse TOC Axe": {
      "main": [
        [
          {
            "node": "Update Supabase TOC Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Supabase TOC Axe": {
      "main": [
        [
          {
            "node": "PAUSE - Waiting Validation Axe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transformer Markdown - HTML": {
      "main": [
        [
          {
            "node": "Update Translated Article",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Parse Translated Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone Vector Store": {
      "ai_tool": [
        [
          {
            "node": "AI Agent Rédaction",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Google Gemini": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "eab9e034ae578d74489f9a29edd660420fbb68083fc45d20ad18f03395f81905"
  }
}